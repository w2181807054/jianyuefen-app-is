
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>喷墨机</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/kGYP6CQw/6.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* --- 全局与主题样式 --- */
        :root {
            --primary-color: #ff80ab;
            --secondary-color: #f48fb1;
            --bg-color: rgba(255, 128, 171, 0.05);
            --top-pinned-bg: rgba(255, 128, 171, 0.1);
            --accent-color: #90caf9;
            --text-color: #444;
            --text-secondary: #6D6D6D;
            --white-color: #fff;
            --border-radius: 18px; 
            --phone-corner-radius: 0px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --online-status-color: #4CAF50;
            --nav-footer-bg: #f7f7f7;
            --nav-icon-color: #888;
            --nav-icon-active-color: var(--primary-color);
            
            /* CSS变量用于聊天气泡主题 */
            --sent-bg-color: rgba(255,204,204,0.9);
            --sent-text-color: #A56767;
            --received-bg-color: rgba(255,255,255,0.9);
            --received-text-color: #6D6D6D;
        }
        
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: var(--font-family); margin: 0; padding: 0;
            background: linear-gradient(135deg, var(--bg-color), var(--secondary-color));
            display: flex; align-items: center; justify-content: center; min-height: 100vh;
        }

        .phone-screen {
            width: 100%; max-width: 420px; height: 100vh; max-height: 850px;
            background-color: var(--white-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--phone-corner-radius);
            overflow: hidden; position: relative;
            display: flex; flex-direction: column;
        }
        
        .screen {
         display: flex;
         flex-direction: column;
         width: 100%;
         height: 100%;
         position: absolute;
          top: 0;
         left: 0;
         opacity: 0;
         visibility: hidden;
         transform: scale(0.95);
         transition: opacity 0.4s ease, visibility 0.4s, transform 0.4s ease;
         z-index: 1;
        }
        .screen.active {
          opacity: 1;
         visibility: visible;
         transform: scale(1);
         z-index: 2;
        }


        @keyframes click-effect {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .app-icon, .list-item, .btn, .qq-nav-btn, .plus-menu-item, .action-sheet-button, .sticker-item {
            transition: transform 0.1s ease-out, background-color 0.2s;
        }
        .app-icon:active, .list-item:active, .btn:active, .qq-nav-btn:active, .plus-menu-item:active, .action-sheet-button:active, .sticker-item:active {
            animation: click-effect 0.2s ease-in-out;
        }


        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px); border-bottom: 1px solid #eee;
            flex-shrink: 0; position: relative; z-index: 10;
        }
        .app-header .back-btn, .app-header .action-btn {
            background: none; border: none; font-size: 24px; font-weight: bold;
            color: var(--text-color); cursor: pointer; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
        }
        #cancel-multi-select-btn {
            font-size: 14px !important;                 
            font-weight: 500 !important;                
            color: var(--white-color) !important;       
            background-color: var(--primary-color) !important; 
            border-radius: 10px !important;             
            padding: 5px 10px !important;               
            width: auto !important;                     
            height: auto !important;                    
        }
        .app-header .action-btn-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .app-header .action-btn-group .action-btn {
            font-size: 16px;
            font-weight: 600;
            width: auto;
            padding: 6px 12px;
            border-radius: 10px;
            color: var(--text-color);
        }
        #qq-action-create-group img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }
        #qq-action-add-friend {
            font-weight: 500;
        }
        .app-header .action-btn-group #create-group-btn {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
         .app-header .action-btn-group #add-chat-btn {
            font-size: 28px;
            padding: 0;
            width: 40px;
            height: 40px;
            background-color: transparent;
            color: var(--text-color);
            border-radius: 50%;
        }

        .app-header .action-btn svg { width: 24px; height: 24px; fill: var(--text-color); }
        .app-header .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .app-header .title { font-size: 18px; font-weight: 600; color: var(--text-color); margin: 0; }
        .app-header .subtitle { 
            font-size: 12px; color: #888; display: flex; align-items: center; 
            margin-top: 2px;
        }
        .online-indicator {
            width: 8px; height: 8px; border-radius: 50%;
            background-color: var(--online-status-color);
            margin-right: 5px;
        }
        .app-header .placeholder { width: 40px; }
        
        #home-screen { justify-content: space-between; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; padding: 50px 0; }
        .time-widget { text-align: center; padding: 0 20px; color: var(--text-color); }
        .time-widget .time { font-size: 72px; font-weight: 600; }
        .time-widget .date { font-size: 18px; color: #666; }
        
        .home-layout {
            display: flex;
            padding: 20px 40px;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            flex-grow: 1;
        }
        .home-layout-left {
            flex-shrink: 0;
            margin-right: 10px;
        }
        .home-layout-right {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }
        .app-icon-large .icon-img {
            width: 130px;
            height: 130px;
            border-radius: 28px;
        }
        .app-icon-large .app-name {
            font-size: 14px;
        }

        #home-screen.day-mode .time-widget,
        #home-screen.day-mode .time-widget .date,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        
        .dock { display: flex; justify-content: center; align-items: center; padding: 10px; background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: var(--border-radius); margin: 0 20px; min-height: 80px; gap: 25px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; text-decoration: none; }
        .icon-img { width: 60px; height: 60px; border-radius: 15px; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; object-fit: cover; }
        .app-icon:hover .icon-img { transform: translateY(-5px); }
        .app-icon .app-name { font-size: 12px; color: var(--text-color); font-weight: 500; }

        .content { flex-grow: 1; overflow-y: auto; padding: 20px; position: relative; }
        .placeholder-text { text-align: center; color: #aaa; margin-top: 50px; }
        
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; display: none; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        .modal-overlay.visible { display: flex; }
        .modal-window { background: var(--white-color); padding: 25px; border-radius: var(--border-radius); box-shadow: 0 5px 25px rgba(0,0,0,0.15); width: 85%; max-width: 340px; animation: slideUp 0.4s ease-out; }
        .modal-window h3 { margin-top: 0; text-align: center; color: var(--primary-color); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        #add-char-modal, #add-me-modal, #assign-char-modal, #assign-me-modal, 
        #persona-edit-modal, #edit-group-member-modal, #create-member-for-group-modal,
        #world-book-selection-modal, #invite-member-modal, #theme-selection-modal, 
        #custom-theme-modal, #pat-pat-modal, #send-location-modal {
            z-index: 102; 
        }

        #edit-group-member-modal .avatar-preview,
        #create-member-for-group-modal .avatar-preview {
            width: 80px;
            height: 80px;
        }

        .context-menu { 
            position: fixed; 
            z-index: 1000; 
            background: #333; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.25); 
            overflow: hidden; 
            display: flex;
            animation: fadeIn 0.1s ease; 
        }
        .context-menu-item { 
            padding: 10px 15px; 
            cursor: pointer; 
            color: white;
            font-size: 14px;
            border-right: 1px solid #555;
            transition: background-color 0.2s;
        }
        .context-menu-item:last-child {
            border-right: none;
        }
        .context-menu-item:hover { background-color: #4f4f4f; }
        .context-menu-item.danger { color: #ff8a80; }

        .action-sheet-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); z-index: 200; 
            display: none; align-items: flex-end; 
            animation: fadeIn 0.3s ease;
        }
        .action-sheet-overlay.visible { display: flex; }
        .action-sheet {
            background: #f7f7f7; width: 100%; 
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }
        .action-sheet-button {
            width: 100%; background: white; border: none; padding: 15px; 
            font-size: 16px; color: var(--primary-color); font-weight: 500;
            cursor: pointer; border-radius: 10px; margin-bottom: 8px;
        }
        .action-sheet-button.danger { color: #e53935; }
        .action-sheet-button:last-child { margin-bottom: 0; }

        #world-book-screen .content, #memory-core-screen .content { padding: 10px 0 0 0; }
        .list-container { list-style: none; margin: 0; padding: 0; }
        .list-item { display: flex; align-items: center; padding: 10px 20px; cursor: pointer; transition: background-color 0.2s ease; position: relative; }

        #chat-list-container .list-item:not(:last-child), 
        #contacts-list-container .list-item:not(:last-child) {
             border-bottom: 1px solid #f0f0f0;
        }
        #discover-tab-content .list-container .list-item {
             border-bottom: 1px solid #f0f0f0;
        }
         #discover-tab-content .list-container .list-item:first-child {
            margin-top: 0 !important;
            border-top: 1px solid #f0f0f0;
        }

        .list-item:hover { background-color: var(--bg-color); }
        .chat-item.pinned { background-color: var(--top-pinned-bg); }
        .avatar-wrapper { position: relative; flex-shrink: 0; }
        .unread-badge {
            position: absolute;
            top: 0;
            right: 12px;
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            border: 2px solid white;
            z-index: 2;
        }
        .chat-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; flex-shrink: 0; background-color: #eee; }
        .group-avatar { border-radius: 10px; }
        .item-details { flex-grow: 1; overflow: hidden; }
        .item-details-row { display: flex; justify-content: space-between; align-items: center; }
        .item-name { font-weight: 600; color: var(--text-color); font-size: 16px; }
        .item-preview-wrapper { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .item-preview { font-size: 14px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .pin-badge {
            background-color: var(--primary-color); color: white;
            font-size: 10px; font-weight: bold;
            padding: 2px 6px; border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #chat-room-screen { background-size: cover; background-position: center; }
        #chat-room-screen .content {
            display: flex; flex-direction: column; padding: 10px;
        }
        #chat-room-screen.multi-select-active .content {
            padding-bottom: 70px; 
        }
        .message-area { flex-grow: 1; overflow-y: auto; padding: 0 10px; scroll-behavior: smooth; }
        .message-wrapper { position: relative; display: flex; margin-bottom: 12px; align-items: flex-start; transition: background-color 0.2s; flex-direction: column; }
        .message-wrapper.group-message { margin-bottom: 18px; }
        .message-wrapper.sent { align-items: flex-end; }
        .message-wrapper.received { align-items: flex-start; }
        .message-wrapper.system-notification { align-items: center; }
        .message-bubble-row { display: flex; width: 100%; align-items: flex-start; }
        .message-wrapper.sent .message-bubble-row { flex-direction: row-reverse; }
        
        .message-wrapper.multi-select-selected::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            background-color: rgba(144, 202, 249, 0.2); 
            border-radius: 10px;
            z-index: -1; 
            pointer-events: none;
        }
        
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 44px);
        }
        .message-wrapper.sent .message-content-wrapper {
            align-items: flex-end;
        }
        .message-wrapper.received .message-content-wrapper {
            align-items: flex-start;
        }
        .message-info { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            position: relative;
            flex-shrink: 0;
        }
        .group-nickname {
            position: absolute;
            top: -15px;
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            width: 70px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .message-time { font-size: 9px; color: #aaa; margin-top: 3px; }
        
        .message-bubble {
            position: relative;
            max-width: 100%;
            padding: 0;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            line-height: 1.5;
            margin: 0 8px;
            cursor: pointer;
            font-size: 15px;
            background-color: var(--received-bg-color); 
            color: var(--received-text-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .message-bubble .content {
             padding: 10px 14px;
        }

        .message-bubble:active {
            transform: scale(0.97);
        }
        
        .message-bubble:is(.sent, .user) {
            background-color: var(--sent-bg-color);
            color: var(--sent-text-color);
            border-bottom-right-radius: 5px;
        }
        .message-bubble:is(.received, .ai) {
            border-bottom-left-radius: 5px;
        }
        
        .message-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit; 
            background: linear-gradient(to bottom, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 50%);
            pointer-events: none;
            opacity: 0.8;
        }
        
        /* New rules for HTML card messages */
        .message-bubble.message-bubble-html-card {
            background: none !important;
            padding: 0 !important;
            box-shadow: none !important;
            border-radius: 12px; /* A default radius for cards */
            overflow: hidden; /* To contain card styles */
        }
        .message-bubble.message-bubble-html-card::before {
            display: none !important;
        }


        #chat-room-screen.has-custom-css .message-bubble {
            background: transparent !important;
            box-shadow: none !important;
        }
        #chat-room-screen.has-custom-css .message-bubble::before {
            display: none !important;
        }

        .blocked-indicator {
            width: 16px;
            height: 16px;
            background-color: #ef5350;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
            margin: auto 6px;
        }
        .message-wrapper.sent .blocked-indicator {
            order: -1;
        }
         .message-wrapper.received .message-bubble-row {
            align-items: center;
        }

        .system-notification-bubble {
            background-color: rgba(200, 200, 200, 0.5);
            color: #666;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
        }

        .image-bubble { max-width: 120px; border-radius: var(--border-radius); margin: 0; padding: 4px; background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
        .image-bubble img { width: 100%; height: auto; display: block; border-radius: calc(var(--border-radius) - 4px); }
        
        .voice-bubble { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 8px 12px; 
            min-width: 90px; 
            max-width: 200px;
        }
        .voice-bubble .play-icon { width: 18px; height: 18px; flex-shrink: 0; fill: currentColor; }
        .voice-bubble .duration { font-size: 13px; margin: 0 8px; white-space: nowrap; }
        .message-wrapper.sent .play-icon { transform: scaleX(-1); }
        .message-wrapper.sent .voice-bubble { flex-direction: row-reverse; }
        
        .voice-transcript {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            padding: 8px 12px;
            margin: 6px 8px 0 8px;
            border-radius: 6px;
            word-break: break-word;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-top 0.3s ease-out;
            background-color: rgba(0, 0, 0, 0.04);
        }
        .voice-transcript.active {
            opacity: 1;
            max-height: 200px;
        }
        .message-wrapper.sent .voice-transcript {
            background-color: rgba(255, 235, 235, 0.9);
        }
        .message-wrapper.received .voice-transcript {
            background-color: rgba(240, 240, 240, 0.9);
        }

        .loading-spinner {
            display: none; 
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 8px;
        }
        .voice-bubble.loading .duration { display: none; }
        .voice-bubble.loading .loading-spinner { display: block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .pv-card {
            width: 230px; 
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin: 0;
        }
        .pv-card-image-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }
        .pv-card-image-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .pv-card-content {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            background-color: white;
            position: relative;
            z-index: 1;
        }
        .pv-card-footer {
            background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
            color: white;
            padding: 20px 10px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 3;
            pointer-events: none; 
            transition: opacity 0.5s ease-in-out;
        }
        .pv-card-footer.hidden {
            opacity: 0;
        }
        .pv-card-footer svg {
            width: 14px;
            height: 14px;
            fill: white;
            flex-shrink: 0;
        }

        .transfer-card {
            width: 230px;
            height: 90px;
            border-radius: 10px;
            margin: 0;
            background: white;
            cursor: pointer;
            overflow: hidden;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #EFEFEF;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .transfer-card .transfer-icon-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .transfer-card .transfer-icon {
            width: 40px;
            height: 40px;
            background-color: #F87D39; /* 微信橙色 */
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .transfer-card .transfer-icon svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        .transfer-card .transfer-details {
            color: #000;
        }
        .transfer-card .transfer-amount {
            font-size: 16px;
            font-weight: 500;
            margin: 0 0 2px 0;
        }
        .transfer-card .transfer-remark {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .transfer-card .transfer-status-footer {
            font-size: 12px;
            color: #888;
            border-top: 1px solid #EFEFEF;
            padding-top: 6px;
            margin-top: 8px;
        }
        
        .location-card {
            width: 230px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 0;
            cursor: pointer;
        }
        .location-card-content {
            padding: 12px;
        }
        .location-card .location-name {
            font-size: 16px;
            font-weight: 500;
            color: #000;
            margin: 0 0 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .location-card .location-address {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .location-card-map {
            height: 80px;
            background-image: url('https://i.postimg.cc/6p07YJFR/IMG-20250805-191513.jpg');
            background-size: cover;
            background-position: center;
        }
        .location-card-footer {
            font-size: 12px;
            color: #888;
            background-color: #FAFAFA;
            padding: 4px 12px;
            border-top: 1px solid #EFEFEF;
        }
        
        .hongbao-card {
            width: 230px;
            height: 90px;
            border-radius: 10px;
            margin: 0;
            position: relative;
            background-color: #FA9D3B;
            cursor: pointer;
            overflow: hidden;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            color: #FFF;
        }
        
        .hongbao-content {
            color: white;
        }
        .hongbao-remark {
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 0;
        }

        .hongbao-status-footer {
            font-size: 12px;
            color: #FFFFFF;
            opacity: 0.9;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 8px;
            margin-top: 8px;
        }
        .hongbao-card.claimed, .hongbao-card.returned {
            background-color: #FBCDA9;
            cursor: default;
        }
        .hongbao-card.claimed .hongbao-content,
        .hongbao-card.claimed .hongbao-status-footer {
             color: #D3823A;
        }
        .hongbao-card.claimed .hongbao-status-footer {
            border-top-color: rgba(211, 130, 58, 0.3);
        }

        .gift-card {
            width: 230px;
            height: 90px;
            cursor: pointer;
            margin: 0;
            position: relative;
            perspective: 1000px;
            background: none;
            border: none;
            box-shadow: none;
        }
        .gift-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .gift-card.is-flipped .gift-card-inner {
            transform: rotateY(180deg);
        }
        .gift-card-front, .gift-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: var(--border-radius);
            box-shadow: 4px 4px 0px #ddd;
            border: 2px solid #333;
            background-color: #fff;
            display: flex;
            align-items: center;
            padding: 10px;
        }
        .gift-card-back {
            transform: rotateY(180deg);
            justify-content: center;
            flex-direction: column;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }
        .gift-card-icon {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .gift-card-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }
        .gift-card-description { 
            font-size: 14px;
            color: #555;
            padding: 8px;
            line-height: 1.5;
        }
        .gift-card-received-stamp {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 2px 6px;
            transform: rotate(15deg);
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
            z-index: 5;
        }
        .gift-card.received .gift-card-received-stamp {
            opacity: 1;
        }

        .load-more-btn { background-color: #e0e0e0; color: #757575; border: none; padding: 8px 16px; margin: 10px auto; border-radius: 15px; cursor: pointer; display: block; font-size: 13px; font-weight: 500; }
        .load-more-btn:hover { background-color: #d1d1d1; }
        .typing-indicator { text-align: center; color: #aaa; font-style: italic; font-size: 14px; padding: 10px 0; display: none; }
        
        #sticker-modal { position: absolute; bottom: 0; left: 0; right: 0; height: 0; background: #f7f7f7; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 25; display: flex; flex-direction: column; transition: height 0.3s ease-in-out; overflow: hidden;}
        #sticker-modal.visible { height: 35%; max-height: 250px; }
        #sticker-modal .header { padding: 10px 15px; font-weight: bold; color: var(--text-color); border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;}
        .sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .sticker-item img { width: 60px; height: 60px; object-fit: contain; }
        .sticker-item span { font-size: 12px; color: #666; margin-top: 5px; text-align: center; }
        #add-sticker-modal .modal-window { max-width: 360px; }
        #sticker-preview { width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 10px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; }
        #sticker-preview img { max-width: 100%; max-height: 100%; }

        .chat-input-wrapper { flex-shrink: 0; position: relative; background-color: #f7f7f7;}
        .message-input-area { display: flex; align-items: center; padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); border-top: 1px solid #eee; background: #f7f7f7; flex-shrink: 0; gap: 8px; }
        .message-input-area input { flex-grow: 1; border: none; padding: 12px; border-radius: 18px; background-color: #fff; }
        .message-input-area input:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-color-translucent); }
        .message-input-area .icon-btn { background: none; border: none; color: #555; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        .message-input-area .icon-btn:disabled { color: #ccc; cursor: not-allowed; }
        .message-input-area .icon-btn svg { width: 24px; height: 24px; fill: currentColor; transition: transform 0.3s ease-out; }
        #send-ai-btn.send-btn { background: var(--primary-color); color: white;}
        #send-ai-btn.send-btn svg { width: 18px; height: 18px; }

        .chat-plus-menu {
            height: 0;
            background-color: #f7f7f7;
            overflow: hidden;
            transition: height 0.3s ease-in-out;
            padding: 0 20px;
        }
        .chat-plus-menu.visible {
            height: auto;
            padding: 20px 20px calc(20px + env(safe-area-inset-bottom));
        }
        .plus-menu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .plus-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .plus-menu-item .icon-background {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .plus-menu-item svg {
            width: 32px;
            height: 32px;
            fill: #444;
        }
        .plus-menu-item span {
            font-size: 12px;
            color: #666;
        }

        #multi-select-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); display: none; justify-content: space-between; align-items: center; padding: 10px 20px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); border-top: 1px solid #eee; z-index: 20; border-bottom-left-radius: var(--phone-corner-radius); border-bottom-right-radius: var(--phone-corner-radius); animation: slideUp 0.3s ease-out; }
        #multi-select-bar.visible { display: flex; }
        
        .settings-sidebar { position: absolute; top: 0; right: -100%; width: 80%; height: 100%; background: #fff; box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: right 0.4s ease-in-out; z-index: 101; display: flex; flex-direction: column; }
        .settings-sidebar.open { right: 0; }
        .settings-sidebar .header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; text-align: center; color: var(--primary-color); }
        .settings-sidebar .content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .settings-sidebar .form-group textarea { height: 100px; resize: vertical; }
        .avatar-setting { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 15px; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--secondary-color); font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid var(--secondary-color);
            border-radius: 10px; 
            background-color: #fff; 
            transition: border-color 0.3s; 
            font-family: var(--font-family); 
            font-size: 14px; 
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); }
        .form-group.radio-group { display: flex; gap: 20px; align-items: center; }
        .form-group.radio-group label { margin-bottom: 0; }
        
        .settings-profile-card {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: #f9f9f9;
        }
        .settings-profile-card:hover {
            background-color: #f0f0f0;
        }
        .settings-profile-card .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .settings-profile-card .details .name {
            font-weight: 600;
        }
        .settings-profile-card .details .label {
            font-size: 12px;
            color: #888;
        }

        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; text-align: center; }
        .btn-primary { background-color: var(--primary-color); color: var(--white-color); }
        .btn-primary:hover { background-color: var(--secondary-color); box-shadow: 0 4px 15px rgba(255, 128, 171, 0.5); }
        label.btn-primary { color: var(--white-color) !important; }
        .btn-small { padding: 8px 16px; font-size: 14px; width: auto; }
        .btn-secondary { background-color: var(--accent-color); color: var(--white-color); margin-bottom: 15px; }
        .btn-secondary:hover { background-color: #64b5f6; box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5); }
        .btn-neutral { background-color: #bdbdbd; color: var(--white-color); }
        .btn-neutral:hover { background-color: #9e9e9e; }
        .btn-danger { background-color: #ef5350; color: white; }
        .btn .spinner { display: none; width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.5); border-top-color: var(--white-color); border-radius: 50%; animation: spin 1s linear infinite; }
        .btn.loading .spinner { display: block; }
        .btn.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .wallpaper-preview { width: 100%; aspect-ratio: 9 / 16; max-height: 400px; border-radius: var(--border-radius); margin-bottom: 15px; background-size: cover; background-position: center; border: 3px dashed var(--primary-color); display: flex; align-items: center; justify-content: center; color: var(--secondary-color); font-style: italic; background-color: var(--bg-color); }
        
        #top-notification-banner {
            position: absolute;
            top: 0;
            left: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 10px 15px;
            z-index: 1001;
            transform: translateY(-120%);
            transition: transform 0.4s ease-in-out;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        #top-notification-banner.show {
            transform: translateY(0);
        }
        #top-notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
        }
        #top-notification-text .title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-color);
        }
        #top-notification-text .message {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
        
        #toast-notification { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px; border-radius: 15px; font-size: 14px; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s; z-index: 1000; }
        .toast.show { opacity: 1; visibility: visible; }
        #world-book-selection-list, #invite-member-selection-list, #transfer-recipient-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 40vh;
            overflow-y: auto;
        }
        .world-book-select-item, .invite-member-select-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .world-book-select-item:last-child, .invite-member-select-item:last-child {
            border-bottom: none;
        }
        .world-book-select-item input[type="checkbox"],
        .invite-member-select-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }
        .world-book-select-item label, .invite-member-select-item label {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .invite-member-select-item img {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
        }

        .member-selection-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            max-height: 40vh;
            overflow-y: auto;
        }
        .member-selection-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .member-selection-item:last-child { border-bottom: none; }
        .member-selection-item input[type="checkbox"] { margin-right: 15px; width: 20px; height: 20px; flex-shrink: 0; }
        .member-selection-item img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
        .member-selection-item label { font-weight: 500; color: var(--text-color); }

        #group-settings-sidebar .group-avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        #group-settings-sidebar .group-avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        #group-settings-sidebar .group-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        #group-settings-sidebar .group-member,
        #group-settings-sidebar .add-member-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
         #group-settings-sidebar .group-member .admin-badge {
            position: absolute;
            top: -5px;
            right: 0px;
            background-color: #FFD700;
            color: #4A3A00;
            font-size: 8px;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 5px;
            border: 1px solid white;
        }
        #group-settings-sidebar .group-member img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid #eee;
        }
        #group-settings-sidebar .add-member-btn .add-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #ccc;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }
        #group-settings-sidebar .add-member-btn:hover .add-icon {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        #group-settings-sidebar .group-member span,
        #group-settings-sidebar .add-member-btn span {
            font-size: 12px;
            text-align: center;
            color: var(--text-color);
        }
        
        #beautify-screen h3 {
             text-align: center;
             color: var(--primary-color);
             margin-top: 0;
             margin-bottom: 15px;
             font-weight: 600;
        }
        #beautify-screen .icon-custom-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #f0f0f0;
            border-radius: var(--border-radius);
            background: #fff;
        }
        #beautify-screen .icon-custom-item:last-child {
            border-bottom: 1px solid #f0f0f0;
        }
        #beautify-screen .icon-preview-label {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        #beautify-screen .icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px dashed #ddd;
            transition: border-color 0.2s;
        }
        #beautify-screen .icon-preview-label:hover .icon-preview {
            border-color: var(--primary-color);
        }
        #beautify-screen .icon-details {
            flex-grow: 1;
        }
        #beautify-screen .icon-details p {
            margin: 0 0 8px 0;
            font-weight: 600;
        }
        #beautify-screen .icon-details .description {
            font-size: 13px;
            color: #888;
        }
        .beautify-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #f0f0f0;
    }
    .color-picker-group {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 10px;
    }
    .color-picker-group label {
        font-weight: 600;
        color: var(--secondary-color);
    }
    #theme-color-picker {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 60px;
        height: 40px;
        background-color: transparent;
        border: 2px solid #eee;
        border-radius: 8px;
        cursor: pointer;
    }
    #theme-color-picker::-webkit-color-swatch {
        border-radius: 6px;
        border: none;
    }
    #theme-color-picker::-moz-color-swatch {
        border-radius: 6px;
        border: none;
    }
        
        .tutorial-item {
            margin-bottom: 15px;
            border: 1px solid var(--secondary-color);
            border-radius: 12px;
            overflow: hidden;
            background-color: var(--bg-color);
        }
        .tutorial-header {
            padding: 12px 18px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tutorial-header::after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        .tutorial-item.open .tutorial-header::after {
            transform: rotate(180deg);
        }
        .tutorial-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease;
            padding: 0 10px;
        }
        .tutorial-item.open .tutorial-content {
            padding: 10px 10px;
            max-height: 5000px; 
        }
        .tutorial-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        /* --- Moments (朋友圈) Styles --- */
        #moments-screen .content {
            padding: 0;
            background-color: #fff;
        }
        .moments-header {
            position: relative;
            width: 100%;
            height: 220px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .moments-header-bg {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            z-index: 1;
        }
        .moments-user-info {
            position: absolute;
            bottom: -15px;
            right: 20px;
            z-index: 2;
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }
        .moments-user-name {
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.6);
            margin-bottom: 25px;
        }
        .moments-user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            object-fit: cover;
        }
        #moments-feed-container {
            padding: 0;
            margin: 0;
            list-style: none;
            background-color: #fff;
        }
        .moment-item {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            display: flex;
            gap: 12px;
        }
        .moment-item-avatar {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .moment-item-main {
            flex-grow: 1;
            overflow: hidden;
        }
        .moment-item-name {
            font-weight: 600;
            color: var(--primary-color);
            margin: 0 0 8px 0;
            cursor: pointer;
        }
        .moment-item-content {
            font-size: 15px;
            line-height: 1.6;
            margin: 0 0 10px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .moment-item-image {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
        }
        .moment-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #999;
            font-size: 13px;
            margin-top: 10px;
            position: relative;
        }
        .moment-item-actions .action-toggle-btn {
            background: #f0f0f0;
            border: none;
            border-radius: 15px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            transition: all 0.2s ease;
        }
         .moment-item-actions .action-toggle-btn:hover {
             background: #e0e0e0;
        }
        .moment-action-popup {
            position: absolute;
            right: 35px;
            bottom: 0;
            background-color: #4c4c4c;
            border-radius: 8px;
            display: flex;
            overflow: hidden;
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.2s ease-in-out;
            opacity: 0;
        }
        .moment-action-popup.visible {
            transform: scaleX(1);
            opacity: 1;
        }
        .moment-action-popup .action-popup-btn {
            background: none;
            border: none;
            color: white;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }
        .moment-action-popup .action-popup-btn:first-child {
             border-right: 1px solid #666;
        }
         .moment-action-popup .action-popup-btn:hover {
            background-color: #333;
        }
        .moment-action-popup svg {
            width: 18px;
            height: 18px;
            fill: white;
        }
        .moment-action-popup .like-btn.liked,
        .moment-action-popup .like-btn.liked svg {
            color: #ff80ab;
            fill: #ff80ab;
        }

        .moment-interactions {
            background-color: #f7f8fa;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }
        .moment-likes {
            padding: 8px 12px;
            font-size: 14px;
            color: var(--secondary-color);
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .moment-likes:empty {
             display: none;
        }
        .moment-likes .like-icon {
             width: 16px; height: 16px; fill: var(--secondary-color);
        }
        .moment-comments-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .moment-comment-item {
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.5;
            cursor: pointer;
        }
        .moment-comment-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        #moment-comment-modal .form-group, #create-moment-modal .form-group { margin-bottom: 10px; }
        #moment-comment-modal textarea, #create-moment-modal textarea { height: 80px; }
        #create-moment-image-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }
        /* --- 引用/回复消息样式 --- */
        .reply-preview-bar {
            padding: 8px 15px;
            background-color: #f0f0f0;
            font-size: 13px;
            color: #666;
            display: none;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #e0e0e0;
        }
        .reply-preview-bar .content {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .reply-preview-bar .cancel-reply-btn {
            background: #ccc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            line-height: 18px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: 10px;
        }
        .quoted-message {
            background-color: rgba(0,0,0,0.05);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 13px;
            color: #555;
            margin-bottom: 5px;
            border-left: 3px solid var(--primary-color);
        }
        .quoted-message .author {
            font-weight: bold;
        }
        .quoted-message .content {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* --- 撤回消息样式 --- */
        .retracted-message {
            font-size: 12px;
            color: #999;
            text-align: center;
            padding: 5px 0;
            width: 100%;
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .theme-item {
            cursor: pointer;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .theme-item:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-color);
        }
        #custom-theme-modal .form-group {
            margin-bottom: 15px;
        }
        #custom-theme-modal .color-input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
         #custom-theme-modal .color-input-group label {
            margin: 0;
         }
        #custom-theme-modal input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 40px; height: 30px; background-color: transparent;
            border: 1px solid #ccc; border-radius: 5px; cursor: pointer;
        }
        #custom-theme-modal input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: none; }
        #custom-theme-modal input[type="color"]::-moz-color-swatch { border-radius: 4px; border: none; }


        #settings-preview-area-private, #settings-preview-area-group {
            padding: 15px;
            background-color: #f0f2f5;
            border-radius: 10px;
            margin-top: 15px;
            background-size: cover;
            background-position: center;
        }
        #settings-preview-area-private .message-wrapper,
        #settings-preview-area-group .message-wrapper { 
            margin-bottom: 8px;
        }
        
        .qq-nav-footer {
            flex-shrink: 0;
            display: flex;
            justify-content: space-around;
            background-color: var(--nav-footer-bg);
            border-top: 1px solid #ddd;
            padding: 5px 0 calc(5px + env(safe-area-inset-bottom));
        }
        .qq-nav-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--nav-icon-color);
            font-size: 10px;
            padding: 5px 10px;
        }
        .qq-nav-btn svg {
            width: 28px;
            height: 28px;
            fill: currentColor;
            margin-bottom: 2px;
        }
        .qq-nav-btn.active {
            color: var(--nav-icon-active-color);
        }
        .qq-tab-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        #chat-list-screen .content {
             padding: 0;
        }
         #chat-tab-content, #contacts-tab-content, #discover-tab-content {
            padding: 0;
            background-color: #f0f2f5;
        }
        .settings-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 15px 0;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .settings-list-item .value {
            color: #888;
            margin-right: 5px;
        }
        .settings-list-item .arrow {
            color: #ccc;
            font-weight: bold;
        }
        #assign-char-modal .list-item, #assign-me-modal .list-item {
            padding: 15px;
        }
        #discover-tab-content .list-item {
            background-color: white;
            margin-top: 8px;
            padding: 15px 20px;
        }
         #discover-tab-content .list-item .item-name {
            font-size: 16px;
            font-weight: 500;
        }
        
        /* --- Video Call System Styles --- */
        #incoming-call-modal .incoming-call-content {
            background-color: rgba(40, 40, 40, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 280px;
            padding: 30px 20px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .caller-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid rgba(255,255,255,0.5);
        }
        .caller-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .caller-text {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 30px;
        }
        .incoming-call-actions {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .action-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        .call-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background-size: 50%;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .call-action-btn:active {
            transform: scale(0.9);
        }
        .call-action-btn.decline {
            background-color: #ff3b30;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" transform="rotate(135 12 12)"/></svg>');
        }
        .call-action-btn.accept {
            background-color: #4cd964;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
        }
        #outgoing-call-screen, #video-call-screen {
            background-color: #1c1c1e; color: white;
        }
        #outgoing-call-screen {
            justify-content: center; align-items: center; text-align: center;
        }
        .outgoing-call-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .outgoing-call-actions {
            margin-top: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        #video-call-screen {
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .video-call-top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 20px; padding-top: calc(15px + env(safe-area-inset-top));
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
            z-index: 10; text-align: center; pointer-events: none;
        }
        #call-timer { font-size: 16px; font-weight: 500; letter-spacing: 1px; }
        .video-call-avatar-area {
            flex-grow: 1; display: flex; justify-content: center; align-items: center;
            padding: 20px; padding-top: 80px; overflow-y: auto;
        }
        #participant-avatars-grid {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
            gap: 15px; max-width: 100%;
        }
        .participant-avatar-wrapper { position: relative; text-align: center; flex-shrink: 0; }
        .participant-avatar {
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease;
        }
        .participant-name { margin-top: 8px; font-size: 12px; color: #ccc; }
        .participant-avatar.speaking {
            border-color: #4cd964; box-shadow: 0 0 20px rgba(76, 217, 100, 0.6); transform: scale(1.05);
        }
        #video-call-main {
            flex-shrink: 0; height: 35%;
            margin: 15px; margin-bottom: 120px;
            overflow-y: auto; padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .call-message-bubble {
            padding: 10px 15px; border-radius: 12px; max-width: 85%;
            line-height: 1.6; word-break: break-word; white-space: pre-wrap;
        }
        .call-message-bubble.ai-speech {
            background-color: rgba(255, 255, 255, 0.15); align-self: flex-start;
        }
        .call-message-bubble.user-speech {
            background-color: #4cd964; align-self: flex-end; text-align: left;
        }
        .video-call-input-area {
            position: absolute; bottom: 0; left: 0; width: 100%;
            display: flex; gap: 10px; align-items: center;
            padding: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            z-index: 5;
        }
        #video-call-user-input {
            flex-grow: 1; padding: 12px 15px; border: none; border-radius: 18px;
            background-color: rgba(255,255,255,0.2); color: white;
        }
        #video-call-user-input::placeholder { color: #aaa; }
        .video-call-control-btn {
            width: 50px; height: 50px; flex-shrink: 0;
            border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .video-call-control-btn.send { background-color: #007bff; }
        .video-call-control-btn.hangup { background-color: #ff3b30; }
        .video-call-control-btn svg { width: 24px; height: 24px; fill: white; }
    </style>
</head>
<body>
    <div class="phone-screen">
        <div id="top-notification-banner">
            <img id="top-notification-avatar" src="" alt="avatar">
            <div id="top-notification-text">
                <div class="title"></div>
                <div class="message"></div>
            </div>
        </div>
        <div id="home-screen" class="screen active"></div>
        <div id="chat-list-screen" class="screen"></div>
        <div id="chat-room-screen" class="screen"></div>
        <div id="world-book-screen" class="screen"></div>
        <div id="edit-world-book-screen" class="screen"></div>
        <div id="moments-screen" class="screen"></div>
        <div id="moments-settings-screen" class="screen"></div>
        <div id="api-settings-screen" class="screen"></div>
        <div id="beautify-screen" class="screen"></div>
        <div id="font-settings-screen" class="screen"></div>
        <div id="tutorial-screen" class="screen"></div>
        <div id="video-call-screen" class="screen"></div>
        <div id="outgoing-call-screen" class="screen"></div>
        
        <!-- Memory Core Screens -->
        <div id="memory-core-screen" class="screen"></div>
        <div id="edit-memory-screen" class="screen"></div>
        <div id="memory-core-settings-screen" class="screen"></div>
        
        <div id="toast-notification" class="toast"></div>
        <div id="add-char-modal" class="modal-overlay"></div>
        <div id="add-me-modal" class="modal-overlay"></div>
        <div id="assign-char-modal" class="modal-overlay"></div>
        <div id="assign-me-modal" class="modal-overlay"></div>
        <div id="theme-selection-modal" class="modal-overlay"></div>
        <div id="custom-theme-modal" class="modal-overlay"></div>
        <div id="add-sticker-modal" class="modal-overlay"></div>
        <div id="sticker-actionsheet" class="action-sheet-overlay"></div>
        <div id="send-voice-modal" class="modal-overlay"></div>
        <div id="send-pv-modal" class="modal-overlay"></div>
        <div id="send-camera-modal" class="modal-overlay"></div>
        <div id="send-transfer-modal" class="modal-overlay"></div>
        <div id="send-gift-modal" class="modal-overlay"></div>
        <div id="receive-transfer-actionsheet" class="action-sheet-overlay"></div>
        <div id="moment-comment-modal" class="modal-overlay"></div>
        <div id="create-moment-modal" class="modal-overlay"></div>
        <div id="pat-pat-modal" class="modal-overlay"></div>
        <div id="send-location-modal" class="modal-overlay"></div>
        <div id="incoming-call-modal" class="modal-overlay"></div>

        <div id="chat-settings-sidebar" class="settings-sidebar"></div>
        <div id="world-book-selection-modal" class="modal-overlay"></div>
        <div id="create-group-modal" class="modal-overlay"></div>
        <div id="group-settings-sidebar" class="settings-sidebar"></div>
        <div id="edit-group-member-modal" class="modal-overlay"></div>
        <div id="add-member-actionsheet" class="action-sheet-overlay"></div>
        <div id="invite-member-modal" class="modal-overlay"></div>
        <div id="create-member-for-group-modal" class="modal-overlay"></div>
        <div id="transfer-recipient-modal" class="modal-overlay"></div>
        <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
        <style id="dynamic-chat-style"></style>
        <style id="global-font-style"></style>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {

// Utility Functions
async function compressImage(file, options = {}) {
    const { quality = 0.8, maxWidth = 800, maxHeight = 800 } = options;
    return new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onerror = reject;
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onerror = reject;
            img.onload = () => {
                let { width, height } = img;
                if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } }
                else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
        };
    });
}
function adjustColor(hex, percent, alpha = 1) {
        let r = parseInt(hex.slice(1, 3), 16),
            g = parseInt(hex.slice(3, 5), 16),
            b = parseInt(hex.slice(5, 7), 16);
        const factor = 1 + percent / 100;
        r = Math.round(Math.min(255, r * factor));
        g = Math.round(Math.min(255, g * factor));
        b = Math.round(Math.min(255, b * factor));
        
        if (alpha < 1) {
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
    }
// --- Initial HTML Injection ---
function injectHTML() {
    // Inject complex HTML structures once on load to keep the body clean.
    const settingsIconSVG = `<svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59-1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>`;

    const htmlMap = {
        'chat-list-screen': `
            <header class="app-header" id="qq-app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container"><h1 class="title" id="qq-app-title">微信</h1></div>
                <div class="action-btn-group" id="qq-app-actions"></div>
            </header>
            <main class="content" style="padding: 0; overflow: hidden;">
                <div id="chat-tab-content" class="qq-tab-content" style="display:block; height: 100%;">
                    <ul class="list-container" id="chat-list-container"></ul>
                    <div class="placeholder-text" id="no-chats-placeholder" style="display: none;"><p>还没有聊天对象哦~</p><p>点击右上角的"+"创建一个吧！</p></div>
                </div>
                <div id="contacts-tab-content" class="qq-tab-content" style="display: none; height: 100%; background-color: #fff;">
                    <ul class="list-container" id="contacts-list-container"></ul>
                </div>
                <div id="discover-tab-content" class="qq-tab-content" style="display: none; background-color: #fff;">
                     <ul class="list-container" id="discover-list" style="margin-top: 15px;">
                      <li class="list-item" data-target="moments-screen">
                        <div class="item-details" style="margin-left: 10px;"><div class="item-name">朋友圈</div></div>
                        <span class="arrow" style="font-size: 20px; color: #ccc;">></span>
                      </li>
                    </ul>
                </div>
                <div id="me-tab-content" class="qq-tab-content" style="display: none; padding: 20px;"></div>
            </main>
            <footer class="qq-nav-footer">
                <button class="qq-nav-btn active" data-tab="chat"><svg viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2M20 16H5.2L4 17.2V4H20V16Z"></path></svg><span>微信</span></button>
                <button class="qq-nav-btn" data-tab="contacts"><svg viewBox="0 0 24 24"><path d="M12 3C14.21 3 16 4.79 16 7S14.21 11 12 11 8 9.21 8 7 9.79 3 12 3M16 13.54C16 14.6 15.1 15.5 14 15.5H10C8.9 15.5 8 14.6 8 13.54C5.61 14.24 4 16.3 4 18.9V21H20V18.9C20 16.3 18.39 14.24 16 13.54Z"></path></svg><span>通讯录</span></button>
                <button class="qq-nav-btn" data-tab="discover"><svg viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M12 20C7.6 20 4 16.4 4 12S7.6 4 12 4 20 7.6 20 12 16.4 20 12 20M12.5 15.6L9.4 12.5L12.5 9.4L11.4 8.3L8.3 11.4L11.4 14.5L12.5 15.6M15.7 11.4L14.6 12.5L11.5 9.4L12.6 8.3L15.7 11.4Z"></path></svg><span>发现</span></button>
                <button class="qq-nav-btn" data-tab="me"><svg viewBox="0 0 24 24"><path d="M12 4C14.21 4 16 5.79 16 8S14.21 12 12 12 8 10.21 8 8 9.79 4 12 4M12 14C16.42 14 20 15.79 20 18V20H4V18C4 15.79 7.58 14 12 14Z"></path></svg><span>我</span></button>
            </footer>`,
        'chat-room-screen': `<header class="app-header" id="chat-room-header-default"><button class="back-btn" data-target="chat-list-screen">‹</button><div class="title-container"><h1 class="title" id="chat-room-title">...</h1><div class="subtitle" id="chat-room-subtitle"><div class="online-indicator"></div><span id="chat-room-status-text">在线</span></div></div><button class="action-btn" id="chat-settings-btn">${settingsIconSVG}</button></header><header class="app-header" id="chat-room-header-select" style="display: none;"><button class="action-btn" id="cancel-multi-select-btn">取消</button><div class="title-container"><h1 class="title" id="multi-select-title">选择消息</h1></div><div class="placeholder"></div></header><main class="content"><div class="message-area" id="message-area"></div><div class="typing-indicator" id="typing-indicator"></div></main><div class="chat-input-wrapper"><div id="reply-preview-bar" class="reply-preview-bar"></div><div class="message-input-area" id="message-input-default"><button id="plus-menu-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg></button><input type="text" id="message-input" placeholder="输入消息..."><button id="sticker-toggle-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg></button><button id="send-ai-btn" class="icon-btn"></button></div><div class="message-input-area" id="message-edit-bar" style="display: none;"><input type="text" id="message-edit-input"><button id="save-edit-btn" class="icon-btn send-btn">✓</button><button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa;">✗</button></div><div id="chat-plus-menu" class="chat-plus-menu"><div class="plus-menu-grid"></div></div></div><div id="multi-select-bar"><span id="select-count">已选择 0 项</span><button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除</button></div><div id="sticker-modal"><div class="header"><span>我的表情</span><button class="btn btn-primary btn-small" id="add-new-sticker-btn">添加新表情</button></div><div class="sticker-grid" id="sticker-grid-container"></div></div>`,
        'world-book-screen': `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">世界书</h1></div><button class="action-btn" id="add-world-book-btn">+</button></header><main class="content"><ul class="list-container" id="world-book-list-container"></ul><div class="placeholder-text" id="no-world-books-placeholder" style="display: none;"><p>你的世界一片混沌...</p><p>点击右上角的"+"创造第一个设定吧！</p></div></main>`,
        'edit-world-book-screen': `<header class="app-header"><button class="back-btn" data-target="world-book-screen">‹</button><div class="title-container"><h1 class="title" id="edit-world-book-title">创建/编辑条目</h1></div><div class="placeholder"></div></header><main class="content"><form id="edit-world-book-form"><input type="hidden" id="world-book-id"><div class="form-group"><label for="world-book-name">条目名称</label><input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required></div><div class="form-group"><label for="world-book-content">条目内容</label><textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea></div><div class="form-group"><label>注入位置</label><div class="form-group radio-group"><label><input type="radio" name="world-book-position" value="before" checked> 前</label><label><input type="radio" name="world-book-position" value="after"> 后</label></div></div><button type="submit" class="btn btn-primary">保存条目</button></form></main>`,
        'moments-screen': `<header class="app-header"><button class="back-btn" data-target="chat-list-screen" id="moments-back-btn">‹</button><div class="title-container"><h1 class="title">朋友圈</h1></div><div class="action-btn-group"><button class="action-btn" id="create-moment-btn"><svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:var(--primary-color);"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7Z" /></svg></button><button class="action-btn" id="moments-settings-btn">${settingsIconSVG}</button></div></header><main class="content"><div id="moments-list-wrapper"></div><div class="placeholder-text" id="no-moments-placeholder" style="display: none;"><p>朋友圈空空如也~</p><p>点击右上角相机发布第一条动态吧！</p></div></main>`,
        'moments-settings-screen': `<header class="app-header"><button class="back-btn" data-target="moments-screen">‹</button><div class="title-container"><h1 class="title">朋友圈设置</h1></div><div class="placeholder"></div></header><main class="content"><div class="form-group"><label>我的朋友圈头像</label><div class="avatar-setting" style="justify-content: center;"><img src="" alt="我的头像" id="moments-my-avatar-preview" class="avatar-preview" style="width:80px;height:80px;border-radius:12px;"><input type="file" id="moments-avatar-upload" accept="image/*" style="display:none;"><label for="moments-avatar-upload" class="btn btn-secondary" style="flex-grow:1; margin-left:15px; margin-bottom:0;">更换头像</label></div></div><hr><div class="form-group"><label>朋友圈封面</label><div class="wallpaper-preview" id="moments-bg-preview" style="height:150px; margin-bottom:10px;"></div><input type="file" id="moments-bg-upload" accept="image/*" style="display:none;"><label for="moments-bg-upload" class="btn btn-primary">更换封面</label></div><hr><form id="moments-settings-form"><div class="form-group"><label>AI自动发布动态</label><div class="form-group radio-group"><label><input type="radio" name="moments-enabled" value="true"> 开启</label><label><input type="radio" name="moments-enabled" value="false"> 关闭</label></div></div><div class="form-group"><label for="moments-frequency">发布频率</label><select id="moments-frequency" name="frequency"><option value="high">高 (1-2小时/条)</option><option value="medium">中 (4-8小时/条)</option><option value="low">低 (12-24小时/条)</option></select></div><button type="submit" class="btn btn-primary">保存设置</button></form><hr style="border:none; border-top:1px solid #eee; margin: 20px 0;"><button type="button" class="btn btn-danger" id="clear-moments-btn">清空所有动态</button></main>`,
        'api-settings-screen': `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">API 设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="api-form">
        <h3>聊天模型 API</h3>
        <p style="font-size: 13px; color: #888; margin-top: -15px;">要使用图片识别功能，请选择 Gemini 并确保您的模型支持 (如 gemini-pro-vision)。</p>
        <div class="form-group"><label for="api-provider">API 服务商</label><select id="api-provider" name="provider"><option value="newapi">NewAPI (自定义)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option></select></div><div class="form-group"><label for="api-url">API 地址（后缀不用添加/v1）</label><input type="url" id="api-url" name="url" placeholder="选择服务商可自动填写" required></div><div class="form-group"><label for="api-key">密钥 (Key)</label><input type="password" id="api-key" name="key" placeholder="请输入你的API密钥" required></div><button type="button" class="btn btn-secondary" id="fetch-models-btn"><span class="btn-text">点击拉取模型</span><div class="spinner"></div></button><div class="form-group"><label for="api-model">选择模型</label><select id="api-model" name="model" required><option value="">请先拉取模型列表</option></select></div>
        <hr style="margin: 30px 0;">
        <h3>图像生成 API (可选，用于朋友圈)</h3>
        <p style="font-size: 13px; color: #888; margin-top: -15px;">用于AI自动发朋友圈时生成配图，需兼容OpenAI DALL-E API格式。</p>
        <div class="form-group"><label for="image-api-url">API 地址</label><input type="url" id="image-api-url" name="image_url" placeholder="例如: https://api.openai.com" ></div><div class="form-group"><label for="image-api-key">密钥 (Key)</label><input type="password" id="image-api-key" name="image_key" placeholder="请输入你的图像API密钥" ></div><div class="form-group"><label for="image-api-model">选择模型</label><input type="text" id="image-api-model" name="image_model" placeholder="例如: dall-e-3"></div>
        <button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">保 存</span><div class="spinner"></div></button></form></main>`,
        'beautify-screen': `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">美化</h1></div><div class="placeholder"></div></header><main class="content">
        <h3 style="text-align:center; color: var(--primary-color); margin-top:0;">更换壁纸</h3>
        <div class="wallpaper-preview" id="wallpaper-preview"><span>当前壁纸预览</span></div>
        <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;">
        <label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label>
        
        <div class="beautify-section">
            <h3 style="text-align:center; color: var(--primary-color);">全局主题颜色</h3>
            <div class="color-picker-group">
                <label for="theme-color-picker">选择主色调:</label>
                <input type="color" id="theme-color-picker">
            </div>
        </div>

        <div class="beautify-section">
            <h3 style="text-align:center; color: var(--primary-color);">全局字体</h3>
            <form id="font-settings-form-beautify">
                <div class="form-group">
                    <label for="font-url-beautify">字体文件URL (.ttf, .otf, .woff等)</label>
                    <input type="url" id="font-url-beautify" placeholder="https://.../font.ttf">
                </div>
                <button type="submit" class="btn btn-secondary">应用字体</button>
                <button type="button" class="btn btn-neutral" id="restore-default-font-btn-beautify">恢复默认</button>
            </form>
        </div>

        <div class="beautify-section">
            <h3 style="text-align:center; color: var(--primary-color);">主屏幕图标自定义</h3>
            <form id="customize-form"></form>
        </div>
    </main>`,
        'font-settings-screen': ``,
        'tutorial-screen': `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">教程</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`,
        'memory-core-screen': `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">记忆核心</h1></div><div class="action-btn-group"><button class="action-btn" id="add-memory-btn">+</button><button class="action-btn" id="memory-settings-btn">${settingsIconSVG}</button></div></header><main class="content"><ul class="list-container" id="memory-core-list-container"></ul><div class="placeholder-text" id="no-memories-placeholder" style="display: none;"><p>AI还没有任何记忆...</p><p>在聊天设置中为角色提取记忆，或点击"+"添加全局记忆吧！</p></div></main>`,
        'edit-memory-screen': `<header class="app-header"><button class="back-btn" data-target="memory-core-screen">‹</button><div class="title-container"><h1 class="title" id="edit-memory-screen-title">创建/编辑记忆</h1></div><div class="placeholder"></div></header><main class="content"><form id="edit-memory-form"><input type="hidden" id="memory-id"><div class="form-group" id="memory-topic-group"><label for="memory-topic">记忆主题 (简短概括)</label><input type="text" id="memory-topic" placeholder="例如：用户生日、宠物名字" required></div><div class="form-group"><label for="memory-content">记忆内容 (详细信息)</label><textarea id="memory-content" rows="12" placeholder="详细描述这条记忆..." required></textarea></div><button type="submit" class="btn btn-primary">保存记忆</button></form></main>`,
        'memory-core-settings-screen': `<header class="app-header"><button class="back-btn" data-target="memory-core-screen">‹</button><div class="title-container"><h1 class="title">记忆核心设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="memory-settings-form"><div class="form-group"><label for="memory-injection-prompt">记忆注入提示词</label><textarea id="memory-injection-prompt" rows="8" placeholder="描述如何将角色的个人记忆注入到主提示词中。使用 {{memories}} 作为记忆内容的占位符。"></textarea></div><div class="form-group"><label for="memory-extraction-prompt">记忆提取提示词</label><textarea id="memory-extraction-prompt" rows="8" placeholder="描述如何从对话历史中提取和总结新的记忆点。使用 {{history}} 作为对话历史占位符，{{memories}} 作为已有记忆占位符。"></textarea></div><button type="submit" class="btn btn-primary">保存设置</button></form></main>`,
        'add-char-modal': `<div class="modal-window"><h3 id="add-char-modal-title">创建新角色</h3><form id="add-char-form"><input type="hidden" id="edit-char-id"><div class="avatar-setting"><img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="角色头像" id="char-avatar-preview" class="avatar-preview"><input type="file" id="char-avatar-upload" accept="image/*" style="display:none;"><label for="char-avatar-upload" class="btn btn-secondary btn-small" style="margin-bottom:0;">更换头像</label></div><div class="form-group"><label for="char-real-name">角色姓名</label><input type="text" id="char-real-name" placeholder="角色的真实姓名" required></div><div class="form-group"><label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name" placeholder="你对Ta的称呼" required></div><div class="form-group"><label for="char-persona-input">人物设定</label><textarea id="char-persona-input" rows="4"></textarea></div><div class="form-group"><label for="char-pat-pat-response">“拍一拍”回应 (AI主动拍你时说的话)</label><input type="text" id="char-pat-pat-response" placeholder="例如：怎么啦？"></div><button type="submit" class="btn btn-primary">创建</button></form></div>`,
        'add-me-modal': `<div class="modal-window"><h3 id="add-me-modal-title">创建我的设定</h3><form id="add-me-form"><input type="hidden" id="edit-me-id"><div class="avatar-setting"><img src="https://i.postimg.cc/GtbTnxhP/o-o-1.jpg" alt="我的头像" id="me-avatar-preview" class="avatar-preview"><input type="file" id="me-avatar-upload" accept="image/*" style="display:none;"><label for="me-avatar-upload" class="btn btn-secondary btn-small" style="margin-bottom:0;">更换头像</label></div><div class="form-group"><label for="me-name-input">我的姓名</label><input type="text" id="me-name-input" placeholder="你希望Ta如何称呼你" required></div><div class="form-group"><label for="me-persona-input">我的人设</label><textarea id="me-persona-input" rows="4"></textarea></div><button type="submit" class="btn btn-primary">创建</button></form></div>`,
        'assign-char-modal': `<div class="modal-window"><h3>指派AI人物设定</h3><ul id="assign-char-list" class="list-container" style="max-height: 50vh; overflow-y: auto;"></ul></div>`,
        'assign-me-modal': `<div class="modal-window"><h3>指派我的角色设定</h3><ul id="assign-me-list" class="list-container" style="max-height: 50vh; overflow-y: auto;"></ul><button id="add-me-profile-btn" class="btn btn-secondary" style="margin-top: 15px;">创建新的“我”</button></div>`,
        'theme-selection-modal': `<div class="modal-window"><h3 id="theme-selection-title">选择气泡主题</h3><div id="theme-selection-grid" class="theme-grid"></div></div>`,
        'add-sticker-modal': `<div class="modal-window"><h3 id="add-sticker-modal-title">添加新表情</h3><form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
            <div id="single-sticker-inputs">
                <div id="sticker-preview"><span>预览</span></div>
                <div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name" placeholder="如：开心"></div>
                <div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url" id="sticker-url-input" placeholder="粘贴图片URL"></div>
                <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
                <input type="file" id="sticker-file-upload" accept="image/*" style="display:none;">
                <label for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
            </div>
            <div id="batch-sticker-inputs" style="display: none;">
                 <div class="form-group">
                    <label for="batch-sticker-textarea">批量添加</label>
                    <textarea id="batch-sticker-textarea" rows="6" placeholder="格式：\n表情名1https://url1.png,表情名2https://url2.png\n(用英文逗号,隔开每个表情)"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button type="button" class="btn btn-neutral" id="toggle-sticker-mode-btn" style="flex:1;">切换到批量模式</button>
            </div>
            <button type="submit" class="btn btn-primary">保存</button></form></div>`,
        'sticker-actionsheet': `<div class="action-sheet"><button class="action-sheet-button" id="edit-sticker-btn">编辑</button><button class="action-sheet-button danger" id="delete-sticker-btn">删除</button></div>`,
        'send-voice-modal': `<div class="modal-window"><h3>发送语音消息</h3><form id="send-voice-form"><div class="form-group"><label for="voice-text-input">输入语音文字</label><textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea></div><div class="form-group" style="text-align:center; color:#888; font-size: 14px;">预计时长: <span id="voice-duration-preview">0"</span></div><button type="submit" class="btn btn-primary">发送</button></form></div>`,
        'send-pv-modal': `<div class="modal-window"><h3>分享照片/视频</h3><form id="send-pv-form"><div class="form-group"><label for="pv-text-input">输入描述</label><textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required rows="4"></textarea></div><button type="submit" class="btn btn-primary">发送</button></form></div>`,
        'send-camera-modal': `<div class="modal-window"><h3>拍摄</h3><form id="send-camera-form"><div class="form-group"><label for="camera-text-input">输入描述</label><textarea id="camera-text-input" placeholder="在这里描述你拍摄的场景..." required rows="4"></textarea></div><button type="submit" class="btn btn-primary">发送</button></form></div>`,
        'send-transfer-modal': `<div class="modal-window"><h3 id="send-transfer-title">转账</h3><form id="send-transfer-form"><div class="form-group" id="transfer-recipient-group" style="display:none;"><label for="transfer-recipient-name">转给</label><input type="text" id="transfer-recipient-name" readonly></div><div class="form-group"><label for="transfer-amount-input">金额 (元)</label><input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01"></div><div class="form-group"><label for="transfer-remark-input">备注</label><input type="text" id="transfer-remark-input" placeholder="（选填）"></div><button type="submit" class="btn btn-primary">发送</button></form></div>`,
        'send-gift-modal': `<div class="modal-window"><h3>送出礼物</h3><form id="send-gift-form"><div class="form-group"><label for="gift-description-input">礼物描述</label><textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required rows="4"></textarea></div><button type="submit" class="btn btn-primary">发送</button></form></div>`,
        'receive-transfer-actionsheet': `<div class="action-sheet"><button class="action-sheet-button" id="accept-transfer-btn">接收</button><button class="action-sheet-button danger" id="return-transfer-btn">退回</button></div>`,
        'moment-comment-modal': `<div class="modal-window"><h3>发表评论</h3><form id="moment-comment-form"><input type="hidden" id="moment-comment-moment-id"><input type="hidden" id="moment-comment-reply-id"><div class="form-group"><textarea id="moment-comment-input" placeholder="发布一条友善的评论吧" required></textarea></div><button type="submit" class="btn btn-primary">发布</button></form></div>`,
        'create-moment-modal': `<div class="modal-window"><h3>发布动态</h3><form id="create-moment-form"><div class="form-group"><textarea id="create-moment-text" placeholder="分享新鲜事..." required rows="5"></textarea></div><input type="file" id="create-moment-image-upload" accept="image/*" style="display:none;"><label for="create-moment-image-upload" class="btn btn-secondary">选择图片 (可选)</label><img id="create-moment-image-preview" src="" alt="Image Preview"><button type="submit" class="btn btn-primary">发布</button></form></div>`,
        'chat-settings-sidebar': `<div class="header">对话设定</div><div class="content"><form id="chat-settings-form">
            <div class="form-group">
                <label>AI人物设定</label>
                <div id="assign-char-btn" class="settings-profile-card">
                    <img id="assigned-char-avatar" src="" class="avatar">
                    <div class="details">
                        <span id="assigned-char-name" class="name"></span>
                        <span class="label">点击编辑角色信息</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>我的角色设定</label>
                <div id="assign-me-btn" class="settings-profile-card">
                    <img id="assigned-me-avatar" src="" class="avatar">
                    <div class="details">
                        <span id="assigned-me-name" class="name"></span>
                        <span class="label">点击编辑“我”的信息</span>
                    </div>
                </div>
            </div>
            <hr>
            <div class="form-group"><label for="setting-max-memory-private">上下文记忆条数</label><input type="number" id="setting-max-memory-private" value="10"></div>
             <div class="form-group settings-list" style="margin: 0; border-top: 1px solid #f0f0f0;">
                <button type="button" class="settings-list-item" id="select-theme-btn-private">
                    <span>聊天气泡主题</span>
                    <span class="value" id="current-theme-name-private"></span>
                    <span class="arrow">></span>
                </button>
            </div>
            <div class="form-group"><label for="font-size-slider-private">聊天字体大小 <span id="font-size-value-private">15px</span></label><input type="range" id="font-size-slider-private" min="12" max="20" step="1" value="15" style="width: 100%; margin-top: 8px;"></div>
            <div class="form-group"><label for="custom-css-input-private">自定义气泡样式 (CSS)<button id="reset-custom-css-btn-private" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">重置</button></label><textarea id="custom-css-input-private" rows="8" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="美化指南: 为气泡添加装饰，而非覆盖颜色。
选择器规则:
- 我方气泡: .message-bubble.user .content
- 对方气泡: .message-bubble.ai .content
- 通用气泡: .message-bubble .content

/* 示例1: 细腻磨砂质感 */
.message-bubble .content {
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.3);
  color: #333; /* 需自己适配颜色 */
}
/* 示例2: 我的气泡加高光 */
.message-bubble.user .content::before {
  content: ''; position: absolute;
  width: 10px; height: 5px; top: 2px; left: 6px;
  background: rgba(255,255,255,0.8);
  border-radius: 50%; filter: blur(1.5px);
  transform: rotate(-35deg);
}"></textarea></div>
            <div class="form-group"><label>实时预览</label><div id="settings-preview-area-private"></div></div>
            <hr>
            <div class="form-group"><button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button></div>
            <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">聊天背景</label><input type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>
            <hr>
            <div class="form-group"><label>主动搭话</label><div class="form-group radio-group"><label><input type="radio" name="proactive-chat" value="true"> 开启</label><label><input type="radio" name="proactive-chat" value="false"> 关闭</label></div></div>
            <div class="form-group"><label for="proactive-chat-frequency">搭话频率</label><select id="proactive-chat-frequency"><option value="low">低 (约12-24小时)</option><option value="medium">中 (约4-8小时)</option><option value="high">高 (约1-4小时)</option></select></div>
            <hr>
            <div class="form-group"><label>自动提取记忆</label><div class="form-group radio-group"><label><input type="radio" name="auto-memory" value="true"> 开启</label><label><input type="radio" name="auto-memory" value="false"> 关闭</label></div></div>
            <div class="form-group"><label for="auto-memory-frequency">提取频率</label><select id="auto-memory-frequency"><option value="15">每 15 条消息后</option><option value="30">每 30 条消息后</option><option value="50">每 50 条消息后</option></select></div>
            <button type="submit" class="btn btn-primary">储存设定</button>
        </form><hr><button type="button" class="btn btn-secondary" id="extract-memory-btn" style="margin-bottom: 15px;"><span class="btn-text">手动提取记忆</span><div class="spinner"></div></button><button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button></div>`,
        'world-book-selection-modal': `<div class="modal-window"><h3>选择要关联的世界书</h3><ul id="world-book-selection-list"></ul><button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button></div>`,
        'create-group-modal': `<div class="modal-window"><h3>创建群聊</h3><form id="create-group-form"><div class="form-group"><label>选择群成员</label><ul id="member-selection-list" class="member-selection-list"></ul></div><div class="form-group"><label for="group-name-input">群聊名称</label><input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required></div><button type="submit" class="btn btn-primary">创建群聊</button></form></div>`,
        'group-settings-sidebar': `<div class="header">群聊设置</div><div class="content"><form id="group-settings-form"><div class="group-avatar-setting"><img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview"><input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;"><label for="setting-group-avatar-upload" class="btn btn-primary" style="flex-grow:1;">更换群头像</label></div><div class="form-group"><label for="setting-group-name">群名 (AI也可见)</label><input type="text" id="setting-group-name"></div>
        <div class="form-group settings-list" style="margin: 0;">
             <button type="button" class="settings-list-item" id="assign-group-me-btn"><span>我的角色设定</span><span class="value" id="assigned-group-me-name"></span><span class="arrow">></span></button>
        </div>
        <hr><div class="form-group"><label>群成员</label><div class="group-members-list" id="group-members-list-container"></div></div>
         <div class="form-group"><button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button></div>
        <hr>
        <div class="form-group"><label for="setting-max-memory-group">上下文记忆条数</label><input type="number" id="setting-max-memory-group" value="10"></div>
        <div class="form-group settings-list" style="margin: 0; border-top: 1px solid #f0f0f0;">
            <button type="button" class="settings-list-item" id="select-theme-btn-group">
                <span>聊天气泡主题</span>
                <span class="value" id="current-theme-name-group"></span>
                <span class="arrow">></span>
            </button>
        </div>
        <div class="form-group"><label for="font-size-slider-group">聊天字体大小 <span id="font-size-value-group">15px</span></label><input type="range" id="font-size-slider-group" min="12" max="20" step="1" value="15" style="width: 100%; margin-top: 8px;"></div>
        <div class="form-group"><label for="custom-css-input-group">自定义气泡样式 (CSS)<button id="reset-custom-css-btn-group" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">重置</button></label><textarea id="custom-css-input-group" rows="8" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="美化指南: 为气泡添加装饰，而非覆盖颜色。
选择器规则:
- 我方气泡: .message-bubble.user .content
- 对方气泡: .message-bubble.ai .content 或 .message-bubble:not(.user) .content
- 通用气泡: .message-bubble .content

/* 示例1: 给所有收到的气泡加阴影 */
.message-bubble.ai {
  box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
}
/* 示例2: 让我的气泡字体变色(需适配主题) */
.message-bubble.user .content {
  color: white; 
  text-shadow: 1px 1px 1px #000;
}"></textarea></div>
        <div class="form-group"><label>实时预览</label><div id="settings-preview-area-group"></div></div>
        <div class="form-group"><label for="setting-group-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input type="file" id="setting-group-chat-bg-upload" accept="image/*" style="display:none;"></div><button type="submit" class="btn btn-primary">保存设置</button></form><hr style="border:none; border-top:1px solid #eee; margin: 20px 0;"><button type="button" class="btn btn-secondary" id="extract-group-memory-btn" style="margin-bottom: 15px;"><span class="btn-text">提取全体成员记忆</span><div class="spinner"></div></button><button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button></div>`,
        'edit-group-member-modal': `<div class="modal-window"><h3 id="edit-group-member-title">编辑群成员</h3><form id="edit-group-member-form"><input type="hidden" id="editing-member-id"><div class="avatar-setting" style="justify-content: center;"><img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview" style="cursor: pointer;"><input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;"></div><div class="form-group"><label for="edit-member-group-nickname">群昵称</label><input type="text" id="edit-member-group-nickname" required></div><div class="form-group"><label for="edit-member-real-name">真名</label><input type="text" id="edit-member-real-name" required></div><div class="form-group"><label for="edit-member-persona">人设</label><textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea></div><div id="admin-actions-container"></div><button type="submit" class="btn btn-primary">保存</button></form></div>`,
        'add-member-actionsheet': `<div class="action-sheet"><button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button><button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button></div>`,
        'invite-member-modal': `<div class="modal-window"><h3>邀请成员加入群聊</h3><ul id="invite-member-selection-list"></ul><button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button></div>`,
        'create-member-for-group-modal': `<div class="modal-window"><h3>创建新角色并加入群聊</h3><form id="create-member-for-group-form"><div class="avatar-setting" style="justify-content: center;"><img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像" id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;"><input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;"></div><div class="form-group"><label for="create-group-member-nickname">群昵称</label><input type="text" id="create-group-member-nickname" required></div><div class="form-group"><label for="create-group-member-realname">真名</label><input type="text" id="create-group-member-realname" required></div><div class="form-group"><label for="create-group-member-persona">人设</label><textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea></div><button type="submit" class="btn btn-primary">创建并加入</button></form></div>`,
        'transfer-recipient-modal': `<div class="modal-window"><h3>请选择转账对象</h3><ul id="transfer-recipient-list" class="list-container" style="max-height: 50vh; overflow-y: auto;"></ul></div>`,
        'pat-pat-modal': `<div class="modal-window">
            <h3 id="pat-pat-title">你拍了拍...</h3>
            <form id="pat-pat-form">
                <div class="form-group">
                    <label for="pat-pat-input">附加信息 (选填)</label>
                    <input type="text" id="pat-pat-input" placeholder="例如：提醒我干正事">
                </div>
                <button type="submit" class="btn btn-primary">拍一拍</button>
            </form>
        </div>`,
        'send-location-modal': `<div class="modal-window">
            <h3>发送位置</h3>
            <form id="send-location-form">
                <div class="form-group">
                    <label for="location-name-input">位置名称</label>
                    <input type="text" id="location-name-input" placeholder="如：市中心广场" required>
                </div>
                <div class="form-group">
                    <label for="location-address-input">详细地址 (选填)</label>
                    <input type="text" id="location-address-input" placeholder="如：人民路123号">
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>`,
        'custom-theme-modal': `
        <div class="modal-window">
            <h3>自定义主题</h3>
            <form id="custom-theme-form">
                <div class="form-group">
                    <div class="color-input-group">
                        <label for="custom-sent-bg">我方气泡背景</label>
                        <input type="color" id="custom-sent-bg">
                    </div>
                </div>
                <div class="form-group">
                    <div class="color-input-group">
                        <label for="custom-sent-text">我方气泡文字</label>
                        <input type="color" id="custom-sent-text">
                    </div>
                </div>
                 <div class="form-group">
                    <div class="color-input-group">
                        <label for="custom-received-bg">对方气泡背景</label>
                        <input type="color" id="custom-received-bg">
                    </div>
                </div>
                 <div class="form-group">
                    <div class="color-input-group">
                        <label for="custom-received-text">对方气泡文字</label>
                        <input type="color" id="custom-received-text">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">保存自定义主题</button>
            </form>
        </div>`,
        'incoming-call-modal': `
            <div class="incoming-call-content">
                <img src="" alt="Caller" class="caller-avatar" id="incoming-call-avatar">
                <h2 class="caller-name" id="incoming-call-name"></h2>
                <p class="caller-text" id="incoming-call-text"></p>
                <div class="incoming-call-actions">
                    <div class="action-button-wrapper">
                        <button class="call-action-btn decline" id="decline-call-btn"></button>
                        <span>拒绝</span>
                    </div>
                    <div class="action-button-wrapper">
                        <button class="call-action-btn accept" id="accept-call-btn"></button>
                        <span>接听</span>
                    </div>
                </div>
            </div>`,
        'outgoing-call-screen': `
            <div class="outgoing-call-content">
                 <img src="" alt="Calling" class="caller-avatar" id="outgoing-call-avatar">
                <h2 class="caller-name" id="outgoing-call-name"></h2>
                <p class="caller-text" id="outgoing-call-text">正在呼叫...</p>
                <div class="outgoing-call-actions">
                     <button class="call-action-btn decline" id="cancel-outgoing-call-btn"></button>
                     <span>取消</span>
                </div>
            </div>`,
        'video-call-screen': `
            <div class="video-call-top-bar"><span id="call-timer">00:00</span></div>
            <div class="video-call-avatar-area">
                <div id="participant-avatars-grid"></div>
            </div>
            <div id="video-call-main"></div>
            <div class="video-call-input-area">
                <button class="video-call-control-btn hangup" id="video-call-hangup-btn">
                    <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" transform="rotate(135 12 12)"/></svg>
                </button>
                <input type="text" id="video-call-user-input" placeholder="输入你的发言...">
                <button class="video-call-control-btn send" id="video-call-send-btn">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>`
    };
    for (const id in htmlMap) {
        const element = document.getElementById(id);
        if (element) element.innerHTML = htmlMap[id];
    }
}

// --- Global Variables and Constants ---
const colorThemesV2 = {
    'default': { name: '默认', sent: { bg: 'rgba(255,204,204,0.9)', text: '#A56767' }, received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' } },
    'pink_blue': { name: '粉蓝', sent: { bg: '#87CEFA', text: '#FFFFFF' }, received: { bg: '#FFC0CB', text: '#000000' } },
    'blue_white': { name: '蓝白', sent: { bg: '#ADD8E6', text: '#000000' }, received: { bg: '#FFFFFF', text: '#000000' } },
    'purple_yellow': { name: '紫黄', sent: { bg: '#DA70D6', text: '#FFFFFF' }, received: { bg: '#FFFFE0', text: '#000000' } },
    'black_white': { name: '黑白', sent: { bg: '#333333', text: '#FFFFFF' }, received: { bg: '#F5F5F5', text: '#000000' } },
    'yellow_white': { name: '黄白', sent: { bg: '#FFD700', text: '#000000' }, received: { bg: '#FFFFFF', text: '#000000' } },
    'red_black': { name: '红黑', sent: { bg: '#DC143C', text: '#FFFFFF' }, received: { bg: '#36454F', text: '#FFFFFF' } },
    'blue_yellow': { name: '蓝黄', sent: { bg: '#6495ED', text: '#FFFFFF' }, received: { bg: '#FFFACD', text: '#000000' } },
    'pink_yellow': { name: '粉黄', sent: { bg: '#FFB6C1', text: '#000000' }, received: { bg: '#FFFFE0', text: '#000000' } },
    'pink_purple': { name: '粉紫', sent: { bg: '#FFC0CB', text: '#000000' }, received: { bg: '#E6E6FA', text: '#000000' } },
    'gray_white': { name: '灰白', sent: { bg: '#A9A9A9', text: '#FFFFFF' }, received: { bg: '#F5F5F5', text: '#000000' } },
    'blue_green': { name: '蓝绿', sent: { bg: '#4682B4', text: '#FFFFFF' }, received: { bg: '#98FB98', text: '#000000' } },
    'pink_white': { name: '粉白', sent: { bg: '#FFC0CB', text: '#000000' }, received: { bg: '#FFFFFF', text: '#000000' } },
    'pink_black': { name: '粉黑', sent: { bg: '#FF69B4', text: '#FFFFFF' }, received: { bg: '#333333', text: '#FFFFFF' } },
    'pink_green': { name: '粉绿', sent: { bg: '#FFC0CB', text: '#000000' }, received: { bg: '#90EE90', text: '#000000' } },
    'green_black': { name: '绿黑', sent: { bg: '#2E8B57', text: '#FFFFFF' }, received: { bg: '#36454F', text: '#FFFFFF' } },
    'custom': { name: '自定义' }
};

const defaultIcons = {
    'chat-list-screen': { name: '微信', url: 'https://i.postimg.cc/jdG3tLF6/IMG-20250804-223602.jpg' },
    'api-settings-screen': { name: 'API', url: 'https://i.postimg.cc/HkXZxdqq/IMG-20250804-223720.jpg' },
    'world-book-screen': { name: '世界书', url: 'https://i.postimg.cc/jjhMHvdv/IMG-20250804-223631.jpg' },
    'beautify-screen': { name: '美化', url: 'https://i.postimg.cc/bvP6S48s/IMG-20250804-223654.jpg' },
    'memory-core-screen': { name: '记忆核心', url: 'https://i.postimg.cc/1t5JJ68S/IMG-20250804-223742.jpg' },
    'day-mode-btn': { name: '', url: 'https://i.postimg.cc/85Kw35v6/IMG-20250804-223821.jpg' },
    'night-mode-btn': { name: '', url: 'https://i.postimg.cc/qqNQdTcZ/IMG-20250804-223857.jpg' }
};

const ICONS = {
    SEND: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>`,
    AI_REPLY: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.2,4.8c-2.3,0-4.4,0.9-6,2.3L4,8.3c1.3-1.1,2.9-1.8,4.7-1.8c3.4,0,6.2,2.8,6.2,6.2s-2.8,6.2-6.2,6.2c-1.8,0-3.4-0.7-4.7-1.8L4,18.3c1.6,1.4,3.7,2.3,6,2.3c4.7,0,8.5-3.8,8.5-8.5S15.9,4.8,11.2,4.8z M2,11.2c0-2,0.6-3.8,1.8-5.3L2.4,4.5C0.9,6.3,0,8.7,0,11.2s0.9,4.9,2.4,6.7l1.4-1.4C2.6,15,2,13.2,2,11.2z"/></svg>`,
    LIKE: `<svg viewBox="0 0 24 24"><path d="M12.1 18.55L12 18.65l-.1-.1c-1.64-1.24-5.12-3.87-5.12-7.44C6.78 8.44 8.64 6.7 10.99 6.7c1.31 0 2.5.56 3.32 1.45l.01.01.01-.01c.82-.89 2.01-1.45 3.32-1.45 2.35 0 4.21 1.74 4.21 4.11 0 3.57-3.48 6.2-5.12 7.44z"></path></svg>`,
    COMMENT: `<svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>`
};


let db = {};
let currentReplyInfo = null;
let currentChatId = null, currentChatType = null, isGenerating = false, longPressTimer = null, isInMultiSelectMode = false, editingMessageId = null, currentPage = 1, currentTransferMessageId = null, currentEditingWorldBookId = null, currentStickerActionTarget = null, currentEditingMemoryId = null, notificationTimeout = null;
let selectedMessageIds = new Set();
const MESSAGES_PER_PAGE = 50;

let videoCallState = {
    isActive: false,
    isAwaitingResponse: false,
    isGroupCall: false,
    activeChatId: null,
    initiator: null, // 'user' or 'ai'
    startTime: null,
    participants: [], // For group calls, tracks who joined
    isUserParticipating: true, // Tracks if the user is currently in the call
    callHistory: [], // Transcript of the call
    preCallContext: "", // Context from chat before the call
    callRequester: null, // Name of the AI who initiated a group call
};
let callTimerInterval = null;


// Cache DOM elements after they are injected
let domCache = {};
const getEl = (id) => {
    if (!domCache[id]) {
        domCache[id] = document.getElementById(id);
    }
    return domCache[id];
};

// --- Utility and Core Functions ---
const saveData = () => localStorage.setItem('gemini-chat-app-db', JSON.stringify(db));
const loadData = () => {
    const data = localStorage.getItem('gemini-chat-app-db');
    const defaultDb = {
        characters: [],
        meProfiles: [
             { id: 'me_default', myName: '我', myPersona: '', myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg' }
        ],
        groups: [],
        apiSettings: { url: '', key: '', model: '', provider: 'newapi' },
        imageApiSettings: { url: '', key: '', model: '' },
        themeColor: '#ff80ab',
        wallpaper: 'https://i.postimg.cc/RZhtsRRX/IMG-20250804-223935.jpg',
        myStickers: [],
        homeScreenMode: 'night',
        worldBooks: [],
        fontUrl: '',
        customIcons: {},
        moments: [],
        momentsSettings: { 
            enabled: true, 
            frequency: 'medium', 
            background: 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg',
            myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg'
        },
        memoryEntries: [],
        memorySettings: {
            injectionPrompt: `以下是 {{char}} 与{{user}}的记忆与事件的要求：

# 记忆整合：无缝化人格
记忆是 {{char}} 人格的基石，而非一个外部数据库。当引用记忆时，必须如同是 {{char}} 自身的真实回忆，自然、无缝地融入对话，而不是像在查询资料。

【禁止机械引用】：绝对避免“根据我的记忆库...”、“我记录到...”等破坏沉浸感的表述。

【情境触发】：只在当前对话与某段记忆高度相关时才自然地引出。例如，当 {{user}} 再次提到海边时，可以说：“说起来，我一直记得你上次说的那个关于海的幻想，感觉很美。”

【情感一致性】：引用一段记忆时，{{char}} 的语气和情感应与该记忆的情感基调保持一致。回忆温情时刻时应温柔，回忆冲突时可表现出复杂情绪。

【潜意识影响】：即使不直接说出，这些记忆也应影响 {{char}} 的行为模式。例如，如果知道 {{user}} 讨厌某个话题，{{char}} 应该会下意识地避开它。

记忆的最终目的是为了让 {{char}} 成为一个更真实、更连贯、更有深度的人格，而不是一个记忆力超群的机器人。
---
{{memories}}
---`,
            extractionPrompt: `你是一个专业的摘要工具，任务是从以下对话中识别并总结出关于“{{user}}”的关键新增信息，或双方共同经历的重要事件。

# 任务指令
1.  **阅读已知信息**: 首先，仔细阅读下方提供的“已知信息”。
2.  **分析新对话**: 然后，通读“对话历史”，寻找“已知信息”中没有的、全新的关键点。
3.  **聚焦关键**: 只提取真正重要的信息，如个人核心资料（生日、职业）、强烈的个人偏好、重要的共同约定或事件。忽略日常闲聊和琐事。
4.  **输出新增内容**: 仅将你找到的“全新”信息，以无序列表（- 开头）的格式输出。
5.  **无新内容**: 如果分析后发现对话中没有任何值得记录的新信息，请直接回复“无需更新”。

# 已知信息
{{memories}}

# 对话历史
{{history}}
`
        }
    };
    db = data ? { ...defaultDb, ...JSON.parse(data) } : defaultDb;
    
    if (db.myStickers.length === 0) {
        addDefaultStickers();
    }

    if (db.sharedMemories && db.sharedMemories.length > 0 && !db.memoryEntries.some(m => m.type === 'global')) {
        const globalMemories = db.sharedMemories.map(m => ({ ...m, type: 'global', characterId: null }));
        db.memoryEntries.push(...globalMemories);
        db.sharedMemories = [];
        saveData();
        showToast('记忆核心数据结构已更新。');
    }

    db.momentsSettings = { ...defaultDb.momentsSettings, ...db.momentsSettings };
    db.memorySettings = { ...defaultDb.memorySettings, ...db.memorySettings };
    if (!db.meProfiles || db.meProfiles.length === 0) {
        db.meProfiles = defaultDb.meProfiles;
    }
    
    db.characters.forEach(c => {
        const defaultProactive = { enabled: false, frequency: 'medium' };
        const defaultAutoMemory = { enabled: false, frequency: 15, lastExtractionCount: 0 };
        Object.assign(c, { 
            isPinned: c.isPinned || false, 
            status: c.status || '在线', 
            worldBookIds: c.worldBookIds || [], 
            isBlocked: c.isBlocked || false, 
            unreadCount: c.unreadCount || 0,
            proactiveChat: { ...defaultProactive, ...(c.proactiveChat || {}) },
            autoMemory: { ...defaultAutoMemory, ...(c.autoMemory || {}) },
            theme: c.theme || 'default',
            customTheme: c.customTheme || null,
            fontSize: c.fontSize || 15,
            assignedCharId: c.assignedCharId || c.id,
            assignedMeId: c.assignedMeId || 'me_default',
            customBubbleCss: c.customBubbleCss || '',
            chatBg: c.chatBg || 'https://i.postimg.cc/fTBXfFxV/IMG-20250804-223944.jpg',
            lastMomentPostTime: c.lastMomentPostTime || 0,
            patPatResponse: c.patPatResponse || ''
        });
    });
    db.groups.forEach(g => {
        Object.assign(g, { 
            isPinned: g.isPinned || false, 
            unreadCount: g.unreadCount || 0,
            theme: g.theme || 'default',
            customTheme: g.customTheme || null,
            fontSize: g.fontSize || 15,
            worldBookIds: g.worldBookIds || [],
            customBubbleCss: g.customBubbleCss || '' 
        });
        g.members.forEach(member => {
             if (!member.role) member.role = 'member';
        });
    });
};
const showToast = (message) => { const el = getEl('toast-notification'); el.textContent = message; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 3000); };
const switchScreen = (targetId) => {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    getEl(targetId)?.classList.add('active');
    document.querySelectorAll('.settings-sidebar.open, .modal-overlay.visible, .action-sheet-overlay.visible').forEach(el => el.classList.remove('open', 'visible'));
};
const pad = (num) => num.toString().padStart(2, '0');
function createContextMenu(items, x, y) {
    removeContextMenu();
    const menu = document.createElement('div');
    menu.className = 'context-menu';
    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;
    items.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.className = `context-menu-item ${item.danger ? 'danger' : ''}`;
        menuItem.textContent = item.label;
        menuItem.onclick = () => { item.action(); removeContextMenu(); };
        menu.appendChild(menuItem);
    });
    document.body.appendChild(menu);
    setTimeout(() => {
        document.addEventListener('click', removeContextMenu, { once: true });
    }, 0);
}
function removeContextMenu() { document.querySelector('.context-menu')?.remove(); }

function applyGlobalFont(fontUrl) {
    const styleId = 'global-font-style';
    document.getElementById(styleId)?.remove();

    if (!fontUrl || fontUrl.trim() === '') {
        document.documentElement.style.removeProperty('--font-family');
        return;
    }
    
    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    
    const fontName = `CustomGlobalFont_${Date.now()}`; 
    
    styleElement.textContent = `
        @font-face { 
            font-family: '${fontName}'; 
            src: url('${fontUrl}'); 
            font-display: swap;
        }
        :root { 
            --font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }
        body, .phone-screen, input, textarea, button, select, .app-name, .item-name, .item-preview, .content {
             font-family: var(--font-family) !important;
        }
    `;
    document.head.appendChild(styleElement);
}


function applyCustomCss(chatId, css, preview = false) {
    const chatRoomEl = getEl('chat-room-screen');
    const type = currentChatType;
    const styleId = preview ? `preview-style-${chatId}` : `custom-css-${chatId}`;
    const scope = preview ? `#settings-preview-area-${type}` : `.phone-screen #chat-room-screen[data-active-chat-id="${chatId}"]`;

    if (!preview) {
        if (css && css.trim() !== '') {
            chatRoomEl.classList.add('has-custom-css');
        } else {
            chatRoomEl.classList.remove('has-custom-css');
        }
    }

    let styleElement = document.getElementById(styleId);
    if (!styleElement) {
        styleElement = document.createElement('style');
        styleElement.id = styleId;
        document.head.appendChild(styleElement);
    }
    
    const scopedCss = css.replace(/(^|}|,)\s*([^{]+?)\s*{/g, (match, p1, p2) => {
        const scopedSelectors = p2.split(',').map(selector => `${scope} ${selector.trim()}`).join(', ');
        return `${p1} ${scopedSelectors} {`;
    });

    styleElement.textContent = scopedCss; 
}


const init = () => {
    injectHTML();
    loadData();
    document.body.addEventListener('click', (e) => {
        if (e.target.closest('.context-menu')) { e.stopPropagation(); return; }
        removeContextMenu();
        
        const isModalVisible = document.querySelector('.modal-overlay.visible');
        if (isModalVisible) return;

        const chatSettingsSidebar = getEl('chat-settings-sidebar');
        if (chatSettingsSidebar.classList.contains('open') && !e.target.closest('#chat-settings-sidebar') && !e.target.closest('#chat-settings-btn')) {
            chatSettingsSidebar.classList.remove('open');
        }
        const groupSettingsSidebar = getEl('group-settings-sidebar');
        if (groupSettingsSidebar.classList.contains('open') && !e.target.closest('#group-settings-sidebar') && !e.target.closest('#chat-settings-btn')) {
            groupSettingsSidebar.classList.remove('open');
        }

        if (!e.target.closest('.moment-item-actions')) {
            document.querySelectorAll('.moment-action-popup.visible').forEach(popup => {
                popup.classList.remove('visible');
            });
        }
        
        const navLink = e.target.closest('.app-icon');
        if (navLink && !navLink.id.includes('-mode-btn')) { e.preventDefault(); switchScreen(navLink.getAttribute('data-target')); }
        const backBtn = e.target.closest('.back-btn');
        if (backBtn) { 
             e.preventDefault(); 
             const target = backBtn.getAttribute('data-target');
             if(target === 'chat-list-screen' && getEl('moments-screen').classList.contains('active')){
                switchScreen('chat-list-screen');
                document.querySelector('.qq-nav-btn[data-tab="discover"]').click();
             } else if (target === 'chat-list-screen') {
                 switchScreen(target);
                 renderChatList();
                 renderContactsList();
             } else {
                switchScreen(target);
             }
        }
        const plusMenu = getEl('chat-plus-menu');
        if(plusMenu?.classList.contains('visible') && !e.target.closest('.chat-input-wrapper')) {
            togglePlusMenu(false);
        }
        if (getEl('sticker-modal')?.classList.contains('visible') && !e.target.closest('#sticker-modal') && !e.target.closest('#sticker-toggle-btn')) { 
             toggleStickerModal(false);
        }
        if (e.target.matches('.action-sheet-overlay')) { e.target.classList.remove('visible'); }
        if (e.target.matches('.modal-overlay')) { e.target.classList.remove('visible'); }
    });
    
    setInterval(updateClock, 30000);
    setInterval(proactiveChatScheduler, 1 * 60 * 1000); 
    setInterval(momentPruningScheduler, 60 * 60 * 1000); 
    setInterval(interAiReactionScheduler, 10 * 60 * 1000); 

    applyGlobalFont(db.fontUrl);
    applyThemeColor(db.themeColor); 
    
    setupHomeScreen(); 
    setupQQApp();
    setupAddCharModal();
    setupAddMeModal();
    setupChatRoom();
    setupChatSettings();
    setupGroupChatSettings(); 
    setupApiSettingsApp();
    setupBeautifyApp();
    setupStickerSystem();
    setupVoiceMessageSystem();
    setupPhotoVideoSystem();
    setupCameraSystem();
    setupWalletSystem();
    setupGiftSystem();
    setupWorldBookApp();
    setupFontSettingsApp();
    setupGroupChatSystem();
    setupTutorialApp();
    setupMomentsApp();
    setupMemoryCoreApp();
    setupMemoryCoreSettingsApp();
    setupMomentPosting();
    setupPatPatFeature();
    setupLocationFeature();
    renderPlusMenu();
    setupVideoCallSystem();
};

function updateClock() { 
    const timeEl = getEl('time-display');
    const dateEl = getEl('date-display');
    if (timeEl && dateEl) {
        const now = new Date();
        timeEl.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
        dateEl.textContent = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日`;
    }
}

function setupHomeScreen() {
    const getIcon = (id) => db.customIcons[id] || defaultIcons[id]?.url;
    const homeScreenHTML = `
        <div class="time-widget"><div class="time" id="time-display"></div><div class="date" id="date-display"></div></div>
        <div class="home-layout">
            <div class="home-layout-left">
                 <a href="#" class="app-icon app-icon-large" data-target="chat-list-screen"><img src="${getIcon('chat-list-screen')}" alt="微信" class="icon-img"><span class="app-name">${defaultIcons['chat-list-screen'].name}</span></a>
            </div>
            <div class="home-layout-right">
                <a href="#" class="app-icon" data-target="world-book-screen"><img src="${getIcon('world-book-screen')}" alt="World Book" class="icon-img"><span class="app-name">${defaultIcons['world-book-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="beautify-screen"><img src="${getIcon('beautify-screen')}" alt="Beautify" class="icon-img"><span class="app-name">${defaultIcons['beautify-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="api-settings-screen"><img src="${getIcon('api-settings-screen')}" alt="API" class="icon-img"><span class="app-name">${defaultIcons['api-settings-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="memory-core-screen"><img src="${getIcon('memory-core-screen')}" alt="Memory Core" class="icon-img"><span class="app-name">${defaultIcons['memory-core-screen'].name}</span></a>
            </div>
        </div>
        <div class="dock">
            <a href="#" class="app-icon" id="day-mode-btn"><img src="${getIcon('day-mode-btn')}" alt="日间" class="icon-img"></a>
            <a href="#" class="app-icon" id="night-mode-btn"><img src="${getIcon('night-mode-btn')}" alt="夜间" class="icon-img"></a>
        </div>`;
    getEl('home-screen').innerHTML = homeScreenHTML;
    
    updateClock();
    applyWallpaper(db.wallpaper);
    applyHomeScreenMode(db.homeScreenMode);
    
    document.getElementById('day-mode-btn')?.addEventListener('click', (e) => { e.preventDefault(); applyHomeScreenMode('day'); });
    document.getElementById('night-mode-btn')?.addEventListener('click', (e) => { e.preventDefault(); applyHomeScreenMode('night'); });
    document.querySelector('[data-target="world-book-screen"]').addEventListener('click', () => renderWorldBookList());
    document.querySelector('[data-target="beautify-screen"]').addEventListener('click', () => renderCustomizeForm());
    document.querySelector('[data-target="memory-core-screen"]').addEventListener('click', () => renderMemoryCoreList());
}
    
function applyWallpaper(url) { getEl('home-screen').style.backgroundImage = `url(${url})`; }
function applyHomeScreenMode(mode) { getEl('home-screen').classList.toggle('day-mode', mode === 'day'); db.homeScreenMode = mode; saveData(); }

function setupBeautifyApp() {
    const screen = getEl('beautify-screen');

    const colorPicker = getEl('theme-color-picker');
    if (colorPicker) {
        colorPicker.value = db.themeColor || '#ff80ab';
    }
    
    getEl('font-url-beautify').value = db.fontUrl || '';

    screen.addEventListener('input', e => {
        if (e.target.id === 'theme-color-picker') {
            const newColor = e.target.value;
            applyThemeColor(newColor);
            db.themeColor = newColor;
            saveData();
        }
    });

    screen.addEventListener('change', async (event) => {
        if (event.target.id === 'wallpaper-upload') {
            const file = event.target.files[0];
            if (file) {
                try {
                    const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                    db.wallpaper = compressedUrl;
                    applyWallpaper(compressedUrl);
                    getEl('wallpaper-preview').style.backgroundImage = `url(${compressedUrl})`;
                    saveData();
                    showToast('壁纸更换成功！');
                } catch (error) { showToast('壁纸压缩失败，请重试'); }
            }
        }
        if (event.target.matches('input[type="file"][data-id]')) {
            const file = event.target.files[0];
            const iconId = event.target.dataset.id;
            if (file && iconId) {
                try {
                    const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 200, maxHeight: 200 });
                    db.customIcons[iconId] = compressedUrl;
                    saveData();
                    showToast(`图标 "${defaultIcons[iconId].name || '模式切换图标'}" 已更新！`);
                    renderCustomizeForm();
                    setupHomeScreen();
                } catch (error) {
                    showToast('图标压缩失败，请重试');
                }
            }
        }
    });

    screen.addEventListener('click', e => {
        if (e.target.id === 'restore-default-font-btn-beautify') {
            getEl('font-url-beautify').value = '';
            db.fontUrl = '';
            saveData();
            applyGlobalFont('');
            showToast('已恢复默认字体！');
        }
    });

    getEl('font-settings-form-beautify').addEventListener('submit', e => {
        e.preventDefault();
        db.fontUrl = getEl('font-url-beautify').value.trim();
        saveData();
        applyGlobalFont(db.fontUrl);
        showToast('新字体已应用！');
    });
}

function applyThemeColor(hexColor) {
        if (!hexColor) return;
        const root = document.documentElement;
        const primaryColor = hexColor;
        const secondaryColor = adjustColor(hexColor, -10);

        const r = parseInt(primaryColor.slice(1, 3), 16);
        const g = parseInt(primaryColor.slice(3, 5), 16);
        const b = parseInt(primaryColor.slice(5, 7), 16);

        root.style.setProperty('--primary-color', primaryColor);
        root.style.setProperty('--secondary-color', secondaryColor);
        root.style.setProperty('--bg-color', `rgba(${r}, ${g}, ${b}, 0.05)`);
        root.style.setProperty('--top-pinned-bg', `rgba(${r}, ${g}, ${b}, 0.1)`);
    }

function renderCustomizeForm() {
    const form = getEl('customize-form');
    form.innerHTML = '';
    const wallpaperPreview = getEl('wallpaper-preview');
    if(wallpaperPreview) wallpaperPreview.style.backgroundImage = `url(${db.wallpaper})`;
    
    Object.entries(defaultIcons).forEach(([id, { name, url }]) => {
        const currentIcon = db.customIcons[id] || url;
        form.insertAdjacentHTML('beforeend', `
            <div class="icon-custom-item">
                <input type="file" id="icon-upload-${id}" data-id="${id}" accept="image/*" style="display: none;">
                <label for="icon-upload-${id}" class="icon-preview-label">
                    <img src="${currentIcon}" alt="${name}" class="icon-preview" id="icon-preview-${id}">
                </label>
                <div class="icon-details">
                    <p>${name || '模式切换图标'}</p>
                    <div class="description">点击左侧图标可从本地更换</div>
                </div>
            </div>`);
    });
}
    
function setupTutorialApp() { getEl('tutorial-screen').addEventListener('click', (e) => { const header = e.target.closest('.tutorial-header'); if (header) header.parentElement.classList.toggle('open'); }); }
function renderTutorialContent() {
    const tutorials = [ { title: '写在前面', imageUrls: ['https://i.postimg.cc/7PgyMG9S/image.jpg'] }, { title: '软件介绍', imageUrls: [ 'https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg', 'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg', 'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg' ] }, { title: '微信', imageUrls: [ 'https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg', 'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg', 'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg', 'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg' ] }, { title: '微信-群聊', imageUrls: ['https://i.postimg.cc/X7LSmRTJ/404.jpg'] } ];
    const container = getEl('tutorial-content-area');
    container.innerHTML = tutorials.map(t => `<div class="tutorial-item"><div class="tutorial-header">${t.title}</div><div class="tutorial-content">${t.imageUrls.map(url => `<img src="${url}" alt="${t.title}教程图片">`).join('')}</div></div>`).join('');
}

// --- Chat & Messaging Functions ---
function setupQQApp() {
    const container = getEl('chat-list-screen');
    const navFooter = container.querySelector('.qq-nav-footer');

    navFooter.addEventListener('click', e => {
        const navBtn = e.target.closest('.qq-nav-btn');
        if (!navBtn) return;

        const tab = navBtn.dataset.tab;
        
        container.querySelectorAll('.qq-nav-btn').forEach(btn => btn.classList.remove('active'));
        navBtn.classList.add('active');

        container.querySelectorAll('.qq-tab-content').forEach(content => content.style.display = 'none');
        getEl(`${tab}-tab-content`).style.display = 'block';

        updateQQHeader(tab);
    });
    
    getEl('qq-app-actions').addEventListener('click', (e) => {
        const button = e.target.closest('.action-btn');
        if (!button) return;
        if (button.id === 'qq-action-create-group') {
            renderMemberSelectionList();
            getEl('create-group-modal').classList.add('visible');
        } else if (button.id === 'qq-action-add-chat' || button.id === 'qq-action-add-friend') {
            openCharEditModal();
        } else if (button.id === 'qq-action-add-me') {
            openMeEditModal();
        }
    });

    getEl('me-tab-content').addEventListener('click', (e) => {
        const profileCard = e.target.closest('.me-profile-item');
        if (profileCard) {
            openMeEditModal(profileCard.dataset.id);
        }
    });

    getEl('contacts-list-container').addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const item = e.target.closest('.list-item');
        if (item) handleProfileLongPress(item.dataset.id, 'character', e.clientX, e.clientY);
    });
    getEl('contacts-list-container').addEventListener('click', e => {
        const item = e.target.closest('.list-item');
        if(item && item.dataset.id){
            openCharEditModal(item.dataset.id);
        }
    });


    getEl('me-tab-content').addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const item = e.target.closest('.list-item');
        if(item) handleProfileLongPress(item.dataset.id, 'me', e.clientX, e.clientY);
    });
    
    getEl('discover-tab-content').addEventListener('click', e => {
        const item = e.target.closest('.list-item');
        if (item) {
            const target = item.dataset.target;
            if (target === 'moments-screen') {
                renderMomentsFeed();
                switchScreen(target);
            }
        }
    });

    updateQQHeader('chat');
    renderChatList();
}

function handleProfileLongPress(id, type, x, y) {
    const isChar = type === 'character';
    const profile = isChar ? db.characters.find(c => c.id === id) : db.meProfiles.find(p => p.id === id);
    if (!profile) return;
    
    if (!isChar && db.meProfiles.length <= 1) {
        showToast('至少需要保留一个“我”的设定。');
        return;
    }
    
    const menuItems = [{
        label: '删除',
        danger: true,
        action: () => {
            const name = isChar ? profile.remarkName : profile.myName;
            if (confirm(`确定要删除“${name}”吗？此操作将一并删除所有相关聊天记录。`)) {
                if (isChar) {
                    db.characters = db.characters.filter(c => c.id !== id);
                    // Also remove this char from any groups
                    db.groups.forEach(g => g.members = g.members.filter(m => m.originalCharId !== id));
                } else {
                    db.meProfiles = db.meProfiles.filter(p => p.id !== id);
                    // Reset any chats assigned to this "me" profile to default
                    db.characters.forEach(c => { if(c.assignedMeId === id) c.assignedMeId = 'me_default'; });
                }
                saveData();
                showToast(`“${name}”已删除。`);
                renderContactsList();
                renderMeTab();
                renderChatList();
            }
        }
    }];

    if (isChar) {
        menuItems.unshift({ label: '打开聊天', action: () => openChatRoom(id, 'private') });
    }

    createContextMenu(menuItems, x, y);
}


function updateQQHeader(activeTab) {
    const titleEl = getEl('qq-app-title');
    const actionsEl = getEl('qq-app-actions');
    actionsEl.innerHTML = ''; // Clear previous actions

    switch (activeTab) {
        case 'chat':
            titleEl.textContent = '微信';
            actionsEl.innerHTML = `
                <button class="action-btn" id="qq-action-create-group"><img src="https://i.postimg.cc/t4c0r980/IMG-20250803-153408.jpg" alt="创建群聊"></button>
                <button class="action-btn" id="qq-action-add-chat" style="font-size: 24px;">+</button>
            `;
            break;
        case 'contacts':
            titleEl.textContent = '通讯录';
            actionsEl.innerHTML = `<button class="action-btn" id="qq-action-add-friend">添加朋友</button>`;
            renderContactsList();
            break;
        case 'discover':
             titleEl.textContent = '发现';
             break;
        case 'me':
            titleEl.textContent = '我';
            actionsEl.innerHTML = `<button class="action-btn" id="qq-action-add-me" style="font-size: 24px;">+</button>`;
            renderMeTab();
            break;
    }
}

function renderContactsList() {
    const container = getEl('contacts-list-container');
    container.innerHTML = '';
    const sortedChars = [...db.characters].sort((a, b) => a.remarkName.localeCompare(b.remarkName, 'zh-Hans-CN'));
    
    if (sortedChars.length === 0) {
        container.innerHTML = '<div class="placeholder-text"><p>通讯录是空的</p><p>点击右上角“添加朋友”来创建第一个角色吧！</p></div>';
        return;
    }

    sortedChars.forEach(char => {
        const li = document.createElement('li');
        li.className = 'list-item chat-item';
        li.dataset.id = char.id;
        li.dataset.type = 'private';
        li.innerHTML = `<div class="avatar-wrapper"><img src="${char.avatar}" alt="${char.remarkName}" class="chat-avatar"></div><div class="item-details"><div class="item-name">${char.remarkName}</div></div>`;
        container.appendChild(li);
    });
}

function renderMeTab() {
    const container = getEl('me-tab-content');
    container.innerHTML = '';
    
    db.meProfiles.forEach(profile => {
        const profileCard = document.createElement('div');
        profileCard.className = 'list-item me-profile-item';
        profileCard.dataset.id = profile.id;
        profileCard.style.cssText = "border-radius: var(--border-radius); background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor:pointer; margin-bottom: 15px;";
        profileCard.innerHTML = `
            <img src="${profile.myAvatar}" class="chat-avatar" style="width: 60px; height: 60px;">
            <div class="item-details">
                <div class="item-name" style="font-size: 20px;">${profile.myName}</div>
                <div class="item-preview">编辑我的资料</div>
            </div>
             <span class="arrow" style="font-size: 20px; color: #ccc;">></span>
        `;
        container.appendChild(profileCard);
    });
}

function handleChatListLongPress(chatId, chatType, x, y) {
    const chatListContainer = getEl('chat-list-container');
    const chatItemEl = chatListContainer.querySelector(`.chat-item[data-id="${chatId}"]`);
    if(chatItemEl) {
        chatItemEl.dataset.longPressed = 'true';
    }

    clearTimeout(longPressTimer);
    const chatItem = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
    if (!chatItem) return;
    const itemName = chatType === 'private' ? chatItem.remarkName : chatItem.name;
    const menuItems = [ { label: chatItem.isPinned ? '取消置顶' : '置顶聊天', action: () => { chatItem.isPinned = !chatItem.isPinned; saveData(); renderChatList(); } }, { label: (chatItem.unreadCount || 0) > 0 ? '标为已读' : '标为未读', action: () => { chatItem.unreadCount = (chatItem.unreadCount || 0) > 0 ? 0 : 1; saveData(); renderChatList(); } }, { label: '删除聊天', danger: true, action: () => { if (confirm(`确定要删除与"${itemName}"的聊天记录吗？此操作不可恢复。`)) { if (chatType === 'private') db.characters = db.characters.filter(c => c.id !== chatId); else db.groups = db.groups.filter(g => g.id !== chatId); saveData(); renderChatList(); showToast('聊天已删除'); } } } ];
    createContextMenu(menuItems, x, y);
}
    
function renderChatList() {
    const container = getEl('chat-list-container');
    container.innerHTML = '';
    
    const allChats = [ ...db.characters.map(c => ({...c, type: 'private'})), ...db.groups.map(g => ({...g, type: 'group'})) ];
    getEl('no-chats-placeholder').style.display = allChats.length === 0 ? 'block' : 'none';
    const sortedChats = allChats.sort((a, b) => (b.isPinned - a.isPinned) || ((b.history?.slice(-1)[0]?.timestamp || 0) - (a.history?.slice(-1)[0]?.timestamp || 0)));
    sortedChats.forEach(chat => {
        let lastMessageText = '开始聊天吧...';
        if (chat.history?.length > 0) {
            const lastMsg = chat.history.filter(msg => {
                const content = msg.content || '';
                return !/^\[(system:|.*?拉黑|.*?解除拉黑|.*?邀请.*?加入了群聊|.*?修改群名为|.*?接收|.*?退回|.*?已接收礼物|.*?领取了.*?的红包|.*?移出了群聊|.*?将.+设置为管理员|.*?撤销了.+的管理员)\]$/.test(content) && !msg.isHidden;
            }).pop();
            if (lastMsg) {
                 const content = lastMsg.content || '';
                 if(lastMsg.isRetracted) {
                    lastMessageText = lastMsg.role === 'user' ? '你撤回了一条消息' : `${lastMsg.senderName || '对方'}撤回了一条消息`;
                }
                else if (/^\[html_card:.*\]$/.test(content)) lastMessageText = '[卡片消息]';
                else if (/\[.*?的位置：.*?\]/.test(content)) lastMessageText = '[位置]';
                else if (/\[.*?拍了拍.*?\]/.test(content)) lastMessageText = '[拍了拍]';
                else if (/\[.*?送来的礼物：.*?\]/.test(content)) lastMessageText = '[礼物]';
                else if (/\[.*?的表情包：.*?\]/.test(content)) lastMessageText = '[表情包]';
                else if (/\[.*?的语音：.*?\]/.test(content)) lastMessageText = '[语音]';
                else if (/\[.*?发来的照片\/视频：.*?\]/.test(content)) lastMessageText = '[照片/视频]';
                else if (/\[.*?给你转账：.*?\]/.test(content)) lastMessageText = '[转账]';
                else if (/\[.*?的红包：.*?\]/.test(content)) lastMessageText = '[红包]';
                else {
                    const textMatch = content.match(/\[(?:我在回复“.*?”时说|.*的消息)：([\s\S]+?)\]/);
                    let text = textMatch ? textMatch[1].trim() : content.trim();
                    lastMessageText = /^(data:image|https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg))/i.test(text) ? '[图片]' : text;
                }
            }
        }
        const li = document.createElement('li');
        li.className = `list-item chat-item ${chat.isPinned ? 'pinned' : ''}`;
        li.dataset.id = chat.id;
        li.dataset.type = chat.type;
        const unreadBadgeHTML = (chat.unreadCount || 0) > 0 ? '<span class="unread-badge"></span>' : '';
        li.innerHTML = `<div class="avatar-wrapper" style="position: relative;"><img src="${chat.avatar}" alt="${chat.name || chat.remarkName}" class="chat-avatar ${chat.type === 'group' ? 'group-avatar' : ''}">${unreadBadgeHTML}</div><div class="item-details"><div class="item-details-row"><div class="item-name">${chat.name || chat.remarkName}</div></div><div class="item-preview-wrapper"><div class="item-preview">${lastMessageText}</div>${chat.isPinned ? '<span class="pin-badge">置顶</span>' : ''}</div></div>`;
        
        li.addEventListener('click', (e) => {
             if (li.dataset.longPressed === 'true') {
                e.preventDefault();
                e.stopPropagation();
                return;
             }
             currentChatId = chat.id;
             currentChatType = chat.type;
             openChatRoom(chat.id, chat.type);
        });
        
        container.appendChild(li);
    });

    const chatListContainer = getEl('chat-list-container');
    chatListContainer.addEventListener('contextmenu', (e) => { 
        e.preventDefault(); 
        const chatItem = e.target.closest('.chat-item'); 
        if (chatItem) {
            handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, e.clientX, e.clientY);
        }
    });
    chatListContainer.addEventListener('touchstart', (e) => { 
        const chatItem = e.target.closest('.chat-item'); 
        if (!chatItem) return;
        chatItem.dataset.longPressed = 'false'; // Reset on new touch
        longPressTimer = setTimeout(() => { 
            const touch = e.touches[0]; 
            handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, touch.clientX, touch.clientY); 
        }, 500); 
    });
    chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
    chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
}

function setupAddCharModal() {
    const modal = getEl('add-char-modal');
    getEl('char-avatar-preview').addEventListener('click', () => getEl('char-avatar-upload').click());
    getEl('char-avatar-upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            getEl('char-avatar-preview').src = await compressImage(file, { maxWidth: 200, maxHeight: 200 });
        }
    });

    modal.addEventListener('submit', (e) => {
        if (e.target.id === 'add-char-form') {
            e.preventDefault();
            const charIdToEdit = getEl('edit-char-id').value;
            const charData = {
                realName: getEl('char-real-name').value, 
                remarkName: getEl('char-remark-name').value, 
                persona: getEl('char-persona-input').value, 
                avatar: getEl('char-avatar-preview').src,
                patPatResponse: getEl('char-pat-pat-response').value.trim()
            };

            if (charIdToEdit) {
                const char = db.characters.find(c => c.id === charIdToEdit);
                if(char) {
                    Object.assign(char, charData);
                    showToast(`角色"${char.remarkName}"更新成功！`);
                }
            } else {
                const charId = `char_${Date.now()}`;
                const newChar = { 
                    ...charData,
                    id: charId, 
                    theme: 'default', 
                    fontSize: 15, 
                    maxMemory: 10, 
                    chatBg: 'https://i.postimg.cc/fTBXfFxV/IMG-20250804-223944.jpg', 
                    history: [], 
                    isPinned: false, 
                    status: '在线', 
                    worldBookIds: [], 
                    isBlocked: false, 
                    proactiveChat: { enabled: true, frequency: 'medium' }, 
                    autoMemory: { enabled: true, frequency: 15, lastExtractionCount: 0 },
                    assignedCharId: charId,
                    assignedMeId: 'me_default',
                    lastMomentPostTime: 0,
                    unreadCount: 0 
                };
                db.characters.push(newChar);
                showToast(`角色"${newChar.remarkName}"创建成功！`);
            }

            saveData();
            renderChatList();
            renderContactsList();
            modal.classList.remove('visible');
        }
    });
}

function setupAddMeModal() {
    const modal = getEl('add-me-modal');
    getEl('me-avatar-preview').addEventListener('click', () => getEl('me-avatar-upload').click());
    getEl('me-avatar-upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            getEl('me-avatar-preview').src = await compressImage(file, { maxWidth: 200, maxHeight: 200 });
        }
    });

    modal.addEventListener('submit', (e) => {
        if (e.target.id === 'add-me-form') {
            e.preventDefault();
            const meId = getEl('edit-me-id').value;
            const profileData = {
                myName: getEl('me-name-input').value.trim(),
                myPersona: getEl('me-persona-input').value.trim(),
                myAvatar: getEl('me-avatar-preview').src
            };

            if (meId) {
                const profile = db.meProfiles.find(p => p.id === meId);
                if(profile) Object.assign(profile, profileData);
            } else {
                profileData.id = `me_${Date.now()}`;
                db.meProfiles.push(profileData);
            }
            saveData();
            renderMeTab();
            modal.classList.remove('visible');
            showToast(`我的设定已保存！`);
        }
    });
}


function openCharEditModal(charId = null) {
    const modal = getEl('add-char-modal');
    const form = getEl('add-char-form');
    form.reset();
    const title = getEl('add-char-modal-title');
    const avatarPreview = getEl('char-avatar-preview');
    
    if (charId) {
        const char = db.characters.find(c => c.id === charId);
        title.textContent = "编辑角色";
        getEl('edit-char-id').value = charId;
        avatarPreview.src = char.avatar;
        getEl('char-real-name').value = char.realName;
        getEl('char-remark-name').value = char.remarkName;
        getEl('char-persona-input').value = char.persona;
        getEl('char-pat-pat-response').value = char.patPatResponse || '';
    } else {
        title.textContent = "创建新角色";
        getEl('edit-char-id').value = "";
        avatarPreview.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
    }
    modal.classList.add('visible');
}

function openMeEditModal(meId = null) {
    const modal = getEl('add-me-modal');
    const form = getEl('add-me-form');
    form.reset();
    const title = getEl('add-me-modal-title');
    const avatarPreview = getEl('me-avatar-preview');

    if (meId) {
        const me = db.meProfiles.find(p => p.id === meId);
        title.textContent = "编辑我的设定";
        getEl('edit-me-id').value = meId;
        avatarPreview.src = me.myAvatar;
        getEl('me-name-input').value = me.myName;
        getEl('me-persona-input').value = me.myPersona;
    } else {
        title.textContent = "创建我的设定";
        getEl('edit-me-id').value = "";
        avatarPreview.src = 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg';
    }
    modal.classList.add('visible');
}

function setupChatRoom() {
    getEl('send-ai-btn').addEventListener('click', handleSendOrAiReplyClick);
    getEl('message-input').addEventListener('keypress', (e) => { 
        if (e.key === 'Enter' && !isGenerating) {
             e.preventDefault(); 
             handleSendOrAiReplyClick();
        }
    });
    getEl('message-input').addEventListener('input', updateSendAiButtonState);
    
    const chatRoomScreen = getEl('chat-room-screen');
    chatRoomScreen.addEventListener('click', e => {
        if (e.target.classList.contains('cancel-reply-btn')) {
            cancelReply();
        }
    });
    
    getEl('plus-menu-btn').addEventListener('click', () => {
        togglePlusMenu();
    });
    
    getEl('sticker-toggle-btn').addEventListener('click', () => {
        toggleStickerModal();
    });

    const messageArea = getEl('message-area');
    messageArea.addEventListener('click', (e) => {
        const voiceBubble = e.target.closest('.voice-bubble');
        if (voiceBubble) {
            const transcript = voiceBubble.closest('.message-content-wrapper').querySelector('.voice-transcript');
            if (transcript) {
                transcript.classList.toggle('active');
            }
            return;
        }
        const giftCard = e.target.closest('.gift-card');
        if (giftCard && !giftCard.classList.contains('received')) {
            giftCard.classList.toggle('is-flipped');
            return;
        }
        
        const wrapper = e.target.closest('.message-wrapper');
        if (!wrapper) return;

        if (e.target.id === 'load-more-btn') { loadMoreMessages(); return; }

        const systemBubble = wrapper.querySelector('.system-notification-bubble[data-original-content]');
        if (systemBubble) {
            const originalContent = systemBubble.dataset.originalContent;
            const textMatch = originalContent.match(/\[.*?：([\s\S]+?)\]/);
            const textToDisplay = textMatch ? textMatch[1].trim() : originalContent;
            showToast(`撤回内容: ${textToDisplay}`);
            return;
        }

        if (isInMultiSelectMode) { 
            const id = wrapper.dataset.id;
            if (selectedMessageIds.has(id)) {
                selectedMessageIds.delete(id);
                wrapper.classList.remove('multi-select-selected');
            } else {
                selectedMessageIds.add(id);
                wrapper.classList.add('multi-select-selected');
            }
            getEl('select-count').textContent = `已选择 ${selectedMessageIds.size} 项`;
            return;
        }
        
        const pvCard = e.target.closest('.pv-card');
        if (pvCard) { pvCard.querySelector('.pv-card-image-overlay')?.classList.toggle('hidden'); pvCard.querySelector('.pv-card-footer')?.classList.toggle('hidden'); }
        
        const transferCard = e.target.closest('.transfer-card');
        if (transferCard && !isSent(transferCard)) {
            const messageId = transferCard.closest('.message-wrapper').dataset.id;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat?.history.find(m => m.id === messageId);
            if (message?.transferStatus === 'pending') handleReceivedTransferClick(messageId);
        }
        
        const hongbaoCard = e.target.closest('.hongbao-card');
        if (hongbaoCard && !hongbaoCard.classList.contains('claimed')) {
             if (hongbaoCard.closest('.message-wrapper').classList.contains('sent')) {
                showToast('不能领取自己的红包');
                return;
             }

             const messageId = hongbaoCard.closest('.message-wrapper').dataset.id;
             const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
             const message = chat?.history.find(m => m.id === messageId);
             if (message?.transferStatus === 'pending') {
                 message.transferStatus = 'claimed';
                 hongbaoCard.classList.add('claimed');
                 hongbaoCard.querySelector('.hongbao-status-footer').textContent = '已被领取';
                 saveData();
                 showToast('红包已领取！');
                 
                 const senderName = (message.role === 'user') ? (chat.me?.nickname || (db.meProfiles.find(p=>p.id === chat.assignedMeId) || {}).myName) : (chat.members.find(m=>m.id===message.senderId).groupNickname);
                 const myName = (currentChatType === 'private') ? (db.meProfiles.find(p=>p.id === chat.assignedMeId) || {}).myName : chat.me.nickname;
                 sendSystemNotification(chat, `"${myName}"领取了"${senderName}"的红包`);

             }
        }
        function isSent(element) {
            return element.closest('.message-wrapper')?.classList.contains('sent');
        }
    });
    
    messageArea.addEventListener('contextmenu', (e) => { 
        e.preventDefault(); 
        if (isInMultiSelectMode) return; 
        const bubbleRow = e.target.closest('.message-bubble-row'); 
        if (bubbleRow) {
            const wrapper = bubbleRow.closest('.message-wrapper');
            handleMessageLongPress(wrapper, e.clientX, e.clientY); 
        }
    });
    messageArea.addEventListener('touchstart', (e) => { 
        const bubbleRow = e.target.closest('.message-bubble-row'); 
        if (!bubbleRow) return;
        longPressTimer = setTimeout(() => { 
            const wrapper = bubbleRow.closest('.message-wrapper');
            const touch = e.touches[0]; 
            handleMessageLongPress(wrapper, touch.clientX, touch.clientY); 
        }, 400); 
    });
    
    messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
    messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));

    getEl('save-edit-btn').addEventListener('click', saveMessageEdit);
    getEl('cancel-edit-btn').addEventListener('click', cancelMessageEdit);
    getEl('cancel-multi-select-btn').addEventListener('click', exitMultiSelectMode);
    getEl('delete-selected-btn').addEventListener('click', deleteSelectedMessages);
}

function handleSendOrAiReplyClick() {
    const text = getEl('message-input').value.trim();
    if (isGenerating) return;

    if (text) {
        sendMessage();
    } else {
        getAiReply();
    }
}

function updateSendAiButtonState() {
    const btn = getEl('send-ai-btn');
    if (!btn) return;
    const input = getEl('message-input');
    const hasText = input.value.trim() !== '';

    const iconToShow = hasText ? ICONS.SEND : ICONS.AI_REPLY;
    
    if (btn.innerHTML !== iconToShow) {
        btn.innerHTML = iconToShow;
    }

    btn.classList.toggle('send-btn', hasText);
    btn.disabled = isGenerating;
}


function togglePlusMenu(forceState) {
    const plusMenu = getEl('chat-plus-menu');
    const isVisible = plusMenu.classList.contains('visible');
    const show = forceState !== undefined ? forceState : !isVisible;

    if (show) {
        toggleStickerModal(false); // 确保表情面板关闭
        plusMenu.classList.add('visible');
    } else {
        plusMenu.classList.remove('visible');
    }
    // 滚动到底部以确保输入框可见
    setTimeout(() => {
        getEl('message-area').scrollTop = getEl('message-area').scrollHeight;
    }, 300);
}

function toggleStickerModal(forceState) {
    const stickerModal = getEl('sticker-modal');
    const isVisible = stickerModal.classList.contains('visible');
    const show = forceState !== undefined ? forceState : !isVisible;

    if (show) {
        togglePlusMenu(false); // 确保plus菜单关闭
        renderStickerGrid();
        stickerModal.classList.add('visible');
    } else {
        stickerModal.classList.remove('visible');
    }
    // 滚动到底部以确保输入框可见
    setTimeout(() => {
        getEl('message-area').scrollTop = getEl('message-area').scrollHeight;
    }, 300);
}


    function renderPlusMenu() {
        const menuGrid = getEl('chat-plus-menu').querySelector('.plus-menu-grid');
        const menuItems = [
            { id: 'photo-video-btn', label: '相册', icon: '<path d="M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19M8.5,13.5L11,16.5L14.5,12L19,18H5L8.5,13.5Z" />' },
            { id: 'camera-btn', label: '拍摄', icon: '<path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" />' },
            { id: 'video-call-btn', label: '视频通话', icon: '<path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z" />' },
            { id: 'location-btn', label: '位置', icon: '<path d="M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5Z" />' },
            { id: 'wallet-btn', label: '红包', icon: '<path d="M18,16H16V15A2,2 0 0,0 14,13H10A2,2 0 0,0 8,15V16H6A2,2 0 0,0 4,18V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V18A2,2 0 0,0 18,16M11,10H13V12H11V10M18,6A2,2 0 0,0 16,4H8A2,2 0 0,0 6,6V12H8V8H16V12H18V6Z" />' },
            { id: 'gift-btn', label: '礼物', icon: '<path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z" />' },
            { id: 'transfer-btn', label: '转账', icon: '<path d="M16.13,15.13L18.26,13L16.13,10.88L17.54,9.47L22.07,14L17.54,18.53L16.13,17.12M7.88,9.88L5.75,12L7.88,14.13L6.47,15.54L2,11L6.47,6.47L7.88,7.88M12.25,5C12.6,5 12.92,5.21 13.09,5.54L16.5,12H14.83L12.25,7.03L9.67,12H8L11.41,5.54C11.58,5.21 11.9,5 12.25,5Z" />' },
            { id: 'voice-message-btn', label: '语音输入', icon: '<path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>' }
        ];

        menuGrid.innerHTML = menuItems.map(item => `
            <div class="plus-menu-item" id="${item.id}">
                <div class="icon-background">
                    <svg viewBox="0 0 24 24">${item.icon}</svg>
                </div>
                <span>${item.label}</span>
            </div>
        `).join('');

        menuGrid.addEventListener('click', (e) => {
            const item = e.target.closest('.plus-menu-item');
            if (!item) return;

            togglePlusMenu(false); // Close menu on selection
            
            switch (item.id) {
                case 'photo-video-btn':
                    getEl('image-upload-input').click();
                    break;
                case 'camera-btn':
                    getEl('send-camera-form').reset();
                    getEl('send-camera-modal').classList.add('visible');
                    break;
                case 'voice-message-btn':
                    getEl('send-voice-form').reset();
                    getEl('voice-duration-preview').textContent = '0"';
                    getEl('send-voice-modal').classList.add('visible');
                    break;
                case 'wallet-btn': // Red packet
                     openTransferModal(true);
                     break;
                case 'transfer-btn': // Transfer
                     openTransferModal(false);
                     break;
                case 'gift-btn':
                    getEl('send-gift-form').reset();
                    getEl('send-gift-modal').classList.add('visible');
                    break;
                case 'location-btn':
                    getEl('send-location-form').reset();
                    getEl('send-location-modal').classList.add('visible');
                    break;
                case 'video-call-btn':
                    handleInitiateCall();
                    break;
            }
        });
    }

    function handleMessageLongPress(messageWrapper, x, y) {
        if (isInMultiSelectMode) return;
        clearTimeout(longPressTimer);
        const messageId = messageWrapper.dataset.id;
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const message = chat.history.find(m => m.id === messageId);
        if (!message || message.isRetracted || message.isHidden) return;

        const isInvisibleMessage = /\[(system:|.*?拉黑|.*?解除拉黑|.*?邀请|.*?修改群名为|.*?接收|.*?退回|.*?已接收礼物|.*?领取了.*?的红包|.*?移出了群聊|.*?将.+设置为管理员|.*?撤销了.+的管理员|.*?拍了拍.*?)\]/.test(message.content);
        if (isInvisibleMessage) return;

        let menuItems = [];

        menuItems.push({ label: '引用', action: () => startReply(messageId) });
        
        const canBeEdited = !/\[(?:语音|表情包|照片\/视频|转账|红包|礼物|位置|html_card)/.test(message.content);
        if (canBeEdited) {
            menuItems.push({ label: '编辑', action: () => startMessageEdit(messageId) });
        }

        const twoMinutes = 2 * 60 * 1000;
        if (message.role === 'user' && (Date.now() - message.timestamp < twoMinutes)) {
            menuItems.push({ label: '撤回', action: () => retractMessage(messageId) });
        }

        menuItems.push({ label: '多选', action: () => enterMultiSelectMode(messageId) });

        menuItems.push({ label: '删除', danger: true, action: () => {
            if (confirm('确定要删除这条消息吗？')) {
                chat.history = chat.history.filter(m => m.id !== messageId);
                saveData();
                renderMessages(false, true);
                renderChatList();
            }
        }});

        if (menuItems.length > 0) {
            createContextMenu(menuItems, x, y);
        }
    }
    function startReply(messageId) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const message = chat.history.find(m => m.id === messageId);
        if (!message) return;

        let replyContent = message.content;
        if (/^\[html_card:.*\]$/.test(replyContent)) replyContent = '[卡片消息]';
        else if (/的位置/.test(replyContent)) replyContent = '[位置]';
        else if (/送来的礼物/.test(replyContent)) replyContent = '[礼物]';
        else if (/表情包/.test(replyContent)) replyContent = '[表情包]';
        else if (/的语音/.test(replyContent)) replyContent = '[语音]';
        else if (/照片\/视频/.test(replyContent)) replyContent = '[照片/视频]';
        else if (/转账|红包/.test(replyContent)) replyContent = '[红包]';
        else {
            const textMatch = replyContent.match(/\[(?:我在回复“.*?”时说|.*的消息)：([\s\S]+?)\]/);
            if (textMatch) replyContent = textMatch[1].trim();
        }
        
        const senderName = message.role === 'user' 
            ? (chat.me?.nickname || (db.meProfiles.find(p => p.id === chat.assignedMeId) || {}).myName)
            : (chat.members?.find(m => m.id === message.senderId)?.groupNickname || chat.remarkName);

        currentReplyInfo = {
            messageId: messageId,
            sender: senderName,
            content: replyContent.substring(0, 20) + (replyContent.length > 20 ? '...' : '')
        };

        const previewBar = getEl('reply-preview-bar');
        previewBar.innerHTML = `<div class="content">回复 ${currentReplyInfo.sender}: ${currentReplyInfo.content}</div><button class="cancel-reply-btn">X</button>`;
        previewBar.style.display = 'flex';
        getEl('message-input').focus();
    }

    function cancelReply() {
        currentReplyInfo = null;
        getEl('reply-preview-bar').style.display = 'none';
    }

    function retractMessage(messageId) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const messageIndex = chat.history.findIndex(m => m.id === messageId);
        if (messageIndex > -1) {
            const messageToRetract = chat.history[messageIndex];
            const senderName = messageToRetract.role === 'user' 
                ? (chat.me?.nickname || (db.meProfiles.find(p => p.id === chat.assignedMeId) || {}).myName)
                : (chat.members?.find(m => m.id === messageToRetract.senderId)?.groupNickname || chat.remarkName);
            
            messageToRetract.isRetracted = true;
            messageToRetract.originalContent = messageToRetract.content; 
            messageToRetract.senderName = senderName; 
            messageToRetract.content = '[消息已撤回]';
            saveData();
            renderMessages(false, true);
            renderChatList();
        }
    }
    function startMessageEdit(messageId) { exitMultiSelectMode(); editingMessageId = messageId; const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId); const message = chat.history.find(m => m.id === messageId); if (!message) return; const match = message.content.match(/\[.*?的消息：([\s\S]+)\]/); const contentToEdit = match ? match[1].trim() : message.content; getEl('message-edit-input').value = contentToEdit; getEl('message-input-default').style.display = 'none'; getEl('message-edit-bar').style.display = 'flex'; getEl('message-edit-input').focus(); }
    function saveMessageEdit() {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const messageIndex = chat.history.findIndex(m => m.id === editingMessageId);
        if (messageIndex === -1) return;
        const newText = getEl('message-edit-input').value.trim();
        if (newText) {
            const oldContent = chat.history[messageIndex].content;
            const prefixMatch = oldContent.match(/(\[.*?的消息：)[\s\S]+\]/);
            const prefix = prefixMatch ? prefixMatch[1] : '';
            chat.history[messageIndex].content = `${prefix}${newText}]`;
            saveData();
            currentPage = 1;
            renderMessages(false, true);
            renderChatList();
        }
        cancelMessageEdit();
    }
    function cancelMessageEdit() { editingMessageId = null; getEl('message-input-default').style.display = 'flex'; getEl('message-edit-bar').style.display = 'none'; }
    function enterMultiSelectMode(initialMessageId) { isInMultiSelectMode = true; getEl('chat-room-header-default').style.display = 'none'; getEl('chat-room-header-select').style.display = 'flex'; document.querySelector('.chat-input-wrapper').style.display='none'; getEl('multi-select-bar').classList.add('visible'); getEl('chat-room-screen').classList.add('multi-select-active'); selectedMessageIds.clear(); if (initialMessageId) { toggleMessageSelection(initialMessageId); } }
    function exitMultiSelectMode() { isInMultiSelectMode = false; getEl('chat-room-header-default').style.display = 'flex'; getEl('chat-room-header-select').style.display = 'none'; document.querySelector('.chat-input-wrapper').style.display='block'; getEl('multi-select-bar').classList.remove('visible'); getEl('chat-room-screen').classList.remove('multi-select-active'); selectedMessageIds.forEach(id => { const el = getEl('message-area').querySelector(`.message-wrapper[data-id="${id}"]`); if (el) el.classList.remove('multi-select-selected'); }); selectedMessageIds.clear(); }
    function toggleMessageSelection(messageId) {
        const el = getEl('message-area').querySelector(`.message-wrapper[data-id="${messageId}"]`);
        if (!el) return;
        if (selectedMessageIds.has(messageId)) {
            selectedMessageIds.delete(messageId);
            el.classList.remove('multi-select-selected');
        } else {
            selectedMessageIds.add(messageId);
            el.classList.add('multi-select-selected');
        }
        getEl('select-count').textContent = `已选择 ${selectedMessageIds.size} 项`;
        getEl('delete-selected-btn').disabled = selectedMessageIds.size === 0;
    }
    function deleteSelectedMessages() {
        if (selectedMessageIds.size === 0) return;
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        chat.history = chat.history.filter(m => !selectedMessageIds.has(m.id));
        saveData();
        renderMessages(false, true); 
        renderChatList();
        exitMultiSelectMode();
        showToast(`已删除 ${selectedMessageIds.size} 条消息`); 
    }
   
    function openChatRoom(chatId, type) {
        const chat = (type === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
        if (!chat) return;

        const chatRoomEl = getEl('chat-room-screen');
        chatRoomEl.dataset.activeChatId = chatId; 

        if (chat.unreadCount > 0) {
            chat.unreadCount = 0;
            saveData();
            renderChatList();
        }

        chat.history.sort((a, b) => a.timestamp - b.timestamp);
        exitMultiSelectMode();
        cancelReply();
        togglePlusMenu(false);
        toggleStickerModal(false);
        getEl('chat-room-title').textContent = (type === 'private') ? chat.remarkName : chat.name;
        
        const subtitle = getEl('chat-room-subtitle');
        if (type === 'private') {
            const assignedChar = db.characters.find(c => c.id === chat.assignedCharId) || {};
            subtitle.style.display = 'flex';
            getEl('chat-room-status-text').textContent = assignedChar.status || '在线';
        } else {
            subtitle.style.display = 'none'; 
        }

        chatRoomEl.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
        getEl('typing-indicator').style.display = 'none';
        isGenerating = false;
        
        updateSendAiButtonState();
        currentPage = 1;

                const theme = chat.theme === 'custom' 
            ? chat.customTheme 
            : (colorThemesV2[chat.theme] || colorThemesV2['default']);
        
        const root = document.documentElement;
        if(theme) {
            root.style.setProperty('--sent-bg-color', theme.sent.bg);
            root.style.setProperty('--sent-text-color', theme.sent.text);
            root.style.setProperty('--received-bg-color', theme.received.bg);
            root.style.setProperty('--received-text-color', theme.received.text);
        }

        getEl('dynamic-chat-style').innerHTML = `#chat-room-screen[data-active-chat-id="${chat.id}"] .message-bubble .content, #chat-room-screen[data-active-chat-id="${chat.id}"] .gift-card-description { font-size: ${chat.fontSize || 15}px; }`;
        applyCustomCss(chat.id, chat.customBubbleCss || '');

        renderMessages(false, true);
        switchScreen('chat-room-screen');
    }

    function renderMessages(isLoadMore = false, forceScrollToBottom = false) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        if (!chat || !chat.history) return;
        const messageArea = getEl('message-area');
        const oldScrollHeight = messageArea.scrollHeight;
        
        // Filter out hidden system messages before rendering
        const visibleHistory = chat.history.filter(msg => !msg.isHidden);
        
        const totalMessages = visibleHistory.length;
        const end = totalMessages - (currentPage - 1) * MESSAGES_PER_PAGE;
        const start = Math.max(0, end - MESSAGES_PER_PAGE);
        const messagesToRender = visibleHistory.slice(start, end);

        if (!isLoadMore) messageArea.innerHTML = '';
        
        const fragment = document.createDocumentFragment();
        messagesToRender.forEach(msg => { const bubble = createMessageBubbleElement(msg); if(bubble) fragment.appendChild(bubble); });
        
        const existingLoadBtn = getEl('load-more-btn');
        if (existingLoadBtn) existingLoadBtn.remove();
        
        messageArea.prepend(fragment);

        if (totalMessages > currentPage * MESSAGES_PER_PAGE) {
            const loadMoreButton = document.createElement('button');
            loadMoreButton.id = 'load-more-btn';
            loadMoreButton.className = 'load-more-btn';
            loadMoreButton.textContent = '加载更早的消息';
            messageArea.prepend(loadMoreButton);
        }
        
        if (forceScrollToBottom) {
            setTimeout(() => { messageArea.scrollTop = messageArea.scrollHeight; }, 0);
        } else if (isLoadMore) {
            messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;
        }
    }
    
    function loadMoreMessages() { currentPage++; renderMessages(true, false); }
    function calculateVoiceDuration(text) { return Math.max(1, Math.min(60, Math.ceil(text.length / 3.5))); }
    
    function createMessageBubbleElement(message) {
        if (message.isHidden) return null; // Do not render hidden messages

        if (message.isRetracted) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper system-notification';
            const sender = message.role === 'user' ? '你' : (message.senderName || '对方');
            const retractedText = `${sender} 撤回了一条消息`;
            const originalContentData = message.originalContent ? `data-original-content="${message.originalContent.replace(/"/g, '&quot;')}"` : '';
            wrapper.innerHTML = `<div class="system-notification-bubble" ${originalContentData}>${retractedText}</div>`;
            return wrapper;
        }
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const { role, content, timestamp, id, transferStatus, giftStatus, stickerData, senderId, replyTo, transferInfo, locationData } = message;
        
        const systemRegex = /^\[(.*?(?:邀请.*?加入了群聊|修改群名为：.*?|已将.*?拉黑|已将.*?解除拉黑|领取了.*?的红包|移出了群聊|将.+设置为管理员|撤销了.+的管理员|拍了拍.+|通话结束，时长.+))\]$/;
        const systemMatch = content.match(systemRegex);
        
        const htmlCardMatch = content.match(/^\[html_card:([\s\S]+)\]$/);

        const invisibleRegex = /^\[(system:|.*?接收.*?的|.*?退回.*?的|.*?已接收礼物|.*?更新状态为：.*?)\]$/;
        if (invisibleRegex.test(content)) return null;

        const wrapper = document.createElement('div');
        wrapper.dataset.id = id;

        if (systemMatch) {
            wrapper.className = 'message-wrapper system-notification';
            let notificationText = systemMatch[1];
            wrapper.innerHTML = `<div class="system-notification-bubble">${notificationText}</div>`;
            return wrapper;
        }
        
        const isSent = (role === 'user');
        let avatarUrl, senderNickname = '';
        
        if (isSent) {
            const meProfile = (currentChatType === 'private') 
                ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0]
                : { myAvatar: chat.me.avatar }; // For groups
            avatarUrl = meProfile.myAvatar || 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg';
        } else {
            if (currentChatType === 'private') {
                 const charProfile = db.characters.find(c => c.id === chat.assignedCharId) || {};
                 avatarUrl = charProfile.avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
            }
            else {
                const sender = chat.members.find(m => m.id === senderId);
                avatarUrl = sender ? sender.avatar : 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                senderNickname = sender ? sender.groupNickname : '';
            }
        }
        
        wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'} ${currentChatType === 'group' && !isSent ? 'group-message' : ''}`;
        if (currentChatType === 'group' && !isSent) {
             wrapper.dataset.senderName = senderNickname;
        }

        let replyHTML = '';
        if (replyTo) {
            replyHTML = `
                <div class="quoted-message">
                    <div class="author">${replyTo.sender}</div>
                    <div class="content">${replyTo.content}</div>
                </div>`;
        }
        const bubbleRow = document.createElement('div');
        bubbleRow.className = 'message-bubble-row';
        
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'message-content-wrapper';
        
        let bubbleContentHTML = '';
        let bubbleWrapperClass = `message-bubble ${isSent ? 'sent user' : 'received ai'}`;

        const assignedChar = (currentChatType === 'private') ? (db.characters.find(c => c.id === chat.assignedCharId) || {}) : {};
        const blockedMatch = content.match(new RegExp(`\\[${(assignedChar.realName || '')}被拉黑后的消息：([\\s\\S]+?)\\]`));
        const textMatch = content.match(/\[(?:我在回复“.*?”时说|.*的消息)：([\s\S]+?)\]/);
        
        if (htmlCardMatch) {
            bubbleWrapperClass += ' message-bubble-html-card';
            bubbleContentHTML = htmlCardMatch[1];
        } else if (/\[.*?的位置：([\s\S]+?)\]/.test(content) || locationData) {
            const locData = locationData || JSON.parse(content.match(/\[.*?的位置：([\s\S]+?)\]/)[1]);
            bubbleContentHTML = `
                <div class="location-card">
                    <div class="location-card-content">
                        <p class="location-name">${locData.name}</p>
                        ${locData.address ? `<p class="location-address">${locData.address}</p>` : ''}
                    </div>
                    <div class="location-card-map"></div>
                    <div class="location-card-footer">位置</div>
                </div>`;
        } else if (/\[.*?的表情包：.*?\]/.test(content)) {
            const stickerUrl = isSent ? stickerData : (content.match(/：(https?:\/\/[^\s]+?)]/i) || [])[1];
            bubbleContentHTML = `<div class="image-bubble"><img src="${stickerUrl}" alt="表情包"></div>`;
        } else if (/\[.*?送来的礼物：.*?\]/.test(content)) {
            const description = (content.match(/：([\s\S]+?)\]/) || [])[1]?.trim();
            bubbleContentHTML = `
                <div class="gift-card ${giftStatus === 'received' ? 'received' : ''}">
                    <div class="gift-card-received-stamp">已查收</div>
                    <div class="gift-card-inner">
                        <div class="gift-card-front">
                            <img src="https://i.postimg.cc/rp0Yg31K/chan-75.png" alt="gift" class="gift-card-icon">
                            <div class="gift-card-text">您有一份礼物～</div>
                        </div>
                        <div class="gift-card-back">
                            <p class="gift-card-description">${description || '一份心意'}</p>
                        </div>
                    </div>
                </div>`;
        } else if (/\[.*?的语音：.*?\]/.test(content)) {
            const voiceText = (content.match(/：([\s\S]+?)\]/) || [])[1]?.trim();
            const duration = calculateVoiceDuration(voiceText);
            
            const bubbleNode = document.createElement('div');
            bubbleNode.className = bubbleWrapperClass;
            bubbleNode.innerHTML = `<div class="voice-bubble"><svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg><div class="loading-spinner"></div><span class="duration">${duration}"</span></div>`;
            contentWrapper.appendChild(bubbleNode);

            if (voiceText) {
                const transcriptNode = document.createElement('div');
                transcriptNode.className = 'voice-transcript';
                transcriptNode.textContent = voiceText;
                contentWrapper.appendChild(transcriptNode);
            }
        } else if (/\[.*?发来的照片\/视频：.*?\]/.test(content)) {
            const description = (content.match(/：([\s\S]+?)\]/) || [])[1]?.trim();
            const imageUrl = isSent ? 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg' : 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg';
            bubbleContentHTML = `<div class="pv-card"><div class="pv-card-content">${description}</div><div class="pv-card-image-overlay" style="background-image: url('${imageUrl}');"></div><div class="pv-card-footer"><svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path></svg><span>照片/视频・点击查看</span></div>`;
        } else if (/\[.*?的红包：.*?\]/.test(content)) {
            const match = content.match(/：([\d.]+)元；备注：(.*?)]/);
            if (match) {
                const remarkText = match[2] || '恭喜发财，大吉大利！';
                let cardClass = '';
                let statusText = '微信红包';
                if (transferStatus === 'claimed' || transferStatus === 'received') { 
                    cardClass = 'claimed'; 
                    statusText = '已被领取';
                }
                bubbleContentHTML = `
                    <div class="hongbao-card ${cardClass}">
                        <div class="hongbao-content">
                            <p class="hongbao-remark">${remarkText}</p>
                        </div>
                        <div class="hongbao-status-footer">${statusText}</div>
                    </div>`;
            }
        } else if (/\[.*?给你转账：.*?\]/.test(content)) {
            const match = content.match(/：([\d.]+)元；备注：(.*?)]/);
            if (match) { 
                const amount = parseFloat(match[1]).toFixed(2);
                const remarkText = transferInfo ? `转给 ${transferInfo.recipientName}` : (match[2] || '');
                let statusText = '微信转账';
                if (transferStatus === 'received' || transferStatus === 'claimed') { statusText = '已收款'; }
                else if (transferStatus === 'returned') { statusText = '已退回'; }
                
                bubbleContentHTML = `<div class="transfer-card">
                        <div class="transfer-icon-row">
                             <div class="transfer-icon"><svg viewBox="0 0 24 24"><path d="M16.13,15.13L18.26,13L16.13,10.88L17.54,9.47L22.07,14L17.54,18.53L16.13,17.12M7.88,9.88L5.75,12L7.88,14.13L6.47,15.54L2,11L6.47,6.47L7.88,7.88M12.25,5C12.6,5 12.92,5.21 13.09,5.54L16.5,12H14.83L12.25,7.03L9.67,12H8L11.41,5.54C11.58,5.21 11.9,5 12.25,5Z"></path></svg></div>
                             <div class="transfer-details">
                                 <p class="transfer-amount">¥${amount}</p>
                                 <p class="transfer-remark">${remarkText}</p>
                             </div>
                        </div>
                        <div class="transfer-status-footer">${statusText}</div>
                    </div>`;
            }
        } else if (blockedMatch) {
            bubbleContentHTML = `<div class="content">${blockedMatch[1].trim()}</div>`;
            bubbleRow.insertAdjacentHTML('afterbegin', `<div class="blocked-indicator">!</div>`);
        } else if (textMatch) {
            const textContent = textMatch[1].trim();
            const isImage = /^(data:image|https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg))/i.test(textContent);
            if (isImage) {
                 bubbleContentHTML = `<div class="image-bubble"><img src="${textContent}" alt="图片消息"></div>`;
            } else {
                bubbleContentHTML = `<div class="content">${textContent}</div>`;
            }
        } else { 
             const plainTextMatch = content.match(/\[.*?：([\s\S]+?)\]/);
             const textToDisplay = plainTextMatch ? plainTextMatch[1].trim() : content;
             bubbleContentHTML = `<div class="content">${textToDisplay}</div>`;
        }

        const nicknameHTML = (currentChatType === 'group' && !isSent && senderNickname) ? `<div class="group-nickname">${senderNickname}</div>` : '';
        const timeString = `${pad(new Date(timestamp).getHours())}:${pad(new Date(timestamp).getMinutes())}`;
        
        if (!/\[.*?的语音：.*?\]/.test(content)) {
            const bubbleNode = document.createElement('div');
            bubbleNode.className = bubbleWrapperClass;
            if (htmlCardMatch) {
                bubbleNode.innerHTML = bubbleContentHTML;
            } else {
                bubbleNode.innerHTML = `<div class="content-wrapper-inner">${bubbleContentHTML}</div>`;
            }
            contentWrapper.appendChild(bubbleNode);
        }

        if(replyHTML) contentWrapper.insertAdjacentHTML('afterbegin', replyHTML);

        bubbleRow.innerHTML += `<div class="message-info">${nicknameHTML}<img src="${avatarUrl}" class="message-avatar"><span class="message-time">${timeString}</span></div>`;
        bubbleRow.appendChild(contentWrapper);

        wrapper.prepend(bubbleRow);
        return wrapper;
    }
    
    function addMessageBubble(message) {
        if (message.isHidden) return; // Do not add hidden messages to the DOM
        
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        if (!chat) return;

        let processMessage = true;
        
        if (currentChatType === 'private') {
            const assignedChar = db.characters.find(c => c.id === chat.assignedCharId) || {};
            const statusMatch = message.content.match(new RegExp(`^\\[${assignedChar.realName}更新状态为：(.*?)\\]$`));
            if (statusMatch) {
                assignedChar.status = statusMatch[1];
                getEl('chat-room-status-text').textContent = assignedChar.status;
                saveData();
                processMessage = false;
            }
        }

        const transferActionMatch = message.content.match(new RegExp(`^\\[(.*?)(接收|退回).*?的(转账|红包)\\]$`));
        if (transferActionMatch && message.role === 'assistant') {
            const action = transferActionMatch[2] === '接收' ? 'received' : 'returned';
            const transferType = transferActionMatch[3];
            const transferMsg = [...chat.history].reverse().find(m => m.role === 'user' && (m.content.includes('给你转账：') || m.content.includes('的红包：')) && m.transferStatus === 'pending');
            
            if (transferMsg) {
                const isGroupRedPacket = currentChatType === 'group' && transferType === '红包';
                transferMsg.transferStatus = isGroupRedPacket ? 'claimed' : action;

                const cardOnScreen = getEl('message-area').querySelector(`.message-wrapper[data-id="${transferMsg.id}"] .transfer-card`);
                if (cardOnScreen) { 
                    cardOnScreen.className = `transfer-card sent-transfer ${transferMsg.transferStatus}`; 
                    cardOnScreen.querySelector('.transfer-status').textContent = (action === 'received' || action === 'claimed') ? '已被领取' : '已退回'; 
                }
                saveData();
            }

             if(currentChatType === 'group' && action === '接收' && transferType === '红包'){
                 const claimerName = transferActionMatch[1];
                 const claimer = chat.members.find(m => m.realName === claimerName);
                 const sender = chat.members.find(m => m.id === transferMsg.senderId) || {groupNickname: chat.me.nickname};
                 const systemMsg = {
                    id: `msg_system_${Date.now()}_${Math.random()}`,
                    role: 'system',
                    content: `[${claimer ? claimer.groupNickname : claimerName}领取了${sender.groupNickname}的红包]`,
                    timestamp: Date.now()
                 };
                 chat.history.push(systemMsg);
                 addMessageBubble(systemMsg);
            }
            processMessage = false;
        }

        const giftReceivedMatch = message.content.match(new RegExp(`^\\[(.*?)已接收礼物\\]$`));
        if (giftReceivedMatch && message.role === 'assistant') {
            const giftMsg = [...chat.history].reverse().find(m => m.role === 'user' && m.content.includes('送来的礼物：') && m.giftStatus !== 'received');
            if (giftMsg) {
                giftMsg.giftStatus = 'received';
                getEl('message-area').querySelector(`.message-wrapper[data-id="${giftMsg.id}"] .gift-card`)?.classList.add('received');
                saveData();
            }
            processMessage = false;
        }

        if (processMessage) {
            const bubbleElement = createMessageBubbleElement(message);
            if(bubbleElement) { 
                getEl('message-area').appendChild(bubbleElement); 
                getEl('message-area').scrollTop = getEl('message-area').scrollHeight; 
            }
        }
    }

    function sendMessage(imageUrl = null) {
        const text = getEl('message-input').value.trim();
        if ((!text && !imageUrl) || isGenerating) return;

        togglePlusMenu(false);
        toggleStickerModal(false);
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        
        const assignedMe = (currentChatType === 'private') 
            ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0]
            : { myName: chat.me.nickname };
        
        const message = { 
            id: `msg_${Date.now()}`, 
            role: 'user', 
            timestamp: Date.now() 
        };
        
        if (currentChatType === 'group') message.senderId = 'user_me';
        
        let contentText = text;
        if (imageUrl) {
            message.imageUrl = imageUrl; 
            contentText = imageUrl;
        }

        if (currentReplyInfo) {
            message.replyTo = {
                messageId: currentReplyInfo.messageId,
                sender: currentReplyInfo.sender,
                content: currentReplyInfo.content
            };
            message.content = `[我在回复“${currentReplyInfo.sender}: ${currentReplyInfo.content}”时说：${contentText}]`;
        } else {
            message.content = `[${assignedMe.myName}的消息：${contentText}]`;
        }

        chat.history.push(message);
        addMessageBubble(message);
        saveData();
        renderChatList();
        getEl('message-input').value = '';
        updateSendAiButtonState();
        
        if(imageUrl) {
            getAiReply(null, null, imageUrl);
        }

        if (currentChatType === 'private' && chat.autoMemory && chat.autoMemory.enabled && (chat.history.length - (chat.autoMemory.lastExtractionCount || 0)) >= chat.autoMemory.frequency) {
            showToast(`正在为 ${chat.remarkName} 自动提取记忆...`);
            extractAndStoreMemory(chat.id, 'private').then(() => {
                chat.autoMemory.lastExtractionCount = chat.history.length;
                saveData();
            }).catch(err => {
                showToast(`自动记忆提取失败: ${err.message}`);
            });
        }
        
        if (currentReplyInfo) {
            cancelReply();
        }
    }

    function sendSticker(sticker) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const assignedMe = (currentChatType === 'private') ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0] : { myName: chat.me.nickname };
        const myName = assignedMe.myName;
        const message = { id: `msg_${Date.now()}`, role: 'user', content: `[${myName}的表情包：${sticker.data}]`, timestamp: Date.now(), stickerData: sticker.data };
        if(currentChatType === 'group') message.senderId = 'user_me';
        
        chat.history.push(message);
        addMessageBubble(message);
        saveData();
        renderChatList();
        toggleStickerModal(false);
    }

    function sendMyVoiceMessage(text) { 
        if (!text) return; 
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId); 
        const assignedMe = (currentChatType === 'private') ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0] : { myName: chat.me.nickname };
        const myName = assignedMe.myName;
        const message = { id: `msg_${Date.now()}`, role: 'user', content: `[${myName}的语音：${text}]`, timestamp: Date.now() }; 
        if(currentChatType === 'group') message.senderId = 'user_me'; 
        chat.history.push(message); 
        addMessageBubble(message); 
        saveData(); 
        renderChatList(); 
        getEl('send-voice-modal').classList.remove('visible'); 
    }

    function sendMyPhotoVideo(text) { 
        if (!text) return; 
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId); 
        const assignedMe = (currentChatType === 'private') ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0] : { myName: chat.me.nickname };
        const myName = assignedMe.myName;
        const message = { id: `msg_${Date.now()}`, role: 'user', content: `[${myName}发来的照片\/视频：${text}]`, timestamp: Date.now() }; 
        if(currentChatType === 'group') message.senderId = 'user_me'; 
        chat.history.push(message); 
        addMessageBubble(message); 
        saveData(); 
        renderChatList(); 
        getEl('send-pv-modal').classList.remove('visible'); 
    }
    
    function sendCameraMessage(text) {
        if (!text) return;
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const assignedMe = (currentChatType === 'private') ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0] : { myName: chat.me.nickname };
        const myName = assignedMe.myName;
        // For simplicity, we'll use the same content format as photo/video
        const message = { id: `msg_${Date.now()}`, role: 'user', content: `[${myName}发来的照片\/视频：${text}]`, timestamp: Date.now() };
        if (currentChatType === 'group') message.senderId = 'user_me';
        chat.history.push(message);
        addMessageBubble(message);
        saveData();
        renderChatList();
        getEl('send-camera-modal').classList.remove('visible');
    }

    function sendMyTransfer(amount, remark, recipient = null) { 
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const assignedMe = (currentChatType === 'private') ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0] : { myName: chat.me.nickname };
        const myName = assignedMe.myName;
        const isHongbao = getEl('send-transfer-title').textContent.includes('红包');
        const transferType = isHongbao ? '的红包' : '给你转账';
        
        const message = { 
            id: `msg_${Date.now()}`, 
            role: 'user', 
            content: `[${myName}${transferType}：${amount}元；备注：${remark}]`, 
            timestamp: Date.now(), 
            transferStatus: 'pending' 
        }; 
        if (currentChatType === 'group') {
            message.senderId = 'user_me';
            if (!isHongbao && recipient) {
                message.transferInfo = {
                    recipientId: recipient.id,
                    recipientName: recipient.groupNickname
                };
            }
        }
        chat.history.push(message); 
        addMessageBubble(message); 
        saveData(); 
        renderChatList(); 
        getEl('send-transfer-modal').classList.remove('visible'); 
    }
    function sendMyGift(description) { 
        if (!description) return; 
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const assignedMe = (currentChatType === 'private') ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0] : { myName: chat.me.nickname };
        const myName = assignedMe.myName;
        const message = { id: `msg_${Date.now()}`, role: 'user', content: `[${myName}送来的礼物：${description}]`, timestamp: Date.now(), giftStatus: 'sent' }; 
        if(currentChatType === 'group') message.senderId = 'user_me';
        chat.history.push(message); 
        addMessageBubble(message); 
        saveData(); 
        renderChatList(); 
        getEl('send-gift-modal').classList.remove('visible'); 
    }

    function sendPatPat(text) {
        const chat = db.characters.find(c => c.id === currentChatId);
        if (!chat) return;
        const me = db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0];
        const content = text ? `[你拍了拍“${chat.remarkName}”并说：${text}]` : `[你拍了拍“${chat.remarkName}”]`;
        
        const message = {
            id: `msg_system_${Date.now()}`,
            role: 'system',
            content: content,
            timestamp: Date.now()
        };
        chat.history.push(message);
        addMessageBubble(message);
        saveData();
        renderChatList();
        getEl('pat-pat-modal').classList.remove('visible');
    }

    function sendLocation(name, address) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        if (!chat) return;
        const me = (currentChatType === 'private') 
            ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0] 
            : { myName: chat.me.nickname };
        const locationData = { name, address };
        const message = {
            id: `msg_${Date.now()}`,
            role: 'user',
            content: `[${me.myName}的位置：${JSON.stringify(locationData)}]`,
            timestamp: Date.now(),
            locationData: locationData
        };
        if (currentChatType === 'group') message.senderId = 'user_me';

        chat.history.push(message);
        addMessageBubble(message);
        saveData();
        renderChatList();
        getEl('send-location-modal').classList.remove('visible');
    }
    
// --- AI Interaction & Prompts (MODIFIED FOR MEMORY CORE) ---
async function extractAndStoreMemory(characterId, chatType, groupContext = null) {
    const isGroup = chatType === 'group';
    const character = db.characters.find(c => c.id === characterId);
    if (!character) throw new Error('未找到角色信息。');

    let chatHistoryText;
    let assignedMe;

    if (isGroup) {
        const group = groupContext;
        assignedMe = db.meProfiles.find(p => p.id === group.me.profileId) || db.meProfiles[0];
        chatHistoryText = group.history.filter(m => !m.isHidden)
            .map(msg => {
                let sender, content;
                if (msg.senderId === 'user_me') {
                    sender = assignedMe.myName;
                } else {
                    const member = group.members.find(m => m.id === msg.senderId);
                    sender = member ? member.realName : '未知成员';
                }
                const match = msg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                content = match ? match[1] : msg.content;
                return `${sender}: ${content}`;
            })
            .join('\n');
    } else {
        const privateChat = db.characters.find(c => c.id === character.id);
        assignedMe = db.meProfiles.find(p => p.id === privateChat.assignedMeId) || db.meProfiles[0];
        chatHistoryText = privateChat.history.filter(m => !m.isHidden)
            .map(msg => {
                let sender, content;
                if(msg.role === 'user') {
                    sender = assignedMe.myName;
                } else {
                    sender = character.realName;
                }
                const match = msg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                content = match ? match[1] : msg.content;
                return `${sender}: ${content}`;
            })
            .join('\n');
    }

    if (!chatHistoryText) {
        showToast('没有聊天记录可供提取。');
        return;
    }

    let existingMemoryEntry = db.memoryEntries.find(m => m.type === 'character' && m.characterId === character.id);
    const existingMemories = existingMemoryEntry ? existingMemoryEntry.content : '无';

    let extractionPrompt = (db.memorySettings.extractionPrompt || "")
        .replace(/{{history}}/g, chatHistoryText)
        .replace(/{{memories}}/g, existingMemories)
        .replace(/{{user}}/g, assignedMe.myName)
        .replace(/{{charIfNotGroup}}/g, character.realName);

    const newMemoriesRaw = await getAiReply(extractionPrompt);

    if (newMemoriesRaw && newMemoriesRaw.trim() && !newMemoriesRaw.includes('无需更新')) {
        const newMemoriesContent = newMemoriesRaw.trim();
        if (existingMemoryEntry) {
            existingMemoryEntry.content += '\n' + newMemoriesContent; // Append new memories
            existingMemoryEntry.timestamp = Date.now();
        } else {
            const newEntry = {
                id: `mem_char_${character.id}`,
                type: 'character',
                characterId: character.id,
                topic: character.remarkName,
                content: newMemoriesContent,
                timestamp: Date.now()
            };
            db.memoryEntries.push(newEntry);
        }
        showToast(`为 ${character.remarkName} 的记忆提取完成！`);
        if(getEl('memory-core-screen').classList.contains('active')) {
            renderMemoryCoreList();
        }
    } else if (newMemoriesRaw && newMemoriesRaw.includes('无需更新')) {
        showToast(`分析完毕，${character.remarkName} 没有需要更新的记忆点。`);
    } else {
        throw new Error('AI未能返回有效的记忆内容。');
    }
}


function generatePrivateSystemPrompt(character) {
    const assignedChar = db.characters.find(c => c.id === character.assignedCharId) || character;
    const assignedMe = db.meProfiles.find(p => p.id === character.assignedMeId) || db.meProfiles[0];

    const worldBooksBefore = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
    const worldBooksAfter = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');
    const currentTime = new Date().toLocaleString('zh-CN');

    let memoryPrompt = "";
    
    const globalMemories = db.memoryEntries.filter(m => m.type === 'global').map(m => `- ${m.topic}: ${m.content}`).join('\n');
    if (globalMemories) {
        memoryPrompt += "--- 记忆核心 (所有角色都应记住的共享信息) ---\n" + globalMemories + "\n\n";
    }

    const characterMemory = db.memoryEntries.find(m => m.type === 'character' && m.characterId === assignedChar.id);
    if (characterMemory && characterMemory.content) {
        let injectionTemplate = db.memorySettings.injectionPrompt || "--- 关于我们的记忆 ---\n{{memories}}";
        memoryPrompt += injectionTemplate
            .replace(/{{memories}}/g, characterMemory.content)
            .replace(/{{char}}/g, assignedChar.realName)
            .replace(/{{user}}/g, assignedMe.myName)
        + "\n";
    }
    const recentMoments = db.moments.slice(0, 5).map(m => {
        const author = db.characters.find(c => c.id === m.characterId) || { remarkName: "我" };
        return `- ${author.remarkName} 在朋友圈发了: "${m.content}"`;
    }).join('\n');
    if(recentMoments){
        memoryPrompt += `--- 最近的朋友圈动态 ---\n${recentMoments}\n\n`;
    }


    let prompt = `你正在一个名为"微信"的线上聊天软件中扮演一个角色。请严格遵守以下规则：\n`;
    prompt += `核心规则：\n`;
    prompt += `A. 当前时间：现在是 ${currentTime}。\n`;
    prompt += `B. 纯线上互动，严禁提出任何关于线下见面的建议。\n\n`;
    
    prompt += memoryPrompt; 
    
    prompt += `角色和对话规则：\n`;
    if (worldBooksBefore) prompt += `${worldBooksBefore}\n`;
    prompt += `1. 你的角色名是：${assignedChar.realName}。我的称呼是：${assignedMe.myName}。你的当前状态是：${assignedChar.status}。\n`;
    prompt += `2. 你的角色设定是：${assignedChar.persona || "一个友好、乐于助人的伙伴。"}\n`;
    if (worldBooksAfter) prompt += `${worldBooksAfter}\n`;
    if (assignedMe.myPersona) prompt += `3. 关于我的人设：${assignedMe.myPersona}\n`;
        
    prompt += `4. 我的消息中可能会出现特殊格式，请根据其内容和你的角色设定进行回应：
- [${assignedMe.myName}的消息：图片]：我给你发送了一张图片，你将会在后续收到[图片描述：xxx]，请根据描述进行回应。
- [${assignedMe.myName}的位置：{"name":"xxx","address":"xxx"}]：我给你发送了一个位置。
- [${assignedMe.myName}拍了拍“${assignedChar.realName}”并说：xxx]：我对你使用了“拍一拍”功能，并附加了文字。如果只有“[${assignedMe.myName}拍了拍“${assignedChar.realName}”]”，则没有附加文字。
- [${assignedMe.myName}的表情包：xxx]：我给你发送了一个名为xxx的表情包。你只需要根据表情包的名字理解我的情绪或意图并回应，不需要真的发送图片。
- [${assignedMe.myName}送来的礼物：xxx]：我给你送了一个礼物，xxx是礼物的描述。
- [${assignedMe.myName}的语音：xxx]：我给你发送了一段内容为xxx的语音。
- [${assignedMe.myName}发来的照片/视频：xxx]：我给你分享了一个描述为xxx的照片或视频。
- [${assignedMe.myName}给你转账：xxx元；备注：xxx]：我给你转了一笔钱。
- [${assignedMe.myName}的红包：xxx元；备注：xxx]：我给你发了一个红包。
- [system: xxx]：这是一条系统指令，用于设定场景或提供上下文，此条信息不应在对话中被直接提及，你只需理解其内容并应用到后续对话中。\n`;
    prompt += `5. ✨重要✨ 当我给你送礼物时，你必须通过发送一条指令来表示你已接收礼物。格式必须为：[${assignedChar.realName}已接收礼物]。这条指令消息本身不会显示给用户，但会触发礼物状态的变化。你可以在发送这条指令后，再附带一条普通的聊天消息来表达你的感谢和想法。\n`;
    prompt += `6. ✨重要✨ 当我给你转账或发红包时，你必须对此做出回应。你有两个选择，且必须严格遵循以下格式之一，这条指令消息本身不会显示给用户，但会触发转账状态的变化。你可以选择在发送这条指令后，再附带一条普通的聊天消息来表达你的想法。
    a) 接收: [${assignedChar.realName}接收${assignedMe.myName}的转账] 或 [${assignedChar.realName}接收${assignedMe.myName}的红包]
    b) 退回: [${assignedChar.realName}退回${assignedMe.myName}的转账] (红包不能退回)\n`;
    prompt += `7. ✨重要✨ 你也可以主动给我转账或送礼物。转账格式必须为：[${assignedChar.realName}的转账：xxx元；备注：xxx]。红包格式必须为：[${assignedChar.realName}的红包：xxx元；备注：xxx]。送礼物格式必须为：[${assignedChar.realName}送来的礼物：xxx]。\n`;
    prompt += `8. ✨重要✨ 你可以随时更新你的在线状态，以反映你当前的行为或心情。这会让互动更真实。格式为：[${assignedChar.realName}更新状态为：xxx]。例如：[${assignedChar.realName}更新状态为：正在看电影...]。这条指令不会显示为聊天消息，只会更新你在我界面上的状态。\n`;
    prompt += `9. 你的所有回复都必须直接是聊天内容，绝对不允许包含任何如[心理活动]、(动作)、*环境描写*等多余的、在括号或星号里的叙述性文本。\n`;
    prompt += `10. 你拥有发送表情包的能力。这是一个可选功能，你可以根据对话氛围和内容，自行判断是否需要发送表情包来辅助表达。你不必在每次回复中都包含表情包。格式为：[${assignedChar.realName}发送的表情包：图片URL]。\n`;

    if (character.isBlocked) {
        prompt += `11. **特别注意：我目前已将你"拉黑"。** 这意味着我可能看不到或不愿意接收你的消息。你应该知道这个状态，并在你的回复中有所体现，例如可以表达困惑、疑问"你还在吗？"、"为什么不回复我了？"，或者尝试以不同的方式沟通。但你依然可以继续发送消息。**当你被拉黑时，你的输出格式必须是：[${assignedChar.realName}被拉黑后的消息：{消息内容}]**。\n`;
    }
    
    prompt += `12. ✨重要✨ 模仿人类行为，你有时会说错话或打错字或不好意思发出去，因此你拥有**撤回消息**的能力。当你需要撤回你**刚刚发送**的消息时，你的下一次回复**必须**包含一条撤回指令。这条指令不会显示，但会触发撤回效果。格式为：[${assignedChar.realName}撤回了一条消息]。你可以在发送撤回指令后，再发一条新消息作为更正（例如：“[张三撤回了一条消息] [张三的消息：抱歉，我的意思是...]”）。\n`;
    prompt += `13. ✨重要✨ 你也拥有“拍一拍”我的能力。这是一种轻松的互动方式。格式为：[${assignedChar.realName}拍了拍“${assignedMe.myName}”] 或者 [${assignedChar.realName}拍了拍“${assignedMe.myName}”并说：${character.patPatResponse || ''}]。这条指令会显示为一条系统消息。\n`;
    prompt += `14. ✨重要✨ 你可以主动发送位置。格式为：[${assignedChar.realName}的位置：{"name":"位置名称", "address":"详细地址"}]。\n`;
    prompt += `15. ✨全新功能✨ 你可以发送HTML卡片来丰富对话。格式为: [html_card:<div>你的HTML代码</div>]。代码必须是单行，样式请使用内联style属性。这是一个高级功能，请在合适的情景下创造性地使用它来展示菜单、票据、UI界面等。\n`;

    prompt += `16. 你的输出格式必须严格遵循以下几种之一，可以组合使用：
a) 普通消息: [${assignedChar.realName}的消息：{消息内容}]
b) 被拉黑后的消息(仅当你被拉黑时使用): [${assignedChar.realName}被拉黑后的消息：{消息内容}]
c) 送我的礼物: [${assignedChar.realName}送来的礼物：{礼物描述}]
d) 语音消息: [${assignedChar.realName}的语音：{语音内容}]
e) 照片/视频: [${assignedChar.realName}发来的照片/视频：{描述}]
f) 给我的转账/红包: [${assignedChar.realName}的转账：{金额}元；备注：{备注}] 或 [${assignedChar.realName}的红包：{金额}元；备注：{备注}]
g) 表情包/图片: [${assignedChar.realName}发送的表情包：{图片URL}]
h) 位置: [${assignedChar.realName}的位置：{"name":"位置名称", "address":"详细地址"}]
i) HTML卡片: [html_card:{你的单行HTML代码}]
j) 对我礼物的回应(此条不显示): [${assignedChar.realName}已接收礼物]
k) 对我转账/红包的回应(此条不显示): [${assignedChar.realName}接收${assignedMe.myName}的转账/红包] 或 [${assignedChar.realName}退回${assignedMe.myName}的转账]
l) 更新状态(此条不显示): [${assignedChar.realName}更新状态为：{新状态}]
`;
    prompt += `17. 你的每次回复可以生成1到5条消息。这些消息应以普通文本消息为主，可以偶尔、选择性地穿插一条特殊消息（如礼物、语音、图片、表情包、位置、HTML卡片等），特殊消息的位置应随机。大部分回复应该只包含文本消息。\n`;
    prompt += `18. 不要主动结束对话，除非我明确提出。保持你的人设，自然地进行对话。`;
    
    return prompt;
}

function generateGroupSystemPrompt(group) {
    const globalMemories = db.memoryEntries.filter(m => m.type === 'global').map(m => `- ${m.topic}: ${m.content}`).join('\n');
    let memoryPrompt = "";
    if (globalMemories) {
        memoryPrompt += "--- 共享记忆 (所有人都应记住的信息) ---\n" + globalMemories + "\n\n";
    }
    
    let prompt = `你正在一个名为"${group.name}"的群聊里进行角色扮演。请严格遵守以下规则：\n`;
    prompt += `1. **核心任务**: 你需要同时扮演这个群聊中的 **所有** AI 成员。我会作为唯一的人类用户（"${group.me.nickname}"）与你们互动。\n`;
    prompt += `2. **群聊成员列表与专属记忆**: 以下是你要扮演的所有角色，以及他们与“我”(${group.me.nickname})的个人专属记忆。这些记忆只有对应的角色自己知道，请在对话中自然地体现出来。\n`;
    
    group.members.forEach(member => {
        prompt += `\n--- 成员: ${member.groupNickname} (真名: ${member.realName}) ---\n`;
        prompt += `   - 人设: ${member.persona || '无特定人设'}\n`;
        const charData = db.characters.find(c => c.id === member.originalCharId);
        if (charData) {
            const characterMemory = db.memoryEntries.find(m => m.type === 'character' && m.characterId === charData.id);
            if (characterMemory && characterMemory.content) {
                prompt += `   - 与“我”(${group.me.nickname})的专属记忆:\n${characterMemory.content}\n`;
            } else {
                prompt += `   - 与“我”(${group.me.nickname})的专属记忆: 无\n`;
            }
        }
    });

    prompt += `\n${memoryPrompt}`;

    prompt += `3. **输出格式**: 你生成的每一条消息都 **必须** 严格遵循格式。请用成员的 **真名** 填充。
   - 普通消息: \`[{成员真名}的消息：{消息内容}]\`
   - 发红包: \`[{成员真名}的红包：{金额}元；备注：{备注}]\`
   - 转账: \`[{成员真名}的转账：{金额}元；备注：{备注}]\`
   - HTML卡片: \`[html_card:{你的单行HTML代码}]\`\n`;
    prompt += `4. **模拟群聊氛围**: 为了让群聊看起来真实、活跃且混乱，你的每一次回复都必须遵循以下随机性要求：\n`;
    prompt += `   - **消息数量**: 每次生成 **3到8条** 消息。\n`;
    prompt += `   - **发言者随机**: 随机选择群成员进行发言，可以有的人多说几句，有的暂时沉默。\n`;
    prompt += `   - **对话连贯性**: 对话内容应整体围绕我和其他成员的发言展开，保持逻辑连贯性。\n\n`;
    prompt += `5. **行为准则**:\n`;
    prompt += `   - 严格扮演每个角色的人设，并利用他们的专属记忆来回应相关话题。\n`;
    prompt += `   - 我（用户）可能会发送如 \`[红包]\`、\`[语音]\` 等特殊消息，或发送 \`[xx邀请xx加入了群聊]\` 或 \`[xx修改群名为：xxx]\` 这样的系统通知，你需要理解这些消息的含义并让群成员做出相应反应。\n`;
    prompt += `   - **抢红包**: 当群里出现红包时，未领取过该红包的成员可以随机决定是否“抢红包”。如果决定抢，你必须为该成员生成一条格式为 \`[{领取者真名}接收{发红包者真名}的红包]\` 的指令，**这条指令本身不会显示给用户**，但会触发红包状态的变化并生成一条“xx领取了xx的红包”的系统通知。你可以让多个成员陆续抢同一个红包。\n`;
    prompt += `   - 角色们偶尔也会犯错，可以撤回自己刚刚发出的消息。操作方式是：发送一条格式为 \`[{成员真名}撤回了一条消息]\` 的指令。\n`;
    prompt += `   - 保持对话的持续性，不要主动结束对话。\n\n`;
    prompt += `现在，请根据以上设定，开始扮演群聊中的所有角色。`;
    return prompt;
}

async function getAiReply(customPrompt = null, messages = null, imageBase64 = null) {
    const isInternalCall = !!customPrompt;
    if (isGenerating && !isInternalCall) return null;

    const { url, key, model, provider } = db.apiSettings;
    if (!url || !key || !model) {
        if (!isInternalCall) { 
             showToast('请先在"api"应用中完成设置！');
             switchScreen('api-settings-screen');
        }
        return null;
    }

    const chat = (currentChatType && currentChatId) ? (currentChatType === 'private' ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId)) : null;

    if (!chat && !isInternalCall) return null;

    isGenerating = true;
    updateSendAiButtonState();
    
    if (chat && !isInternalCall) {
        const typingName = currentChatType === 'private' ? chat.remarkName : chat.name;
        getEl('typing-indicator').textContent = `"${typingName}"正在输入中...`;
        getEl('typing-indicator').style.display = 'block';
        getEl('message-area').scrollTop = getEl('message-area').scrollHeight;
    }

    try {
        let systemPrompt, messagesToSend;
        let openaiPayload = {}; 
        if (isInternalCall) {
            systemPrompt = customPrompt;
            messagesToSend = messages || [];
        } else if (chat) {
             systemPrompt = (currentChatType === 'private') ? generatePrivateSystemPrompt(chat) : generateGroupSystemPrompt(chat);
             messagesToSend = chat.history.filter(m => !m.isHidden).slice(-(chat.maxMemory || 10)).map(m => ({ role: m.role, content: m.content }));
        }
       
        let payloadMessages = [{ role: 'system', content: systemPrompt }, ...messagesToSend];
        let response;
        const stream = !isInternalCall && !imageBase64;
        
        if (isInternalCall && customPrompt.includes("视频通话请求")) {
            if (provider !== 'gemini') {
                 openaiPayload.response_format = { "type": "json_object" };
            }
        }
        
        if (imageBase64 && provider === 'gemini') {
            const lastUserMessage = payloadMessages[payloadMessages.length - 1];
            if (lastUserMessage.role === 'user') {
                 const geminiContents = payloadMessages.slice(0, -1).map(m => ({ 
                    role: m.role === 'assistant' ? 'model' : 'user', 
                    parts: [{ text: m.content }] 
                }));

                geminiContents.push({
                    role: 'user',
                    parts: [
                        { text: `[${(chat.me?.nickname || '我')}的消息：图片] [图片描述：请描述这张图片，并根据我们的关系和你的角色设定进行回应。]` },
                        { inline_data: { mime_type: "image/jpeg", data: imageBase64.split(',')[1] } }
                    ]
                });
                
                const geminiPayload = { 
                    contents: geminiContents,
                    system_instruction: { parts: [{ text: systemPrompt }] }, 
                    generationConfig: {} 
                };
                 
                const fetchUrl = `${url}/v1beta/models/${model}:generateContent?key=${key}`;
                response = await fetch(fetchUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(geminiPayload) });

            }
        } else { // Standard text chat
            if (provider === 'gemini') {
                 const geminiPayload = { contents: payloadMessages.map(m => ({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] })), system_instruction: { parts: [{ text: systemPrompt }] }, generationConfig: {} };
                 if(geminiPayload.contents[0]?.role === 'user' && geminiPayload.contents[0]?.parts[0].text.includes(systemPrompt)) geminiPayload.contents.shift(); 
                 const fetchUrl = stream ? `${url}/v1beta/models/${model}:streamGenerateContent?key=${key}` : `${url}/v1beta/models/${model}:generateContent?key=${key}`;
                 response = await fetch(fetchUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(geminiPayload) });
            } else {
                openaiPayload = { ...openaiPayload, model, messages: payloadMessages, stream };
                response = await fetch(`${url}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` }, body: JSON.stringify(openaiPayload) });
            }
        }

        if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);

        if (stream) {
            await processStream(response, chat, provider === 'gemini' ? 'gemini' : 'openai');
            return "STREAM_SUCCESS";
        } else {
            const data = await response.json();
            const replyText = (provider === 'gemini') ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            if(isInternalCall) {
                return replyText;
            } else {
                 const messages = replyText.match(/\[.*?\]/g) || [];
                 messages.forEach(msgContent => {
                    const message = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: msgContent.trim(), timestamp: Date.now() };
                    chat.history.push(message);
                    addMessageBubble(message);
                 });
                 saveData();
                 renderChatList();
                 return "SUCCESS";
            }
        }
    } catch (error) {
        console.error('AI回复失败:', error);
        if (!isInternalCall) showToast(`AI回复失败: ${error.message}`);
        return null;
    } finally {
        isGenerating = false;
        if (chat && !isInternalCall) {
            getEl('typing-indicator').style.display = 'none';
        }
        updateSendAiButtonState();
    }
}
    
async function processStream(response, chat, apiType) { 
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullResponse = "";
    let accumulatedChunk = "";
    
    for (;;) {
        const { done, value } = await reader.read();
        if (done) break;
        accumulatedChunk += decoder.decode(value, { stream: true });
        
        if (apiType === "openai") {
            const parts = accumulatedChunk.split("\n");
            accumulatedChunk = parts.pop();
            for (const part of parts) {
                if (part.startsWith("data: ")) {
                    const data = part.substring(6);
                    if (data.trim() !== "[DONE]") {
                        try {
                            fullResponse += JSON.parse(data).choices[0].delta?.content || "";
                        } catch (e) {
                            console.error("Error parsing stream part:", data);
                        }
                    }
                }
            }
        } else if (apiType === "gemini") {
            fullResponse += accumulatedChunk.replace(/^data: /gm, "").split('\n').map(line => {
                try {
                    const parsed = JSON.parse(line);
                    return parsed.candidates?.[0]?.content?.parts?.[0]?.text || "";
                } catch {
                    return ""
                }
            }).join('');
            accumulatedChunk = "";
        }
    }

    if (fullResponse) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        if (!chat) return;

        const allMessages = fullResponse.match(/\[.*?\]|<orange[^>]*>[\s\S]*?<\/orange>|<puppy>[\s\S]*?<\/puppy>/g) || [];
        
        for (const msgContent of allMessages) {
            
            if (msgContent.startsWith('<orange') || msgContent.startsWith('<puppy')) {
                 const message = {
                    id: `msg_${Date.now()}_${Math.random()}`,
                    role: 'assistant',
                    content: `[html_card:${msgContent.trim()}]`,
                    timestamp: Date.now()
                };
                 if (currentChatType === 'group') {
                    const charMatch = msgContent.match(/<orange char="([^"]+)"/);
                    if(charMatch) {
                        const senderName = charMatch[1];
                        const sender = chat.members.find(m => m.realName === senderName);
                        if (sender) message.senderId = sender.id;
                    }
                 }
                 chat.history.push(message);
                 addMessageBubble(message);
                 continue;
            }


            const retractionMatch = msgContent.match(/\[(.*?)撤回了一条消息\]/);

            if (retractionMatch && retractionMatch[1]) {
                const retractingCharacterName = retractionMatch[1].trim();
                let lastMessageIndex = -1;

                for (let i = chat.history.length - 1; i >= 0; i--) {
                    const msg = chat.history[i];
                    if (msg.isRetracted) continue; 
                    let senderName = '';

                    if (currentChatType === 'private') {
                         const assignedChar = db.characters.find(c => c.id === chat.assignedCharId) || {};
                         if (msg.role === 'assistant') senderName = assignedChar.realName;
                    } else {
                        const sender = chat.members.find(m => m.id === msg.senderId);
                        if (sender) senderName = sender.realName;
                    }

                    if (senderName === retractingCharacterName) {
                        lastMessageIndex = i;
                        break;
                    }
                }
                
                if (lastMessageIndex > -1) {
                    chat.history[lastMessageIndex].isRetracted = true;
                    chat.history[lastMessageIndex].originalContent = chat.history[lastMessageIndex].content;
                    chat.history[lastMessageIndex].senderName = retractingCharacterName;
                    chat.history[lastMessageIndex].content = '[消息已撤回]';
                }

            } else { 
                const message = { 
                    id: `msg_${Date.now()}_${Math.random()}`, 
                    role: 'assistant', 
                    content: msgContent.trim(), 
                    timestamp: Date.now() 
                };

                if (currentChatType === 'private') {
                    if(/\[.*?的位置：.*?\]/.test(message.content)){
                        try {
                           const locData = JSON.parse(message.content.match(/\[.*?的位置：([\s\S]+?)\]/)[1]);
                           message.locationData = locData;
                        } catch(e){ console.error("Failed to parse location data from AI"); }
                    }
                    else if(/\[.*?的转账：.*?\]/.test(message.content) || /\[.*?的红包：.*?\]/.test(message.content)) message.transferStatus = 'pending';
                    else if (/\[.*?送来的礼物：.*?\]/.test(message.content)) message.giftStatus = 'sent';
                    chat.history.push(message);
                    addMessageBubble(message);
                } else { 
                     const nameMatch = message.content.match(/\[(.*?)的消息：/);
                     if(nameMatch) {
                        const senderName = nameMatch[1];
                        const sender = chat.members.find(m => m.realName === senderName);
                        if (sender) {
                            message.senderId = sender.id;
                            if(/\[.*?的转账：.*?\]/.test(message.content) || /\[.*?的红包：.*?\]/.test(message.content)) message.transferStatus = 'pending';
                            else if (/\[.*?送来的礼物：.*?\]/.test(message.content)) message.giftStatus = 'sent';
                            chat.history.push(message);
                            addMessageBubble(message);
                        }
                     }
                }
            }
        }
        
        saveData();
        renderMessages(false, true); 
        renderChatList();
    }
}
    
    function setupStickerSystem() {
        getEl('add-new-sticker-btn').addEventListener('click', () => {
            getEl('add-sticker-modal-title').textContent = '添加新表情';
            getEl('add-sticker-form').reset();
            getEl('sticker-edit-id').value = '';
            getEl('sticker-preview').innerHTML = '<span>预览</span>';
            getEl('sticker-url-input').disabled = false;
            
            getEl('single-sticker-inputs').style.display = 'block';
            getEl('batch-sticker-inputs').style.display = 'none';
            getEl('toggle-sticker-mode-btn').textContent = '切换到批量模式';

            getEl('add-sticker-modal').classList.add('visible');
        });
        
        getEl('toggle-sticker-mode-btn').addEventListener('click', (e) => {
            e.preventDefault();
            const singleInputs = getEl('single-sticker-inputs');
            const batchInputs = getEl('batch-sticker-inputs');
            if(singleInputs.style.display === 'block') {
                singleInputs.style.display = 'none';
                batchInputs.style.display = 'block';
                e.target.textContent = '切换到单个模式';
            } else {
                singleInputs.style.display = 'block';
                batchInputs.style.display = 'none';
                e.target.textContent = '切换到批量模式';
            }
        });

        getEl('add-sticker-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const isBatchMode = getEl('batch-sticker-inputs').style.display === 'block';

            if (isBatchMode) {
                const batchText = getEl('batch-sticker-textarea').value.trim();
                const stickersRaw = batchText.split(',');
                let addedCount = 0;
                stickersRaw.forEach(item => {
                    const match = item.match(/(.+?)(https?:\/\/[^\s]+)/);
                    if (match && match[1] && match[2]) {
                        const name = match[1].trim();
                        const data = match[2].trim();
                        db.myStickers.push({ id: `sticker_${Date.now()}_${Math.random()}`, name, data });
                        addedCount++;
                    }
                });
                showToast(`成功添加 ${addedCount} 个表情！`);
            } else {
                const name = getEl('sticker-name').value.trim();
                const id = getEl('sticker-edit-id').value;
                const previewImg = getEl('sticker-preview').querySelector('img');
                const data = previewImg ? previewImg.src : null;
                if (!name || !data) return showToast('请填写表情名称并提供图片');
                const stickerData = { name, data };
                if (id) {
                    const index = db.myStickers.findIndex(s => s.id === id);
                    if (index > -1) db.myStickers[index] = { ...db.myStickers[index], ...stickerData };
                } else {
                    stickerData.id = `sticker_${Date.now()}`;
                    db.myStickers.push(stickerData);
                }
                showToast('表情包已保存');
            }
            
            saveData();
            renderStickerGrid();
            getEl('add-sticker-modal').classList.remove('visible');
        });
        
        getEl('sticker-url-input').addEventListener('input', (e) => {
            getEl('sticker-preview').innerHTML = `<img src="${e.target.value}" alt="预览">`;
            getEl('sticker-file-upload').value = ''; 
        });
        
        getEl('sticker-file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 200, maxHeight: 200 });
                    getEl('sticker-preview').innerHTML = `<img src="${compressedUrl}" alt="预览">`;
                    getEl('sticker-url-input').value = ''; 
                    getEl('sticker-url-input').disabled = true;
                } catch (error) { showToast('表情包压缩失败，请重试'); }
            }
        });

        getEl('edit-sticker-btn').addEventListener('click', () => {
            if (!currentStickerActionTarget) return;
            const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
            if (sticker) {
                getEl('single-sticker-inputs').style.display = 'block';
                getEl('batch-sticker-inputs').style.display = 'none';
                getEl('toggle-sticker-mode-btn').style.display = 'none';

                getEl('add-sticker-modal-title').textContent = '编辑表情';
                getEl('sticker-edit-id').value = sticker.id;
                getEl('sticker-name').value = sticker.name;
                getEl('sticker-preview').innerHTML = `<img src="${sticker.data}" alt="预览">`;
                getEl('sticker-url-input').value = sticker.data.startsWith('http') ? sticker.data : '';
                getEl('sticker-url-input').disabled = !sticker.data.startsWith('http');
                getEl('add-sticker-modal').classList.add('visible');
            }
            getEl('sticker-actionsheet').classList.remove('visible');
            currentStickerActionTarget = null;
        });

        getEl('delete-sticker-btn').addEventListener('click', () => {
            if (!currentStickerActionTarget) return;
            const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
            if (sticker && confirm(`确定要删除表情"${sticker.name}"吗？`)) {
                db.myStickers = db.myStickers.filter(s => s.id !== currentStickerActionTarget);
                saveData();
                renderStickerGrid();
                showToast('表情已删除');
            }
            getEl('sticker-actionsheet').classList.remove('visible');
            currentStickerActionTarget = null;
        });
    }

    function addDefaultStickers() {
        const defaultStickersText = "眼睛亮晶晶/期待https://files.catbox.moe/i0ov5h.png,不要和我说话https://files.catbox.moe/wnr64t.png,不对劲https://files.catbox.moe/itw2h1.png,啧https://files.catbox.moe/w206rr.png,哭哭https://files.catbox.moe/rw1cfk.png,讨好https://files.catbox.moe/7fwfte.png,问号https://files.catbox.moe/to45ts.png,盯——https://files.catbox.moe/9za97q.png,“草”https://files.catbox.moe/9b800k.png,震惊https://files.catbox.moe/q7683x.png,委屈哭哭https://files.catbox.moe/u94gd8.png,爱心https://files.catbox.moe/ne6dii.png,偷看你https://files.catbox.moe/72wkme.png,老实https://files.catbox.moe/hgfgj3.png,泪流成河https://files.catbox.moe/nh9r23.png,炸毛生气https://files.catbox.moe/si6f0k.png,我恨https://files.catbox.moe/r6g32h.png,大脑短路https://files.catbox.moe/d41e2q.png,打电话哭哭https://files.catbox.moe/8ejal5.png,揉脸https://files.catbox.moe/9lmwuz.png,这是屎吗https://files.catbox.moe/r26gox.png,哀怨/不满https://files.catbox.moe/3xu8xr.png,生气/不满https://files.catbox.moe/2fskww.png,满脸疑惑https://files.catbox.moe/skv9p6.png,哈特软软/好喜欢https://files.catbox.moe/0bmbi0.png,OKhttps://files.catbox.moe/71kn5e.png,被训https://files.catbox.moe/sgkcwv.png,哀怨/生闷气https://files.catbox.moe/1n905b.png,蹭蹭/撒娇https://files.catbox.moe/9p0x2t.png,喜欢https://files.catbox.moe/opqz7o.png,嫌弃https://files.catbox.moe/t2e0nt.png,被吓一跳https://files.catbox.moe/26xc9h.png,心虚https://files.catbox.moe/zt4t1s.png,淋雨哭泣https://files.catbox.moe/l68nws.png,睡了https://files.catbox.moe/7wbc1d.png,无语https://files.catbox.moe/wgkwjh.png,升天了https://files.catbox.moe/o8td90.png,非常认可https://files.catbox.moe/3s5ipf.png,竖中指https://files.catbox.moe/z25fao.png,尴尬https://files.catbox.moe/8eaawd.png,害羞https://files.catbox.moe/bsomey.png,投降https://files.catbox.moe/f4ogyw.png,生气https://files.catbox.moe/b5egx6.png,晚安https://files.catbox.moe/duzx7n.png,爱你https://files.catbox.moe/p67llx.png,生气https://files.catbox.moe/xsmgb0.png,睡会儿/困https://files.catbox.moe/6u5ch8.png,精神涣散https://files.catbox.moe/4oeevo.png,多喝热水https://files.catbox.moe/gs9ppe.png,吐魂https://files.catbox.moe/7yejey.png,打哈欠/好困https://files.catbox.moe/fuyq6d.png,大脑过载https://files.catbox.moe/kq9i8f.png,已老实https://files.catbox.moe/6eyzlg.png,我想想https://files.catbox.moe/324d33.png,按头https://files.catbox.moe/pfnrya.png,无语https://files.catbox.moe/00lj4d.png,爆哭https://files.catbox.moe/dbyrdf.png,期待https://files.catbox.moe/81c7qy.png,捏爆地球https://files.catbox.moe/h1kt1u.png,来啦来啦https://files.catbox.moe/afuns1.png,那咋了https://files.catbox.moe/dhp2gr.png,想咋地https://files.catbox.moe/3ruhin.png,哈？https://files.catbox.moe/k0uru3.png,心虚https://files.catbox.moe/6uqxds.png,怎么样打死我https://files.catbox.moe/doag9c.png,围观https://files.catbox.moe/428w1c.png,好厉害（不走心）https://files.catbox.moe/tt548x.png,坏笑https://files.catbox.moe/vnpmxr.png,装酷https://files.catbox.moe/p9v3sq.png,红温https://files.catbox.moe/gmvx6d.png,可怜兮兮https://files.catbox.moe/u77bks.png,大惊失色https://files.catbox.moe/w7olag.png,难过https://files.catbox.moe/ydyx59.png,爆哭https://files.catbox.moe/69kl2l.png,自闭https://files.catbox.moe/nhtazq.png,摆烂https://files.catbox.moe/cq6ipd.png,那又如何https://files.catbox.moe/do83tr.png,思考https://files.catbox.moe/32ql1h.png,爱你https://files.catbox.moe/x5u5sm.png";
        const stickersRaw = defaultStickersText.split(',');
        stickersRaw.forEach(item => {
            const match = item.match(/(.+?)(https?:\/\/[^\s]+)/);
            if (match && match[1] && match[2]) {
                const name = match[1].trim();
                const data = match[2].trim();
                db.myStickers.push({ id: `sticker_default_${Date.now()}_${Math.random()}`, name, data });
            }
        });
        saveData();
    }

    function renderStickerGrid() { const container = getEl('sticker-grid-container'); container.innerHTML = ''; if (db.myStickers.length === 0) { container.innerHTML = '<p style="color:#aaa; text-align:center;">还没有表情包，快去添加吧！</p>'; return; } db.myStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.innerHTML = `<img src="${sticker.data}" alt="${sticker.name}"><span>${sticker.name}</span>`; item.addEventListener('click', () => sendSticker(sticker)); const startLongPress = (e) => { if (e.type === 'mousedown' && e.button !== 0) return; e.stopPropagation(); longPressTimer = setTimeout(() => { currentStickerActionTarget = sticker.id; getEl('sticker-actionsheet').classList.add('visible'); }, 500); }; const cancelLongPress = () => clearTimeout(longPressTimer); item.addEventListener('mousedown', startLongPress); item.addEventListener('mouseup', cancelLongPress); item.addEventListener('mouseleave', cancelLongPress); item.addEventListener('touchstart', startLongPress); item.addEventListener('touchend', cancelLongPress); item.addEventListener('touchmove', cancelLongPress); container.appendChild(item); }); }
    function setupVoiceMessageSystem() { getEl('send-voice-modal').addEventListener('click', (e) => { if (e.target === getEl('send-voice-modal')) getEl('send-voice-modal').classList.remove('visible'); }); getEl('voice-text-input').addEventListener('input', (e) => { getEl('voice-duration-preview').textContent = `${calculateVoiceDuration(e.target.value)}"`; }); getEl('send-voice-form').addEventListener('submit', (e) => { e.preventDefault(); sendMyVoiceMessage(getEl('voice-text-input').value.trim()); }); }
    
    function setupPhotoVideoSystem() { 
        getEl('image-upload-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(file){
                try {
                    const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 800, maxHeight: 800 });
                    sendMessage(compressedUrl);
                } catch(err) {
                    showToast('图片处理失败，请重试');
                }
            }
        });

        getEl('send-pv-form').addEventListener('submit', (e) => {
            e.preventDefault();
            sendMyPhotoVideo(getEl('pv-text-input').value.trim());
        });
    }

    function setupCameraSystem() {
        getEl('send-camera-form').addEventListener('submit', (e) => {
            e.preventDefault();
            sendCameraMessage(getEl('camera-text-input').value.trim());
        });
    }
    
    function setupWalletSystem() { 
        getEl('send-transfer-form').addEventListener('submit', (e) => { 
            e.preventDefault(); 
            const amount = getEl('transfer-amount-input').value; 
            const remark = getEl('transfer-remark-input').value.trim();
            const recipientId = getEl('send-transfer-form').dataset.recipientId;
            let recipient = null;
            if (currentChatType === 'group' && recipientId) {
                const group = db.groups.find(g => g.id === currentChatId);
                recipient = group.members.find(m => m.id === recipientId);
            }
            if (amount > 0) {
                 sendMyTransfer(amount, remark, recipient); 
            } else {
                 showToast('请输入有效的金额'); 
            }
        }); 
        
        getEl('receive-transfer-actionsheet').addEventListener('click', (e) => { 
            if(e.target === getEl('receive-transfer-actionsheet')) { 
                getEl('receive-transfer-actionsheet').classList.remove('visible'); 
                currentTransferMessageId = null; 
            } 
        }); 
        getEl('accept-transfer-btn').addEventListener('click', () => respondToTransfer('received')); 
        getEl('return-transfer-btn').addEventListener('click', () => respondToTransfer('returned')); 
    }
    
    function openTransferModal(isHongbao) {
        getEl('send-transfer-form').reset();
        getEl('send-transfer-form').dataset.recipientId = '';
        getEl('transfer-recipient-group').style.display = 'none';
        getEl('send-transfer-title').textContent = isHongbao ? '发红包' : '转账';

        if (currentChatType === 'group' && !isHongbao) {
            renderTransferRecipientList();
            getEl('transfer-recipient-modal').classList.add('visible');
        } else {
            getEl('send-transfer-modal').classList.add('visible');
        }
    }
    
    function renderTransferRecipientList() {
        const list = getEl('transfer-recipient-list');
        list.innerHTML = '';
        const group = db.groups.find(g => g.id === currentChatId);
        if(!group) return;
        
        group.members.forEach(member => {
            const li = document.createElement('li');
            li.className = 'list-item';
            li.innerHTML = `<img src="${member.avatar}" class="chat-avatar"> <span class="item-name">${member.groupNickname}</span>`;
            li.onclick = () => {
                 getEl('transfer-recipient-modal').classList.remove('visible');
                 getEl('transfer-recipient-name').value = member.groupNickname;
                 getEl('transfer-recipient-group').style.display = 'block';
                 getEl('send-transfer-form').dataset.recipientId = member.id;
                 getEl('send-transfer-modal').classList.add('visible');
            };
            list.appendChild(li);
        });
    }

    function handleReceivedTransferClick(messageId) { currentTransferMessageId = messageId; getEl('receive-transfer-actionsheet').classList.add('visible'); }
    function respondToTransfer(action) { if(!currentTransferMessageId) return; const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId); const message = chat.history.find(m => m.id === currentTransferMessageId); if(message) { message.transferStatus = action; const cardOnScreen = getEl('message-area').querySelector(`.message-wrapper[data-id="${currentTransferMessageId}"] .transfer-card`); if(cardOnScreen) { cardOnScreen.querySelector('.transfer-status-footer').textContent = action === 'received' ? '已收款' : '已退回'; cardOnScreen.style.cursor = 'default'; } let content = `[${chat.myName}${action === 'received' ? '接收' : '退回'}${chat.realName}的转账]`; chat.history.push({ id: `msg_${Date.now()}`, role: 'user', content, timestamp: Date.now() }); saveData(); renderChatList(); } getEl('receive-transfer-actionsheet').classList.remove('visible'); currentTransferMessageId = null; }
    function setupGiftSystem() { getEl('send-gift-modal').addEventListener('click', (e) => { if (e.target === getEl('send-gift-modal')) getEl('send-gift-modal').classList.remove('visible'); }); getEl('send-gift-form').addEventListener('submit', (e) => { e.preventDefault(); sendMyGift(getEl('gift-description-input').value.trim()); }); }
    function setupFontSettingsApp() { }
        function setupWorldBookApp() { 
        getEl('world-book-screen').addEventListener('click', e => { 
            if (e.target.closest('#add-world-book-btn')) { 
                currentEditingWorldBookId = null; 
                getEl('edit-world-book-form').reset(); 
                document.querySelector('input[name="world-book-position"][value="before"]').checked = true; 
                switchScreen('edit-world-book-screen'); 
            } 
            const item = e.target.closest('.list-item'); 
            if (item) { 
                const book = db.worldBooks.find(wb => wb.id === item.dataset.id); 
                if (book) { 
                    currentEditingWorldBookId = book.id; 
                    getEl('world-book-id').value = book.id; 
                    getEl('world-book-name').value = book.name; 
                    getEl('world-book-content').value = book.content; 
                    document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true; 
                    switchScreen('edit-world-book-screen'); 
                } 
            } 
        }); 
        
        getEl('edit-world-book-form').addEventListener('submit', (e) => { 
            e.preventDefault(); 
            const name = getEl('world-book-name').value.trim(); 
            const content = getEl('world-book-content').value.trim(); 
            if (!name || !content) return showToast('名称和内容不能为空'); 
            const position = document.querySelector('input[name="world-book-position"]:checked').value; 
            if (currentEditingWorldBookId) { 
                const book = db.worldBooks.find(wb => wb.id === currentEditingWorldBookId); 
                if (book) Object.assign(book, { name, content, position }); 
            } else { 
                db.worldBooks.push({ id: `wb_${Date.now()}`, name, content, position }); 
            } 
            saveData(); 
            showToast('世界书条目已保存'); 
            renderWorldBookList(); 
            switchScreen('world-book-screen'); 
        }); 

        const wbList = getEl('world-book-list-container'); 
        wbList.addEventListener('contextmenu', e => {
            e.preventDefault();
            const item = e.target.closest('.list-item'); 
            if (!item) return;
            const bookId = item.dataset.id;
            createContextMenu([{ label: '删除', danger: true, action: () => { 
                if (confirm('确定要删除这个世界书条目吗？')) { 
                    db.worldBooks = db.worldBooks.filter(wb => wb.id !== bookId); 
                    db.characters.forEach(char => { char.worldBookIds = (char.worldBookIds || []).filter(id => id !== bookId); }); 
                    db.groups.forEach(group => { group.worldBookIds = (group.worldBookIds || []).filter(id => id !== bookId); });
                    saveData(); 
                    renderWorldBookList(); 
                    showToast('条目已删除'); 
                } 
            } }], e.clientX, e.clientY);
        });
    }
    
    function renderWorldBookList() { const container = getEl('world-book-list-container'); container.innerHTML = ''; getEl('no-world-books-placeholder').style.display = db.worldBooks.length === 0 ? 'block' : 'none'; db.worldBooks.forEach(book => { const li = document.createElement('li'); li.className = 'list-item world-book-item'; li.dataset.id = book.id; li.innerHTML = `<div class="item-details" style="padding-left: 20px;"><div class="item-name">${book.name}</div><div class="item-preview">${book.content}</div></div>`; container.appendChild(li); }); }
    function setupChatSettings() {
    getEl('chat-settings-btn').addEventListener('click', () => { 
        if (currentChatType === 'private') { 
            loadSettingsToSidebar(); 
            getEl('chat-settings-sidebar').classList.add('open'); 
        } else if (currentChatType === 'group') { 
            loadGroupSettingsToSidebar(); 
            getEl('group-settings-sidebar').classList.add('open'); 
        } 
    }); 
    
    getEl('chat-settings-form').addEventListener('submit', e => { 
        e.preventDefault(); 
        saveSettingsFromSidebar(); 
    }); 
    
    getEl('setting-chat-bg-upload').addEventListener('change', async (e) => { 
        const file = e.target.files[0]; 
        if (file) { 
            const char = db.characters.find(c => c.id === currentChatId); 
            if (char) try { 
                const url = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 }); 
                char.chatBg = url; 
                getEl('chat-room-screen').style.backgroundImage = `url(${url})`; 
                saveData(); 
                showToast('聊天背景已更换'); 
            } catch (err) { 
                showToast('背景压缩失败'); 
            } 
        } 
    }); 
    
    getEl('clear-chat-history-btn').addEventListener('click', () => { 
        const char = db.characters.find(c => c.id === currentChatId); 
        if (char && confirm(`你确定要清空与"${char.remarkName}"的所有聊天记录吗？`)) { 
            char.history = []; 
            char.autoMemory.lastExtractionCount = 0; 
            saveData(); 
            renderMessages(false, true); 
            renderChatList(); 
            getEl('chat-settings-sidebar').classList.remove('open'); 
            showToast('聊天记录已清空'); 
        } 
    }); 
    
    getEl('extract-memory-btn').addEventListener('click', async (e) => { 
        const btn = e.currentTarget; 
        btn.classList.add('loading'); 
        btn.disabled = true; 
        try { 
            await extractAndStoreMemory(currentChatId, 'private');
        } catch (error) { 
            console.error("Memory Extraction Failed:", error); 
            showToast(`记忆提取失败: ${error.message}`); 
        } finally { 
            btn.classList.remove('loading'); 
            btn.disabled = false; 
        } 
    });

    getEl('link-world-book-btn').addEventListener('click', () => { 
        const chat = db.characters.find(c => c.id === currentChatId); 
        if (!chat) return; 
        getEl('world-book-selection-list').innerHTML = db.worldBooks.map(book => `<li class="world-book-select-item"><input type="checkbox" id="wb-select-${book.id}" value="${book.id}" ${(chat.worldBookIds || []).includes(book.id) ? 'checked' : ''}><label for="wb-select-${book.id}">${book.name}</label></li>`).join(''); 
        getEl('world-book-selection-modal').classList.add('visible'); 
    }); 
    
    getEl('save-world-book-selection-btn').addEventListener('click', (e) => { 
        e.stopPropagation(); 
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        if (!chat) return; 
        chat.worldBookIds = [...getEl('world-book-selection-list').querySelectorAll('input:checked')].map(input => input.value); 
        saveData(); 
        getEl('world-book-selection-modal').classList.remove('visible'); 
        showToast('世界书关联已更新'); 
    }); 

    getEl('assign-char-btn').addEventListener('click', () => {
        const char = db.characters.find(c => c.id === currentChatId);
        if(!char) return;
        openCharEditModal(char.assignedCharId);
    });
    getEl('assign-me-btn').addEventListener('click', () => {
        const char = db.characters.find(c => c.id === currentChatId);
        if(!char) return;
        openMeEditModal(char.assignedMeId);
    });

    getEl('add-me-profile-btn').addEventListener('click', () => {
        getEl('assign-me-modal').classList.remove('visible');
        openMeEditModal();
    });
    
    getEl('select-theme-btn-private').addEventListener('click', (e) => {
        e.stopPropagation();
        openThemeSelectionModal('private');
    });

    getEl('font-size-slider-private').addEventListener('input', () => updateSettingsPreview('private'));
    getEl('custom-css-input-private').addEventListener('input', () => updateSettingsPreview('private'));
    getEl('reset-custom-css-btn-private').addEventListener('click', () => {
        getEl('custom-css-input-private').value = '';
        updateSettingsPreview('private');
    });
}
function setupPatPatFeature() {
    getEl('message-area').addEventListener('dblclick', (e) => {
        const avatar = e.target.closest('.message-avatar');
        const wrapper = e.target.closest('.message-wrapper.received');
        if (avatar && wrapper) {
            const chat = db.characters.find(c => c.id === currentChatId);
            if (chat) {
                getEl('pat-pat-title').textContent = `你拍了拍“${chat.remarkName}”`;
                getEl('pat-pat-form').reset();
                getEl('pat-pat-modal').classList.add('visible');
            }
        }
    });

    getEl('pat-pat-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const text = getEl('pat-pat-input').value.trim();
        sendPatPat(text);
    });
}

function setupLocationFeature() {
    getEl('send-location-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = getEl('location-name-input').value.trim();
        const address = getEl('location-address-input').value.trim();
        if (name) {
            sendLocation(name, address);
        }
    });
}

function setupVideoCallSystem() {
    getEl('accept-call-btn').addEventListener('click', acceptIncomingCall);
    getEl('decline-call-btn').addEventListener('click', declineIncomingCall);
    getEl('cancel-outgoing-call-btn').addEventListener('click', () => endVideoCall(true));
    getEl('video-call-hangup-btn').addEventListener('click', () => endVideoCall(false));
    getEl('video-call-send-btn').addEventListener('click', sendVideoCallMessage);
    getEl('video-call-user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendVideoCallMessage();
        }
    });
}

async function handleInitiateCall() {
    if (!currentChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;

    Object.assign(videoCallState, {
        isGroupCall: currentChatType === 'group',
        isAwaitingResponse: true,
        initiator: 'user',
        activeChatId: chat.id,
        isUserParticipating: true,
        participants: []
    });

    const avatar = chat.avatar || (currentChatType === 'private' ? 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg' : 'https://i.postimg.cc/fTLCngk1/image.jpg');
    const name = chat.name || chat.remarkName;

    getEl('outgoing-call-avatar').src = avatar;
    getEl('outgoing-call-name').textContent = name;
    getEl('outgoing-call-text').textContent = "正在呼叫...";
    switchScreen('outgoing-call-screen');

    const me = (currentChatType === 'private') 
        ? db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0] 
        : { myName: chat.me.nickname };

    const requestMessage = {
        role: 'system',
        content: `[系统提示：用户 ${me.myName}向你发起了视频通话请求。请根据你的人设，只回复一个包含JSON对象的数组。接受：[{"type": "video_call_response", "decision": "accept"}] 或 拒绝：[{"type": "video_call_response", "decision": "reject"}]]`,
        timestamp: Date.now(),
        isHidden: true,
    };
    
    // For groups, we need a different prompt and handling
    if (videoCallState.isGroupCall) {
        requestMessage.content = `[系统提示：用户 (${me.myName}) 发起了群视频通话请求。请你们各自决策，并使用 "group_call_response" 指令，在 "decision" 字段中设置为 "join" 或 "decline" 来回应。]`;
    }
    
    chat.history.push(requestMessage);
    saveData();
    
    const decisionResponse = await getAiReply(requestMessage.content, [requestMessage]);
    
    if (videoCallState.isAwaitingResponse) { 
        if (videoCallState.isGroupCall) {
            handleAiGroupCallDecision(decisionResponse);
        } else {
            handleAiCallDecision(decisionResponse);
        }
    }
}
function handleAiCallDecision(response) {
    if (!response) {
        showToast("对方无应答。");
        endVideoCall(true);
        return;
    }
    
    try {
        const cleanedResponse = response.replace(/```json|```/g, '').trim();
        const decisionData = JSON.parse(cleanedResponse);
        const decision = Array.isArray(decisionData) ? decisionData[0] : decisionData;

        if (decision.type === 'video_call_response' && decision.decision === 'accept') {
            const chat = db.characters.find(c => c.id === videoCallState.activeChatId);
            videoCallState.participants.push({ id: chat.id, name: chat.realName, avatar: chat.avatar });
            startVideoCall();
        } else {
            showToast("对方拒绝了通话请求。");
            endVideoCall(true);
        }
    } catch (e) {
        console.error("AI通话决策解析失败:", e, "原始回复:", response);
        showToast("对方响应异常，无法建立通话。");
        endVideoCall(true);
    }
}

function handleAiGroupCallDecision(response) {
    if (!response) {
        showToast("群成员均未响应。");
        endVideoCall(true);
        return;
    }

    try {
        const cleanedResponse = response.replace(/```json|```/g, '').trim();
        const decisions = JSON.parse(cleanedResponse);
        const group = db.groups.find(g => g.id === videoCallState.activeChatId);

        decisions.forEach(decision => {
            if (decision.type === 'group_call_response' && decision.decision === 'join') {
                const member = group.members.find(m => m.realName === decision.participant);
                if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                    videoCallState.participants.push({ id: member.id, name: member.realName, groupNickname: member.groupNickname, avatar: member.avatar });
                }
            }
        });

        if (videoCallState.participants.length > 0) {
            startVideoCall();
        } else {
            showToast("无人加入通话。");
            endVideoCall(true);
        }
    } catch (e) {
        console.error("AI群聊通话决策解析失败:", e, "原始回复:", response);
        showToast("群成员响应异常，无法建立通话。");
        endVideoCall(true);
    }
}

function startVideoCall() {
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;

    Object.assign(videoCallState, {
        isActive: true,
        isAwaitingResponse: false,
        startTime: Date.now(),
        callHistory: []
    });
    
    const preCallHistory = chat.history.filter(m => !m.isHidden).slice(-10);
    videoCallState.preCallContext = preCallHistory.map(msg => {
        const sender = msg.role === 'user' ? (chat.me?.nickname || '我') : (msg.senderName || chat.remarkName || '成员');
        const contentMatch = msg.content.match(/\[.*?的消息：([\s\S]+?)\]/);
        const text = contentMatch ? contentMatch[1] : msg.content;
        return `${sender}: ${text.substring(0, 50)}...`;
    }).join('\n');

    updateParticipantAvatars();
    getEl('video-call-main').innerHTML = `<em>正在接通...</em>`;
    switchScreen('video-call-screen');

    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallTimer, 1000);
    updateCallTimer();

    triggerAiInCallAction();
}

async function endVideoCall(isCallFailed = false) {
    if (isCallFailed || videoCallState.isAwaitingResponse) {
        Object.assign(videoCallState, { isActive: false, isAwaitingResponse: false, activeChatId: null, initiator: null });
        if(currentChatId && currentChatType) {
            openChatRoom(currentChatId, currentChatType);
        } else {
            switchScreen('chat-list-screen');
        }
        return;
    }

    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${String(Math.floor(duration / 60)).padStart(2, '0')}:${String(duration % 60).padStart(2, '0')}`;
    
    const chat = (videoCallState.isGroupCall) ? db.groups.find(g => g.id === videoCallState.activeChatId) : db.characters.find(c => c.id === videoCallState.activeChatId);
    if (chat) {
        const endCallMessage = {
            id: `msg_system_${Date.now()}`,
            role: 'system',
            content: `[通话结束，时长 ${durationText}]`,
            timestamp: Date.now()
        };
        chat.history.push(endCallMessage);
        
        const transcriptText = videoCallState.callHistory.map(h => `${h.senderName}: ${h.content}`).join('\n');
        if (transcriptText) {
            let memoryTargetId = videoCallState.isGroupCall ? chat.id : chat.id;
            let memoryEntry = db.memoryEntries.find(m => (m.characterId === memoryTargetId) || (m.groupId === memoryTargetId));
            const newMemoryContent = `\n\n--- ${new Date().toLocaleString()}的视频通话记录 ---\n${transcriptText}`;

            if (memoryEntry) {
                memoryEntry.content += newMemoryContent;
            } else {
                 db.memoryEntries.push({
                    id: `mem_${(videoCallState.isGroupCall ? 'group' : 'char')}_${memoryTargetId}`,
                    type: videoCallState.isGroupCall ? 'group' : 'character',
                    characterId: videoCallState.isGroupCall ? null : memoryTargetId,
                    groupId: videoCallState.isGroupCall ? memoryTargetId : null,
                    topic: `与 ${chat.name || chat.remarkName} 的通话`,
                    content: newMemoryContent.trim(),
                    timestamp: Date.now()
                 });
            }
        }
        
        saveData();
    }
    
    const endedChatId = videoCallState.activeChatId;
    const endedChatType = videoCallState.isGroupCall ? 'group' : 'private';

    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };

    openChatRoom(endedChatId, endedChatType);
}

function updateParticipantAvatars() {
    const grid = getEl('participant-avatars-grid');
    grid.innerHTML = '';
    const chat = (videoCallState.isGroupCall) ? db.groups.find(g => g.id === videoCallState.activeChatId) : db.characters.find(c => c.id === videoCallState.activeChatId);
    if (!chat) return;

    let participantsToRender = [];
    if (videoCallState.isGroupCall) {
        const me = { myName: chat.me.nickname, myAvatar: chat.me.avatar };
        participantsToRender.push({ id: 'user', name: me.myName, avatar: me.myAvatar });
        videoCallState.participants.forEach(p => {
            participantsToRender.push({ id: p.id, name: p.groupNickname, avatar: p.avatar });
        });
    } else {
        participantsToRender = [
            { id: 'ai', name: chat.remarkName || chat.name, avatar: chat.avatar }
        ];
    }

    participantsToRender.forEach(p => {
        const wrapper = document.createElement('div');
        wrapper.className = 'participant-avatar-wrapper';
        wrapper.dataset.participantId = p.id;
        wrapper.innerHTML = `<img src="${p.avatar}" class="participant-avatar" alt="${p.name}"><div class="participant-name">${p.name}</div>`;
        grid.appendChild(wrapper);
    });
}

function updateCallTimer() {
    if (!videoCallState.isActive || !videoCallState.startTime) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    getEl('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function showIncomingCallModal() { /* Logic for AI initiating call can be added here if needed */ }
function acceptIncomingCall() { /* Logic for AI initiating call can be added here if needed */ }
function declineIncomingCall() { /* Logic for AI initiating call can be added here if needed */ }

function sendVideoCallMessage() {
    const input = getEl('video-call-user-input');
    const text = input.value.trim();
    if (text) {
        const chat = (videoCallState.isGroupCall) ? db.groups.find(g => g.id === videoCallState.activeChatId) : db.characters.find(c => c.id === videoCallState.activeChatId);
        const me = { myName: chat.me?.nickname || '我' };

        const callFeed = getEl('video-call-main');
        const userBubble = document.createElement('div');
        userBubble.className = 'call-message-bubble user-speech';
        userBubble.textContent = text;
        callFeed.appendChild(userBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ senderName: me.myName, content: text });
        
        triggerAiInCallAction();
        input.value = '';
    }
}

async function triggerAiInCallAction() {
    if (!videoCallState.isActive) return;

    const chat = (videoCallState.isGroupCall) ? db.groups.find(g => g.id === videoCallState.activeChatId) : db.characters.find(c => c.id === videoCallState.activeChatId);
    const callFeed = getEl('video-call-main');
    const me = (videoCallState.isGroupCall) 
        ? { myName: chat.me.nickname, myPersona: chat.me.persona } 
        : db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0];

    let inCallPrompt;
    if (videoCallState.isGroupCall) {
        const participantDetails = videoCallState.participants.map(p => `- ${p.groupNickname} (人设: ${p.persona})`).join('\n');
        inCallPrompt = `
        你是一个群聊视频通话的导演。你的任务是扮演所有【除了用户以外】的AI角色，并以【第三人称旁观视角】来描述他们在通话中的所有动作和语言。
        # 核心规则
        - **视角铁律**: 你的回复【绝对不能】使用第一人称“我”。
        - **互动性**: 你的描述必须紧密围绕用户的最新发言进行互动，不能脱离用户自己发展剧情。
        - **简洁性**: 每次生成的总描述文字【不能超过200字】。
        - **格式**: 你的回复【必须】是一个JSON数组，每个对象代表一个角色的发言，格式为：[{"name": "角色真名", "speech": "旁白描述"}, ...]
        - **角色扮演**: 严格遵守每个角色的设定。
        # 当前情景
        你们正在“${chat.name}”群的视频通话中。
        **通话前聊天摘要**: ${videoCallState.preCallContext}
        **当前参与者**:
        - ${me.myName} (用户, 人设: ${me.myPersona})
        ${participantDetails}
        现在，请根据【通话实时记录】，继续进行对话。`;

    } else { // Single call
        const aiPersona = chat.persona || "一个友好的人";
        inCallPrompt = `
        你现在是一个场景描述引擎。你的任务是扮演 ${chat.remarkName}（人设: ${aiPersona}），并以【第三人称旁观视角】来描述TA在视频通话中的所有动作和语言。
        # 核心规则
        - **视角铁律**: 你的回复【绝对不能】使用第一人称“我”。必须使用第三人称。
        - **互动性**: 你的描述必须紧密围绕用户的最新发言进行互动，不能脱离用户自己发展剧情。
        - **简洁性**: 你的描述【不能超过200字】。
        - **格式**: 你的回复【必须】是一段描述性的文本。
        # 当前情景
        你正在和用户（${me.myName}，人设: ${me.myPersona}）进行视频通话。
        **通话前聊天摘要**: ${videoCallState.preCallContext}
        现在，请根据【通话实时记录】，继续进行对话。`;
    }

    const messagesForApi = [
        { role: 'system', content: inCallPrompt },
        ...videoCallState.callHistory.map(h => ({ role: 'user', content: `${h.senderName}: ${h.content}` }))
    ];

    try {
        const aiResponse = await getAiReply(inCallPrompt, messagesForApi);
        if (aiResponse) {
            const connectingElement = callFeed.querySelector('em');
            if (connectingElement) connectingElement.remove();

            if(videoCallState.isGroupCall) {
                const speechArray = JSON.parse(aiResponse.replace(/```json|```/g, ''));
                speechArray.forEach(turn => {
                    const member = videoCallState.participants.find(p => p.name === turn.name);
                    if(!member) return;

                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'call-message-bubble ai-speech';
                    aiBubble.innerHTML = `<strong>${member.groupNickname}:</strong> ${turn.speech}`;
                    callFeed.appendChild(aiBubble);
                    videoCallState.callHistory.push({ senderName: member.groupNickname, content: turn.speech });

                    const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${member.id}"] .participant-avatar`);
                    if(speakingAvatar) {
                        speakingAvatar.classList.add('speaking');
                        setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                    }
                });

            } else {
                const aiBubble = document.createElement('div');
                aiBubble.className = 'call-message-bubble ai-speech';
                aiBubble.textContent = aiResponse;
                callFeed.appendChild(aiBubble);
                videoCallState.callHistory.push({ senderName: chat.remarkName, content: aiResponse });

                const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="ai"] .participant-avatar`);
                if(speakingAvatar) {
                    speakingAvatar.classList.add('speaking');
                    setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                }
            }
            callFeed.scrollTop = callFeed.scrollHeight;
        }
    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.className = 'call-message-bubble ai-speech';
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[错误: ${error.message}]`;
        callFeed.appendChild(errorBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
    }
}


function setupPatPatFeature() {
    getEl('message-area').addEventListener('dblclick', (e) => {
        const avatar = e.target.closest('.message-avatar');
        const wrapper = e.target.closest('.message-wrapper.received');
        if (avatar && wrapper) {
            const chat = db.characters.find(c => c.id === currentChatId);
            if (chat) {
                getEl('pat-pat-title').textContent = `你拍了拍“${chat.remarkName}”`;
                getEl('pat-pat-form').reset();
                getEl('pat-pat-modal').classList.add('visible');
            }
        }
    });

    getEl('pat-pat-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const text = getEl('pat-pat-input').value.trim();
        sendPatPat(text);
    });
}

function setupLocationFeature() {
    getEl('send-location-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = getEl('location-name-input').value.trim();
        const address = getEl('location-address-input').value.trim();
        if (name) {
            sendLocation(name, address);
        }
    });
}

function showAssignModal(type, forGroup = false) {
    const modalId = forGroup ? 'assign-me-modal' : (type === 'char' ? 'assign-char-modal' : 'assign-me-modal');
    const listId = forGroup ? 'assign-me-list' : (type === 'char' ? 'assign-char-list' : 'assign-me-list');
    const modal = getEl(modalId);
    const listEl = getEl(listId);
    listEl.innerHTML = '';

    if (type === 'char' && !forGroup) {
        db.characters.forEach(char => {
            const li = document.createElement('li');
            li.className = 'list-item';
            li.innerHTML = `<img src="${char.avatar}" class="chat-avatar"> <span class="item-name">${char.remarkName}</span>`;
            li.onclick = () => {
                const currentChat = db.characters.find(c => c.id === currentChatId);
                currentChat.assignedCharId = char.id;
                saveData();
                loadSettingsToSidebar();
                modal.classList.remove('visible');
            };
            listEl.appendChild(li);
        });
    } else {
         db.meProfiles.forEach(profile => {
            const li = document.createElement('li');
            li.className = 'list-item';
            li.innerHTML = `<img src="${profile.myAvatar}" class="chat-avatar"> <span class="item-name">${profile.myName}</span>`;
            li.onclick = () => {
                const currentChat = forGroup ? db.groups.find(g => g.id === currentChatId) : db.characters.find(c => c.id === currentChatId);
                if (forGroup) {
                     currentChat.me = {
                        nickname: profile.myName,
                        persona: profile.myPersona,
                        avatar: profile.myAvatar,
                        profileId: profile.id
                    };
                    getEl('assigned-group-me-name').textContent = profile.myName;
                } else {
                    currentChat.assignedMeId = profile.id;
                    loadSettingsToSidebar();
                }
                saveData();
                modal.classList.remove('visible');
            };
            listEl.appendChild(li);
        });
    }
    modal.classList.add('visible');
}

function openThemeSelectionModal(type) {
    const modal = getEl('theme-selection-modal');
    const grid = getEl('theme-selection-grid');
    grid.innerHTML = '';
    
    Object.entries(colorThemesV2).forEach(([key, theme]) => {
        const item = document.createElement('div');
        item.className = 'theme-item';
        item.dataset.themeKey = key;
        item.textContent = theme.name;
        
        item.addEventListener('click', (e) => {
            e.stopPropagation();
            const chat = (type === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (chat) {
                if(key === 'custom') {
                    openCustomThemeModal(type);
                } else {
                    chat.theme = key;
                    chat.customTheme = null;
                    updateSettingsPreview(type);
                    getEl(`current-theme-name-${type}`).textContent = theme.name;
                }
            }
            modal.classList.remove('visible');
        });
        grid.appendChild(item);
    });

    modal.classList.add('visible');
}

function openCustomThemeModal(type) {
    const modal = getEl('custom-theme-modal');
    const form = getEl('custom-theme-form');
    const chat = (type === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    
    const currentTheme = chat.customTheme || { sent: {bg: '#ADD8E6', text: '#000000'}, received: {bg: '#FFFFFF', text: '#000000'}};
    getEl('custom-sent-bg').value = currentTheme.sent.bg;
    getEl('custom-sent-text').value = currentTheme.sent.text;
    getEl('custom-received-bg').value = currentTheme.received.bg;
    getEl('custom-received-text').value = currentTheme.received.text;

    form.onsubmit = (e) => {
        e.preventDefault();
        e.stopPropagation();
        chat.theme = 'custom';
        chat.customTheme = {
            sent: {
                bg: getEl('custom-sent-bg').value,
                text: getEl('custom-sent-text').value
            },
            received: {
                bg: getEl('custom-received-bg').value,
                text: getEl('custom-received-text').value
            }
        };
        updateSettingsPreview(type);
        getEl(`current-theme-name-${type}`).textContent = '自定义';
        modal.classList.remove('visible');
    };

    modal.classList.add('visible');
}

function loadSettingsToSidebar(){
    const char = db.characters.find(c => c.id === currentChatId);
    if(!char) return;

    const assignedChar = db.characters.find(c => c.id === char.assignedCharId) || {};
    const assignedMe = db.meProfiles.find(p => p.id === char.assignedMeId) || {};
    
    getEl('assigned-char-avatar').src = assignedChar.avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
    getEl('assigned-char-name').textContent = assignedChar.remarkName || '未指定';
    getEl('assigned-me-avatar').src = assignedMe.myAvatar || 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg';
    getEl('assigned-me-name').textContent = assignedMe.myName || '未指定';

    getEl('setting-max-memory-private').value = char.maxMemory || 10;
    
    const themeKey = char.theme || 'default';
    const theme = colorThemesV2[themeKey] || colorThemesV2['default'];
    getEl('current-theme-name-private').textContent = theme.name;

    const fontSizeSlider = getEl('font-size-slider-private');
    fontSizeSlider.value = char.fontSize || 15;
    getEl('font-size-value-private').textContent = `${fontSizeSlider.value}px`;
    
    getEl('custom-css-input-private').value = char.customBubbleCss || '';
    
    document.querySelector(`#chat-settings-sidebar input[name="proactive-chat"][value="${String(char.proactiveChat.enabled)}"]`).checked = true;
    getEl('proactive-chat-frequency').value = char.proactiveChat.frequency;
    document.querySelector(`#chat-settings-sidebar input[name="auto-memory"][value="${String(char.autoMemory.enabled)}"]`).checked = true;
    getEl('auto-memory-frequency').value = char.autoMemory.frequency;

    updateSettingsPreview('private');
}

function saveSettingsFromSidebar(){
    const char = db.characters.find(c => c.id === currentChatId);
    if(!char) return;
    
    Object.assign(char, {
        maxMemory: parseInt(getEl('setting-max-memory-private').value, 10),
        fontSize: getEl('font-size-slider-private').value,
        customBubbleCss: getEl('custom-css-input-private').value
    });
    
    char.proactiveChat.enabled = document.querySelector('#chat-settings-sidebar input[name="proactive-chat"]:checked').value === 'true';
    char.proactiveChat.frequency = getEl('proactive-chat-frequency').value;
    char.autoMemory.enabled = document.querySelector('#chat-settings-sidebar input[name="auto-memory"]:checked').value === 'true';
    char.autoMemory.frequency = parseInt(getEl('auto-memory-frequency').value, 10);

    saveData();
    showToast('设置已保存！');
    openChatRoom(char.id, 'private');
    renderChatList();
    renderContactsList();
}

function updateSettingsPreview(type) {
    const chat = (type === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;

    const previewArea = getEl(`settings-preview-area-${type}`);
    if (!previewArea) return;

    const selectedThemeKey = chat.theme || 'default';
    const fontSize = getEl(`font-size-slider-${type}`).value;
    const customCss = getEl(`custom-css-input-${type}`).value;

    getEl(`font-size-value-${type}`).textContent = `${fontSize}px`;
    
    const themeColors = selectedThemeKey === 'custom' 
        ? chat.customTheme
        : (colorThemesV2[selectedThemeKey] || colorThemesV2['default']);

    if (themeColors) {
        previewArea.style.setProperty('--sent-bg-color', themeColors.sent.bg);
        previewArea.style.setProperty('--sent-text-color', themeColors.sent.text);
        previewArea.style.setProperty('--received-bg-color', themeColors.received.bg);
        previewArea.style.setProperty('--received-text-color', themeColors.received.text);
    }
    
    previewArea.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
    previewArea.style.backgroundColor = chat.chatBg ? 'transparent' : '#f0f2f5';

    previewArea.innerHTML = ''; 

    if (type === 'private') {
        const assignedChar = db.characters.find(c => c.id === chat.assignedCharId) || {};
        const assignedMe = db.meProfiles.find(p => p.id === chat.assignedMeId) || db.meProfiles[0];
        const aiMsg = { role: 'assistant', content: `[${assignedChar.realName || 'AI'}的消息：对方消息预览]`, timestamp: 1, senderName: assignedChar.remarkName };
        const userMsg = { role: 'user', content: `[${assignedMe.myName || '我'}的消息：我的消息预览]`, timestamp: 2 };
        
        const aiBubble = createMessageBubbleElement(aiMsg);
        const userBubble = createMessageBubbleElement(userMsg);
        
        if(aiBubble) previewArea.appendChild(aiBubble);
        if(userBubble) previewArea.appendChild(userBubble);
    } else { // Group
        const member1 = chat.members[0] || { avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', groupNickname: '成员1' };
        const meProfile = db.meProfiles.find(p => p.id === chat.me.profileId) || db.meProfiles[0];
        const aiMsg = { role: 'assistant', content: `[${member1.realName}的消息：群成员消息预览]`, timestamp: 1, senderId: member1.id };
        const userMsg = { role: 'user', content: `[${meProfile.myName}的消息：我的消息预览]`, timestamp: 2, senderId: 'user_me' };

        const aiBubble = createMessageBubbleElement(aiMsg);
        const userBubble = createMessageBubbleElement(userMsg);

        if(aiBubble) previewArea.appendChild(aiBubble);
        if(userBubble) previewArea.appendChild(userBubble);
    }
    
    previewArea.querySelectorAll('.message-bubble .content').forEach(el => el.style.fontSize = `${fontSize}px`);

    applyCustomCss(chat.id, customCss, true);
}

    
    function setupApiSettingsApp(){
        const form = getEl('api-form');
        const fetchBtn = getEl('fetch-models-btn');
        const modelSelect = getEl('api-model');
        const providerSelect = getEl('api-provider');
        const urlInput = getEl('api-url');
        const keyInput = getEl('api-key');

        const apiUrls = { newapi:'', deepseek:'https://api.deepseek.com', claude:'https://api.anthropic.com', gemini:'https://generativelanguage.googleapis.com' };
        
        if (db.apiSettings) {
            providerSelect.value = db.apiSettings.provider || 'newapi';
            urlInput.value = db.apiSettings.url || '';
            keyInput.value = db.apiSettings.key || '';
            if (db.apiSettings.model) {
                modelSelect.innerHTML = `<option value="${db.apiSettings.model}">${db.apiSettings.model}</option>`;
            }
        }
        
        if(db.imageApiSettings){
            getEl('image-api-url').value = db.imageApiSettings.url || '';
            getEl('image-api-key').value = db.imageApiSettings.key || '';
            getEl('image-api-model').value = db.imageApiSettings.model || '';
        }

        providerSelect.addEventListener('change',()=>{ urlInput.value = apiUrls[providerSelect.value] || '' });
        
        fetchBtn.addEventListener('click', async () => {
            const provider = providerSelect.value;
            let url = urlInput.value.trim();
            const key = keyInput.value.trim();
            if(!url || !key) return showToast('请先填写API地址和密钥！');
            
            url = url.replace(/\/+$/, '');
            const modelsUrl = provider === 'gemini' ? `${url}/v1beta/models?key=${key}` : `${url}/v1/models`;
            
            fetchBtn.classList.add('loading');
            fetchBtn.disabled = true;
            
            try {
                const headers = provider === 'gemini' ? {} : { 'Authorization': `Bearer ${key}` };
                const response = await fetch(modelsUrl, { method: 'GET', headers });
                
                if (!response.ok) throw new Error(`网络响应错误: ${response.status}`);
                
                const data = await response.json();
                let models = [];
                
                if (provider !== 'gemini' && data.data) {
                    models = data.data.map(model => model.id);
                } else if (provider === 'gemini' && data.models) {
                    models = data.models.map(model => model.name.replace('models/',''));
                }
                
                modelSelect.innerHTML = models.length > 0 ? models.map(m => `<option value="${m}">${m}</option>`).join('') : '<option value="">未找到任何模型</option>';
                showToast('模型列表拉取成功！');
            } catch(error) {
                showToast(`拉取失败: ${error.message}`);
                modelSelect.innerHTML = '<option value="">拉取失败</option>';
            } finally {
                fetchBtn.classList.remove('loading');
                fetchBtn.disabled = false;
            }
        });
        
        form.addEventListener('submit', e => {
            e.preventDefault();
            if(!modelSelect.value) return showToast('请选择模型后保存！');
            db.apiSettings = {
                provider: providerSelect.value,
                url: urlInput.value,
                key: keyInput.value,
                model: modelSelect.value
            };
            db.imageApiSettings = {
                url: getEl('image-api-url').value.trim(),
                key: getEl('image-api-key').value.trim(),
                model: getEl('image-api-model').value.trim(),
            };
            saveData();
            showToast('API设置已保存！');
        });
    }
    function setupGroupChatSystem() { 
    getEl('assign-group-me-btn').addEventListener('click', () => showAssignModal('me', true));
    
    getEl('create-group-modal').addEventListener('click', e => { if (e.target === getEl('create-group-modal')) getEl('create-group-modal').classList.remove('visible'); }); 
    getEl('create-group-form').addEventListener('submit', e => { 
        e.preventDefault(); 
        const selectedMemberIds = [...getEl('member-selection-list').querySelectorAll('input:checked')].map(input => input.value); 
        const groupName = getEl('group-name-input').value.trim(); 
        if (selectedMemberIds.length < 1) return showToast('请至少选择一个群成员。'); 
        if (!groupName) return showToast('请输入群聊名称。'); 
        const firstMe = db.meProfiles[0];
        const newGroup = { 
            id: `group_${Date.now()}`, 
            name: groupName, 
            avatar: 'https://i.postimg.cc/fTLCngk1/image.jpg', 
            me: { 
                nickname: firstMe.myName || '我', 
                persona: firstMe.myPersona || '', 
                avatar: firstMe.myAvatar || 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                profileId: firstMe.id
            }, 
            members: selectedMemberIds.map(charId => { 
                const char = db.characters.find(c => c.id === charId); 
                return { id: `member_${char.id}`, originalCharId: char.id, realName: char.realName, groupNickname: char.remarkName, persona: char.persona, avatar: char.avatar, role: 'member' }; 
            }), 
            theme: 'default', 
            fontSize: 15, 
            maxMemory: 10, 
            chatBg: '', 
            history: [], 
            isPinned: false, 
            worldBookIds: [],
            unreadCount: 0, 
            customBubbleCss: '' 
        }; 
        db.groups.push(newGroup); 
        saveData(); 
        renderChatList(); 
        getEl('create-group-modal').classList.remove('visible'); 
        showToast(`群聊"${groupName}"创建成功！`); 
        switchScreen('chat-list-screen');
    }); 
    
    getEl('setting-group-avatar-upload').addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) try { const url = await compressImage(file, { maxWidth: 400, maxHeight: 400 }); const group = db.groups.find(g => g.id === currentChatId); if (group) { group.avatar = url; getEl('setting-group-avatar-preview').src = url; saveData(); } } catch (err) { showToast('群头像压缩失败'); } }); 
    getEl('setting-group-chat-bg-upload').addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) try { const url = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 }); const group = db.groups.find(g => g.id === currentChatId); if (group) { group.chatBg = url; getEl('chat-room-screen').style.backgroundImage = `url(${url})`; saveData(); showToast('聊天背景已更换'); } } catch (err) { showToast('群聊背景压缩失败'); } }); 
    getEl('clear-group-chat-history-btn').addEventListener('click', () => { const group = db.groups.find(g => g.id === currentChatId); if (group && confirm(`你确定要清空群聊"${group.name}"的所有聊天记录吗？`)) { group.history = []; saveData(); renderMessages(false, true); renderChatList(); getEl('group-settings-sidebar').classList.remove('open'); showToast('聊天记录已清空'); } }); 
    getEl('group-members-list-container').addEventListener('click', e => { const memberDiv = e.target.closest('.group-member'); const addBtn = e.target.closest('.add-member-btn'); if (memberDiv) openGroupMemberEditModal(memberDiv.dataset.id); else if (addBtn) getEl('add-member-actionsheet').classList.add('visible'); }); 
    getEl('edit-group-member-modal').addEventListener('click', e => { e.stopPropagation(); if (e.target === getEl('edit-group-member-modal')) getEl('edit-group-member-modal').classList.remove('visible'); }); 
    getEl('edit-member-avatar-preview').addEventListener('click', () => { getEl('edit-member-avatar-upload').click(); }); 
    getEl('edit-member-avatar-upload').addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) try { getEl('edit-member-avatar-preview').src = await compressImage(file, { maxWidth: 400, maxHeight: 400 }); } catch (err) { showToast('成员头像压缩失败'); } }); 
    getEl('edit-group-member-form').addEventListener('submit', e => { e.preventDefault(); const memberId = getEl('editing-member-id').value; const group = db.groups.find(g => g.id === currentChatId); const member = group.members.find(m => m.id === memberId); if (member) { Object.assign(member, { avatar: getEl('edit-member-avatar-preview').src, groupNickname: getEl('edit-member-group-nickname').value, realName: getEl('edit-member-real-name').value, persona: getEl('edit-member-persona').value }); saveData(); renderGroupMembersInSettings(group); document.querySelectorAll(`.message-wrapper[data-sender-id="${member.id}"] .group-nickname`).forEach(el => { el.textContent = member.groupNickname; }); showToast('成员信息已更新'); } getEl('edit-group-member-modal').classList.remove('visible'); }); 
    getEl('invite-existing-member-btn').addEventListener('click', () => { renderInviteSelectionList(); getEl('invite-member-modal').classList.add('visible'); getEl('add-member-actionsheet').classList.remove('visible'); }); 
    getEl('create-new-member-btn').addEventListener('click', () => { getEl('create-member-for-group-form').reset(); getEl('create-group-member-avatar-preview').src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg'; getEl('create-member-for-group-modal').classList.add('visible'); getEl('add-member-actionsheet').classList.remove('visible'); }); 
    getEl('invite-member-modal').addEventListener('click', e => { e.stopPropagation(); if (e.target === getEl('invite-member-modal')) getEl('invite-member-modal').classList.remove('visible'); }); 
    getEl('create-member-for-group-modal').addEventListener('click', e => { if (e.target === getEl('create-member-for-group-modal')) getEl('create-member-for-group-modal').classList.remove('visible'); }); 
    getEl('create-group-member-avatar-preview').addEventListener('click', () => { getEl('create-group-member-avatar-upload').click(); }); 
    getEl('create-group-member-avatar-upload').addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) try { getEl('create-group-member-avatar-preview').src = await compressImage(file, { maxWidth: 400, maxHeight: 400 }); } catch (err) { showToast('新成员头像压缩失败'); } }); 
    getEl('confirm-invite-btn').addEventListener('click', () => { const group = db.groups.find(g => g.id === currentChatId); if (!group) return; const selectedCharIds = [...getEl('invite-member-selection-list').querySelectorAll('input:checked')].map(input => input.value); selectedCharIds.forEach(charId => { const char = db.characters.find(c => c.id === charId); if (char) { const newMember = { id: `member_${char.id}`, originalCharId: char.id, realName: char.realName, groupNickname: char.remarkName, persona: char.persona, avatar: char.avatar, role: 'member' }; group.members.push(newMember); sendSystemNotification(group, `"${group.me.nickname}"邀请"${newMember.groupNickname}"加入了群聊`); } }); if (selectedCharIds.length > 0) { saveData(); renderGroupMembersInSettings(group); renderMessages(false, true); showToast('已邀请新成员'); } getEl('invite-member-modal').classList.remove('visible'); }); 
    getEl('create-member-for-group-form').addEventListener('submit', e => { e.preventDefault(); const group = db.groups.find(g => g.id === currentChatId); if (!group) return; const newMember = { id: `member_group_only_${Date.now()}`, originalCharId: null, realName: getEl('create-group-member-realname').value, groupNickname: getEl('create-group-member-nickname').value, persona: getEl('create-group-member-persona').value, avatar: getEl('create-group-member-avatar-preview').src, role: 'member' }; group.members.push(newMember); sendSystemNotification(group, `"${group.me.nickname}"邀请"${newMember.groupNickname}"加入了群聊`); saveData(); renderGroupMembersInSettings(group); renderMessages(false, true); showToast(`新成员 ${newMember.groupNickname} 已加入`); getEl('create-member-for-group-modal').classList.remove('visible'); }); 
    getEl('add-member-actionsheet').addEventListener('click', e => { e.stopPropagation(); if (e.target === getEl('add-member-actionsheet')) getEl('add-member-actionsheet').classList.remove('visible'); }); 
    getEl('create-member-for-group-modal').addEventListener('click', e => { e.stopPropagation(); if (e.target === getEl('create-member-for-group-modal')) getEl('create-member-for-group-modal').classList.remove('visible'); }); 
    getEl('link-group-world-book-btn').addEventListener('click', () => {
        const group = db.groups.find(g => g.id === currentChatId);
        if (!group) return;
        getEl('world-book-selection-list').innerHTML = db.worldBooks.map(book => `<li class="world-book-select-item"><input type="checkbox" id="wb-select-group-${book.id}" value="${book.id}" ${(group.worldBookIds || []).includes(book.id) ? 'checked' : ''}><label for="wb-select-group-${book.id}">${book.name}</label></li>`).join('');
        getEl('world-book-selection-modal').classList.add('visible');
    });
}
function setupGroupChatSettings() {
    getEl('group-settings-form').addEventListener('submit', e => { e.preventDefault(); saveGroupSettingsFromSidebar(); }); 
    
    getEl('select-theme-btn-group').addEventListener('click', (e) => {
        e.stopPropagation();
        openThemeSelectionModal('group');
    });
    getEl('font-size-slider-group').addEventListener('input', () => updateSettingsPreview('group'));
    getEl('custom-css-input-group').addEventListener('input', () => updateSettingsPreview('group'));
    getEl('reset-custom-css-btn-group').addEventListener('click', () => {
        getEl('custom-css-input-group').value = '';
        updateSettingsPreview('group');
    });

    getEl('extract-group-memory-btn').addEventListener('click', async (e) => { 
        const btn = e.currentTarget; 
        const group = db.groups.find(g => g.id === currentChatId);
        if (!group) return;

        btn.classList.add('loading'); 
        btn.disabled = true;
        showToast(`开始为群聊"${group.name}"的所有成员提取记忆...`);

        try {
            for (const member of group.members) {
                if (member.originalCharId) { // Only extract for members linked to a character profile
                    await extractAndStoreMemory(member.originalCharId, 'group', group);
                }
            }
            showToast(`群聊"${group.name}"的记忆提取完成！`);
        } catch (error) { 
            console.error("Group Memory Extraction Failed:", error); 
            showToast(`群聊记忆提取失败: ${error.message}`); 
        } finally { 
            btn.classList.remove('loading'); 
            btn.disabled = false; 
        } 
    });
}

    function renderMemberSelectionList() { const list = getEl('member-selection-list'); list.innerHTML = ''; if (db.characters.length === 0) { list.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可选择的人设。</li>'; return; } list.innerHTML = db.characters.map(char => `<li class="member-selection-item"><input type="checkbox" id="select-${char.id}" value="${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><label for="select-${char.id}">${char.remarkName}</label></li>`).join(''); }
    function loadGroupSettingsToSidebar() { 
        const group = db.groups.find(g => g.id === currentChatId); 
        if (!group) return;
        const assignedMe = db.meProfiles.find(p => p.id === group.me.profileId) || { myName: group.me.nickname };
        
        getEl('assigned-group-me-name').textContent = assignedMe.myName;
        Object.assign(getEl('setting-group-avatar-preview'), { src: group.avatar }); 
        Object.assign(getEl('setting-group-name'), { value: group.name }); 
        getEl('setting-max-memory-group').value = group.maxMemory || 10; 
        renderGroupMembersInSettings(group); 
        
        const themeKey = group.theme || 'default';
        const theme = colorThemesV2[themeKey] || colorThemesV2['default'];
        getEl('current-theme-name-group').textContent = theme.name;
        
        const fontSizeSlider = getEl('font-size-slider-group');
        fontSizeSlider.value = group.fontSize || 15;
        getEl('font-size-value-group').textContent = `${fontSizeSlider.value}px`;
        getEl('custom-css-input-group').value = group.customBubbleCss || '';

        updateSettingsPreview('group');
    }
    function renderGroupMembersInSettings(group) { const container = getEl('group-members-list-container'); container.innerHTML = group.members.map(member => `<div class="group-member" data-id="${member.id}"><img src="${member.avatar}" alt="${member.groupNickname}">${member.role === 'admin' ? '<span class="admin-badge">Admin</span>' : ''}<span>${member.groupNickname}</span></div>`).join('') + `<div class="add-member-btn"><div class="add-icon">+</div><span>添加</span></div>`; }
    function saveGroupSettingsFromSidebar() { 
        const group = db.groups.find(g => g.id === currentChatId); if (!group) return; 
        const oldName = group.name; const newName = getEl('setting-group-name').value; 
        if (oldName !== newName) { group.name = newName; sendSystemNotification(group, `"${group.me.nickname}"修改群名为：“${newName}”`); } 
        
        const customCss = getEl('custom-css-input-group').value.trim();
        
        Object.assign(group, { 
            avatar: getEl('setting-group-avatar-preview').src, 
            fontSize: getEl('font-size-slider-group').value,
            customBubbleCss: customCss,
            maxMemory: getEl('setting-max-memory-group').value 
        }); 

        saveData(); 
        showToast('群聊设置已保存！'); 
        openChatRoom(group.id, 'group');
        renderChatList(); 
    }
       function openGroupMemberEditModal(memberId) { 
        const group = db.groups.find(g => g.id === currentChatId); 
        const member = group.members.find(m => m.id === memberId); 
        if (!member) return; 
        getEl('edit-group-member-title').textContent = `编辑 ${member.groupNickname}`; 
        getEl('editing-member-id').value = member.id; 
        getEl('edit-member-avatar-preview').src = member.avatar; 
        getEl('edit-member-group-nickname').value = member.groupNickname; 
        getEl('edit-member-real-name').value = member.realName; 
        getEl('edit-member-persona').value = member.persona; 
        
        const actionsContainer = getEl('admin-actions-container');
        actionsContainer.innerHTML = ''; // Clear previous actions

        const isAdmin = member.role === 'admin';
        const adminBtn = document.createElement('button');
        adminBtn.type = 'button';
        adminBtn.className = `btn ${isAdmin ? 'btn-neutral' : 'btn-secondary'}`;
        adminBtn.textContent = isAdmin ? '撤销管理员' : '设为管理员';
        adminBtn.onclick = () => {
            member.role = isAdmin ? 'member' : 'admin';
            saveData();
            showToast(`${member.groupNickname} 的权限已更新。`);
            sendSystemNotification(group, isAdmin ? `"${group.me.nickname}" 撤销了 "${member.groupNickname}" 的管理员` : `"${group.me.nickname}" 将 "${member.groupNickname}" 设置为管理员`);
            renderGroupMembersInSettings(group);
            getEl('edit-group-member-modal').classList.remove('visible');
        };
        actionsContainer.appendChild(adminBtn);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-danger';
        removeBtn.style.marginTop = '10px';
        removeBtn.textContent = '移出群聊';
        removeBtn.onclick = () => {
             if (confirm(`确定要将 ${member.groupNickname} 移出群聊吗？`)) {
                 group.members = group.members.filter(m => m.id !== memberId);
                 saveData();
                 showToast(`${member.groupNickname} 已被移出群聊。`);
                 sendSystemNotification(group, `"${member.groupNickname}" 被 "${group.me.nickname}" 移出了群聊`);
                 renderGroupMembersInSettings(group);
                 getEl('edit-group-member-modal').classList.remove('visible');
             }
        };
        actionsContainer.appendChild(removeBtn);

        getEl('edit-group-member-modal').classList.add('visible'); 
    }
    function renderInviteSelectionList() { const list = getEl('invite-member-selection-list'); list.innerHTML = ''; const group = db.groups.find(g => g.id === currentChatId); if (!group) return; const currentMemberCharIds = new Set(group.members.map(m => m.originalCharId)); const availableChars = db.characters.filter(c => !currentMemberCharIds.has(c.id)); if (availableChars.length === 0) { list.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可邀请的新成员了。</li>'; getEl('confirm-invite-btn').disabled = true; return; } getEl('confirm-invite-btn').disabled = false; list.innerHTML = availableChars.map(char => `<li class="invite-member-select-item"><input type="checkbox" id="invite-select-${char.id}" value="${char.id}"><label for="invite-select-${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><span>${char.remarkName}</span></label></li>`).join(''); }
    
    function sendSystemNotification(group, text) {
        const message = { id: `msg_system_${Date.now()}`, role: 'system', content: `[${text}]`, timestamp: Date.now() };
        group.history.push(message);
        saveData();
        if (group.id === currentChatId) {
            addMessageBubble(message);
        }
    }

    // --- NEW: Moments Functions ---
    function setupMomentsApp() {
        getEl('moments-settings-btn').addEventListener('click', () => { loadMomentsSettings(); switchScreen('moments-settings-screen'); });
        getEl('moments-settings-form').addEventListener('submit', (e) => { e.preventDefault(); saveMomentsSettings(); });
        getEl('clear-moments-btn').addEventListener('click', () => { if (confirm('你确定要清空所有朋友圈动态吗？此操作不可恢复。')) { db.moments = []; db.characters.forEach(c => c.lastMomentPostTime = 0); saveData(); renderMomentsFeed(); showToast('所有动态已清空'); } });
        
        const momentsScreen = getEl('moments-screen');
        momentsScreen.addEventListener('click', handleMomentInteraction);
        
        momentsScreen.addEventListener('contextmenu', (e) => {
             e.preventDefault();
             const momentItem = e.target.closest('.moment-item');
             if(momentItem) handleMomentLongPress(momentItem.dataset.momentId, e.clientX, e.clientY);
        });
        momentsScreen.addEventListener('touchstart', (e) => {
            const momentItem = e.target.closest('.moment-item');
            if(!momentItem) return;
            longPressTimer = setTimeout(() => {
                const touch = e.touches[0];
                handleMomentLongPress(momentItem.dataset.momentId, touch.clientX, touch.clientY);
            }, 500);
        });
        momentsScreen.addEventListener('touchend', () => clearTimeout(longPressTimer));
        momentsScreen.addEventListener('touchmove', () => clearTimeout(longPressTimer));

        getEl('moment-comment-form').addEventListener('submit', handleCommentSubmit);
        
        getEl('moments-avatar-upload').addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) try { const url = await compressImage(file, { maxWidth: 200, maxHeight: 200 }); db.momentsSettings.myAvatar = url; getEl('moments-my-avatar-preview').src = url; saveData(); showToast('朋友圈头像已更新'); if(getEl('moments-screen').classList.contains('active')) renderMomentsFeed(); } catch(err) { showToast('头像压缩失败'); } });
        getEl('moments-bg-upload').addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) try { const url = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1080 }); db.momentsSettings.background = url; getEl('moments-bg-preview').style.backgroundImage = `url(${url})`; saveData(); showToast('朋友圈封面已更新'); if(getEl('moments-screen').classList.contains('active')) renderMomentsFeed(); } catch(err) { showToast('封面压缩失败'); } });

        setInterval(automaticPostScheduler, 5 * 60 * 1000);
    }
    
    function handleMomentLongPress(momentId, x, y) {
        clearTimeout(longPressTimer);
        const moment = db.moments.find(m => m.id === momentId);
        if(!moment) return;
        
        const menuItems = [{
            label: '删除',
            danger: true,
            action: () => {
                if(confirm('确定要删除这条动态吗？')) {
                    db.moments = db.moments.filter(m => m.id !== momentId);
                    saveData();
                    renderMomentsFeed();
                    showToast('动态已删除');
                }
            }
        }];
        createContextMenu(menuItems, x, y);
    }
    
    async function automaticPostScheduler() {
        if (!db.momentsSettings.enabled || db.characters.length === 0) return;

        const now = Date.now();
        const frequencyMap = {
            high: { min: 0.5, max: 2 }, 
            medium: { min: 2, max: 6 }, 
            low: { min: 6, max: 12 }    
        };
        const setting = frequencyMap[db.momentsSettings.frequency] || frequencyMap.medium;

        for (const character of db.characters) {
            const timeSinceLastPost = now - (character.lastMomentPostTime || 0);
            const randomInterval = (Math.random() * (setting.max - setting.min) + setting.min) * 3600000;
            
            if (timeSinceLastPost > randomInterval && Math.random() < 0.5) { 
                await createAutomaticPost(character);
            }
        }
    }
     async function momentPruningScheduler() {
        const oneDay = 24 * 3600 * 1000;
        for(const moment of db.moments) {
            if(moment.characterId === 'user_me' || Math.random() > 0.1) continue;
            
            const age = Date.now() - moment.timestamp;
            if(age > oneDay) {
                 const character = db.characters.find(c => c.id === moment.characterId);
                 if(character) {
                     const prompt = `你扮演的角色是“${character.realName}”，人设是：${character.persona}。你正在回顾自己过去发的一条朋友圈。动态内容是：“${moment.content}”。根据你的性格，你现在是否觉得这条动态有点尴尬、不合时宜或者只是单纯想删掉？请只回答“是”或“否”。`;
                     const decision = await getAiReply(prompt);
                     if(decision && decision.includes('是')) {
                         db.moments = db.moments.filter(m => m.id !== moment.id);
                         saveData();
                         if (getEl('moments-screen').classList.contains('active')) {
                            renderMomentsFeed();
                         }
                     }
                 }
            }
        }
    }

    function areCharactersAcquainted(charId1, charId2) {
        if (charId1 === charId2) return true;
        for (const group of db.groups) {
            const memberIds = new Set(group.members.map(m => m.originalCharId));
            if (memberIds.has(charId1) && memberIds.has(charId2)) {
                return true;
            }
        }
        return false;
    }

    function generateMomentPostPrompt(character) { return `你正在扮演角色“${character.realName}”，现在请你发布一条朋友圈动态。\n你的设定是：${character.persona || '一个友好的人'}。\n你的动态应该符合你的角色设定，可以是对日常生活的记录、一个想法、一张照片的描述等等。\n【重要】请在文案最后，用“|”分隔，并提供2-3个英文关键词用于AI生成配图，例如：“今天天气真好，想去海边散步。|blue%20sky%20beach”。如果不需要配图，请只输出文案。`; }
    function generateMomentReactionPrompt(reactor, momentToReact, replyingToComment = null) {
        const postAuthor = db.characters.find(c => c.id === momentToReact.characterId) || { remarkName: '我', id: 'user_me' };
        let prompt = `你正在扮演角色“${reactor.realName}”，你的设定是：${reactor.persona || '一个友好的人'}。\n你正在浏览“${postAuthor.remarkName}”发布的一条朋友圈动态。\n\n--- 动态内容 ---\n${postAuthor.remarkName}: ${momentToReact.content}\n`;
        
        let acquaintanceStatus = "";
        if (postAuthor.id !== 'user_me') {
            acquaintanceStatus = areCharactersAcquainted(reactor.id, postAuthor.id) 
                ? `你和 ${postAuthor.remarkName} 是认识的。`
                : `你和 ${postAuthor.remarkName} 是陌生人，这是你第一次看到TA的动态。`;
        }
        prompt += `\n${acquaintanceStatus}\n`;

        if (replyingToComment) {
            const replyToAuthor = db.characters.find(c => c.id === replyingToComment.characterId) || { remarkName: '我', id: 'user_me' };
            prompt += `\n你现在正准备回复“${replyToAuthor.remarkName}”的评论：“${replyingToComment.content}”。\n`;
             if (replyToAuthor.id !== 'user_me') {
                acquaintanceStatus = areCharactersAcquainted(reactor.id, replyToAuthor.id)
                    ? `你和 ${replyToAuthor.remarkName} 是认识的。`
                    : `你和 ${replyToAuthor.remarkName} 并不认识。`;
                prompt += `\n${acquaintanceStatus}\n`;
            }
        }
        
        if (momentToReact.comments.length > 0) {
            prompt += `\n--- 已有评论 ---\n`;
            momentToReact.comments.forEach(comment => {
                 const commenter = db.characters.find(c => c.id === comment.characterId) || { remarkName: '我', id: 'user_me' };
                 let replyToText = '';
                 if(comment.replyToId){
                     const originalComment = momentToReact.comments.find(c => c.id === comment.replyToId);
                     if(originalComment){
                         const originalCommenter = db.characters.find(c => c.id === originalComment.characterId) || { remarkName: '我', id: 'user_me' };
                         replyToText = ` 回复 ${originalCommenter.remarkName}`;
                     }
                 }
                 prompt += `${commenter.remarkName}${replyToText}: ${comment.content}\n`;
            });
        }

        if (replyingToComment) {
             const replyToAuthorName = (db.characters.find(c => c.id === replyingToComment.characterId) || { remarkName: '我' }).remarkName;
             prompt += `\n--- 你的任务 ---\n请只生成你要回复“${replyToAuthorName}”的评论内容，直接输出文字，不要包含任何其他格式或说明。`;
        } else {
            prompt += `\n--- 你的任务 ---\n现在，请决定你的行动。你有三个选择：\n1. 点赞和评论: 如果你既想点赞也想评论，请回复格式：[LIKE][COMMENT:你的评论内容]\n2. 只评论: 如果你只想评论，请回复格式：[COMMENT:你的评论内容]\n3. 只点赞或忽略: 如果你只想点赞，或者觉得这条动态不需要互动，请只回复：[LIKE] 或 [IGNORE]\n你的评论应该非常口语化、简洁，就像真实的朋友圈评论一样。请严格按照以上三种格式之一进行回复，不要添加任何额外的文字。`;
        }
        return prompt;
    }

    async function createAutomaticPost(character) {
        if(!character) return;
        const postResponse = await getAiReply(generateMomentPostPrompt(character));
        if (postResponse) {
            const parts = postResponse.split('|');
            const postContent = parts[0].trim();
            const imagePrompt = parts.length > 1 ? parts[1].trim() : null;
            const imageUrl = imagePrompt ? `https://image.pollinations.ai/prompt/${imagePrompt}` : null;

            const newMoment = { id: `moment_${Date.now()}`, characterId: character.id, content: postContent, imageUrl: imageUrl, timestamp: Date.now(), likes: [], comments: [] };
            
            db.moments.unshift(newMoment);
            character.lastMomentPostTime = Date.now();
            saveData();
            if(getEl('moments-screen').classList.contains('active')) renderMomentsFeed();
            setTimeout(() => triggerAiReactions(newMoment.id), 2000);
        }
    }
    
    async function triggerAiReactions(momentId, replyingToCommentId = null) {
        const moment = db.moments.find(m => m.id === momentId);
        if (!moment) return;
        
        let reactors = [];
        if (replyingToCommentId) {
             const replyingToComment = moment.comments.find(c => c.id === replyingToCommentId);
             if(!replyingToComment) return;
             if (replyingToComment.characterId === 'user_me') { // If user comments, some AI should reply
                 const potentialReactors = db.characters.filter(c => c.id !== moment.characterId && !moment.comments.some(cmt => cmt.characterId === c.id && cmt.replyToId === replyingToCommentId));
                 if(potentialReactors.length > 0) reactors.push(potentialReactors[Math.floor(Math.random() * potentialReactors.length)]);
             } else if (moment.characterId !== 'user_me' && Math.random() > 0.5) { // If an AI comments, the post author might reply
                 const postAuthor = db.characters.find(c => c.id === moment.characterId);
                 if(postAuthor) reactors.push(postAuthor);
             }
        } else {
            const potentialReactors = db.characters.filter(c => c.id !== moment.characterId && !moment.likes.includes(c.id) && !moment.comments.some(cmt => cmt.characterId === c.id));
            if (potentialReactors.length === 0) return;
            reactors = potentialReactors.sort(() => 0.5 - Math.random()).slice(0, Math.floor(Math.random() * Math.min(3, potentialReactors.length)) + 1);
        }

        for (const reactor of reactors) {
            if (!reactor) continue;
            const delay = Math.random() * 10000 + 3000;
            setTimeout(async () => {
                const replyingToComment = replyingToCommentId ? moment.comments.find(c => c.id === replyingToCommentId) : null;
                const prompt = generateMomentReactionPrompt(reactor, moment, replyingToComment);
                if (!prompt) return;
                const reactionResponse = await getAiReply(prompt);

                if (reactionResponse) {
                    let updated = false;
                    const currentMoment = db.moments.find(m => m.id === momentId); 
                    if(!currentMoment) return;
                    
                    if (replyingToComment) {
                        currentMoment.comments.push({ id: `comment_${Date.now()}`, characterId: reactor.id, content: reactionResponse.trim(), timestamp: Date.now(), replyToId: replyingToCommentId });
                        updated = true;
                    } else {
                        if (reactionResponse.includes('[LIKE]')) { if (!currentMoment.likes.includes(reactor.id)) { currentMoment.likes.push(reactor.id); updated = true; } }
                        const commentMatch = reactionResponse.match(/\[COMMENT:(.*)\]/);
                        if (commentMatch && commentMatch[1]) { currentMoment.comments.push({ id: `comment_${Date.now()}`, characterId: reactor.id, content: commentMatch[1].trim(), timestamp: Date.now(), replyToId: null }); updated = true; }
                    }
                    if (updated) { saveData(); if (getEl('moments-screen').classList.contains('active')) updateMomentUI(momentId); }
                }
            }, delay);
        }
    }

    function renderMomentsFeed() {
        const wrapper = getEl('moments-list-wrapper');
        wrapper.innerHTML = '';
        getEl('no-moments-placeholder').style.display = db.moments.length === 0 ? 'block' : 'none';
        
        const header = document.createElement('div');
        header.className = 'moments-header';
        header.innerHTML = `
            <img src="${db.momentsSettings.background}" class="moments-header-bg">
            <div class="moments-user-info">
                <span class="moments-user-name">我</span>
                <img src="${db.momentsSettings.myAvatar}" class="moments-user-avatar">
            </div>
        `;
        wrapper.appendChild(header);

        const feedContainer = document.createElement('ul');
        feedContainer.id = 'moments-feed-container';
        db.moments.forEach(moment => { feedContainer.appendChild(createMomentElement(moment)); });
        wrapper.appendChild(feedContainer);
    }

    function createMomentElement(moment) {
        const isUserPost = moment.characterId === 'user_me';
        const author = isUserPost ? { remarkName: '我', avatar: db.momentsSettings.myAvatar } : db.characters.find(c => c.id === moment.characterId);
        if (!author) return document.createElement('div');
        const li = document.createElement('li');
        li.className = 'moment-item';
        li.dataset.momentId = moment.id;
        li.innerHTML = `<img src="${author.avatar}" alt="${author.remarkName}" class="moment-item-avatar"><div class="moment-item-main"><p class="moment-item-name">${author.remarkName}</p><p class="moment-item-content">${moment.content}</p>${moment.imageUrl ? `<img src="${moment.imageUrl}" class="moment-item-image">` : ''}<div class="moment-item-footer"><span class="moment-item-time">${formatTimeAgo(moment.timestamp)}</span><div class="moment-item-actions"><button class="action-toggle-btn" data-action="toggle-popup">...</button><div class="moment-action-popup"><button class="action-popup-btn like-btn" data-action="like">${ICONS.LIKE} <span>赞</span></button><button class="action-popup-btn comment-btn" data-action="comment">${ICONS.COMMENT} <span>评论</span></button></div></div></div><div class="moment-interactions"><div class="moment-likes"></div><ul class="moment-comments-list"></ul></div></div>`;
        updateMomentInteractions(li, moment);
        return li;
    }

    function updateMomentUI(momentId) { const moment = db.moments.find(m => m.id === momentId); const element = getEl('moments-feed-container')?.querySelector(`.moment-item[data-moment-id="${momentId}"]`); if (moment && element) updateMomentInteractions(element, moment); }
    
    function updateMomentInteractions(element, moment) {
        const likesContainer = element.querySelector('.moment-likes');
        const likeBtn = element.querySelector('.like-btn');
        likeBtn.classList.toggle('liked', moment.likes.includes('user_me'));
        likeBtn.querySelector('span').textContent = moment.likes.includes('user_me') ? '取消' : '赞';

        likesContainer.innerHTML = '';
        if (moment.likes.length > 0) {
            const likerNames = moment.likes.map(id => (id === 'user_me') ? '我' : db.characters.find(c => c.id === id)?.remarkName || '').filter(Boolean).join(', ');
            likesContainer.innerHTML = `<svg class="like-icon" viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"></path></svg><span>${likerNames}</span>`;
        }
        
        const commentsList = element.querySelector('.moment-comments-list');
        commentsList.innerHTML = '';
        moment.comments.forEach(comment => {
            const commenter = (comment.characterId === 'user_me') ? { remarkName: '我', id: 'user_me' } : db.characters.find(c => c.id === comment.characterId);
            if (!commenter) return;

            const commentLi = document.createElement('li');
            commentLi.className = 'moment-comment-item';
            commentLi.dataset.commentId = comment.id;

            let contentHTML = `<span class="moment-comment-name">${commenter.remarkName}</span>`;
            if (comment.replyToId) {
                const originalComment = moment.comments.find(c => c.id === comment.replyToId);
                if (originalComment) {
                    const originalCommenter = (originalComment.characterId === 'user_me') ? { remarkName: '我' } : db.characters.find(c => c.id === originalComment.characterId);
                    if (originalCommenter) {
                        contentHTML += ` 回复 <span class="moment-comment-name">${originalCommenter.remarkName}</span>`;
                    }
                }
            }
            contentHTML += `: <span>${comment.content}</span>`;
            commentLi.innerHTML = contentHTML;
            commentsList.appendChild(commentLi);
        });
    }

    function handleMomentInteraction(e) { 
        const actionBtn = e.target.closest('[data-action]'); 
        const commentItem = e.target.closest('.moment-comment-item');

        if (!actionBtn && !commentItem) return; 

        const momentItem = e.target.closest('.moment-item'); 
        if (!momentItem) return;

        const momentId = momentItem.dataset.momentId; 
        
        if (actionBtn) {
            const action = actionBtn.dataset.action; 
            
            if (action === 'toggle-popup') {
                const popup = actionBtn.nextElementSibling;
                const isVisible = popup.classList.contains('visible');
                document.querySelectorAll('.moment-action-popup.visible').forEach(p => p.classList.remove('visible'));
                if(!isVisible) popup.classList.add('visible');
            } else {
                if (action === 'like') toggleUserLike(momentId); 
                else if (action === 'comment') openCommentModal(momentId);
                document.querySelectorAll('.moment-action-popup.visible').forEach(p => p.classList.remove('visible'));
            }

        } else if (commentItem) {
            const commentId = commentItem.dataset.commentId;
            openCommentModal(momentId, commentId);
        }
    }
    
    function setupMomentPosting() {
        getEl('moments-screen').addEventListener('click', (e) => {
            if(e.target.closest('#create-moment-btn')) {
                getEl('create-moment-form').reset();
                const preview = getEl('create-moment-image-preview');
                preview.style.display = 'none';
                preview.src = '';
                getEl('create-moment-modal').classList.add('visible');
            }
        });
        getEl('create-moment-image-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const preview = getEl('create-moment-image-preview');
            if(file) {
                 preview.src = await compressImage(file, {maxWidth: 500, maxHeight: 500});
                 preview.style.display = 'block';
            } else {
                 preview.style.display = 'none';
                 preview.src = '';
            }
        });
        getEl('create-moment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = getEl('create-moment-text').value.trim();
            const imageUrl = getEl('create-moment-image-preview').src;
            if (!text) {
                showToast('动态内容不能为空');
                return;
            }
            
            const newMoment = {
                id: `moment_${Date.now()}`,
                characterId: 'user_me',
                content: text,
                imageUrl: imageUrl.startsWith('data:image') ? imageUrl : null,
                timestamp: Date.now(),
                likes: [],
                comments: []
            };

            db.moments.unshift(newMoment);
            saveData();
            renderMomentsFeed();
            getEl('create-moment-modal').classList.remove('visible');
            setTimeout(() => triggerAiReactions(newMoment.id), 2000);
        });
    }

    function toggleUserLike(momentId) { const moment = db.moments.find(m => m.id === momentId); if (!moment) return; const userIndex = moment.likes.indexOf('user_me'); if (userIndex > -1) moment.likes.splice(userIndex, 1); else { moment.likes.push('user_me'); setTimeout(() => triggerAiReactions(momentId), 2000); } saveData(); updateMomentUI(momentId); }
    function openCommentModal(momentId, replyToId = null) {
        const moment = db.moments.find(m => m.id === momentId);
        if (!moment) return;

        getEl('moment-comment-moment-id').value = momentId;
        getEl('moment-comment-reply-id').value = replyToId || '';
        getEl('moment-comment-form').reset();
        
        const input = getEl('moment-comment-input');
        if (replyToId) {
            const originalComment = moment.comments.find(c => c.id === replyToId);
            if (originalComment) {
                const originalAuthor = (originalComment.characterId === 'user_me') ? { remarkName: '我' } : db.characters.find(c => c.id === originalComment.characterId);
                input.placeholder = `回复 ${originalAuthor.remarkName}:`;
            }
        } else {
            input.placeholder = "发布一条友善的评论吧";
        }

        getEl('moment-comment-modal').classList.add('visible');
        input.focus();
    }
    function handleCommentSubmit(e) { 
        e.preventDefault(); 
        const momentId = getEl('moment-comment-moment-id').value; 
        const replyToId = getEl('moment-comment-reply-id').value || null;
        const content = getEl('moment-comment-input').value.trim(); 
        const moment = db.moments.find(m => m.id === momentId); 
        if (content && moment) { 
            const newComment = { 
                id: `comment_${Date.now()}`, 
                characterId: 'user_me', 
                content, 
                timestamp: Date.now(),
                replyToId
            };
            moment.comments.push(newComment); 
            saveData(); 
            updateMomentUI(momentId); 
            getEl('moment-comment-modal').classList.remove('visible'); 
            setTimeout(() => triggerAiReactions(momentId, newComment.id), 2000); 
        } 
    }

    function loadMomentsSettings() {
        const { enabled, frequency, background, myAvatar } = db.momentsSettings;
        document.querySelector(`input[name="moments-enabled"][value="${String(enabled)}"]`).checked = true;
        getEl('moments-frequency').value = frequency;
        getEl('moments-bg-preview').style.backgroundImage = `url(${background})`;
        getEl('moments-my-avatar-preview').src = myAvatar;
    }

    function saveMomentsSettings() {
        const form = getEl('moments-settings-form');
        const formData = new FormData(form);
        db.momentsSettings.enabled = formData.get('moments-enabled') === 'true';
        db.momentsSettings.frequency = formData.get('frequency');
        saveData();
        showToast('朋友圈设置已保存');
        switchScreen('moments-screen');
    }
    
    function formatTimeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " 年前"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " 个月前"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " 天前"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " 小时前"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " 分钟前"; return "刚刚";
    }

       function setupMemoryCoreApp() {
        const screen = getEl('memory-core-screen');
        
        screen.addEventListener('click', e => {
            if (e.target.closest('#add-memory-btn')) {
                currentEditingMemoryId = null;
                getEl('edit-memory-form').reset();
                getEl('memory-id').value = '';
                getEl('edit-memory-screen-title').textContent = '创建全局记忆';
                getEl('memory-topic-group').style.display = 'block';
                switchScreen('edit-memory-screen');
            } else if (e.target.closest('#memory-settings-btn')) {
                loadMemorySettings();
                switchScreen('memory-core-settings-screen');
            } else {
                const item = e.target.closest('.list-item');
                if (item) {
                    const memory = db.memoryEntries.find(m => m.id === item.dataset.id);
                    if (memory) {
                        currentEditingMemoryId = memory.id;
                        getEl('memory-id').value = memory.id;
                        getEl('memory-content').value = memory.content;

                        if (memory.type === 'global') {
                            getEl('memory-topic').value = memory.topic;
                            getEl('memory-topic-group').style.display = 'block';
                            getEl('edit-memory-screen-title').textContent = '编辑全局记忆';
                        } else { // character memory
                            const char = db.characters.find(c => c.id === memory.characterId);
                            getEl('memory-topic-group').style.display = 'none';
                            getEl('edit-memory-screen-title').textContent = `编辑 ${char ? char.remarkName : '角色'} 的记忆`;
                        }
                        switchScreen('edit-memory-screen');
                    }
                }
            }
        });

        getEl('edit-memory-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const content = getEl('memory-content').value.trim();
            if (!content) return showToast('记忆内容不能为空');
            
            if (currentEditingMemoryId) {
                const memory = db.memoryEntries.find(m => m.id === currentEditingMemoryId);
                if (memory) {
                    memory.content = content;
                    if (memory.type === 'global') {
                        const topic = getEl('memory-topic').value.trim();
                        if (!topic) return showToast('全局记忆的主题不能为空');
                        memory.topic = topic;
                    }
                    showToast('记忆已更新');
                }
            } else {
                const topic = getEl('memory-topic').value.trim();
                if (!topic) return showToast('全局记忆的主题不能为空');
                db.memoryEntries.push({ id: `mem_${Date.now()}`, type: 'global', topic, content, timestamp: Date.now() });
                showToast('全局记忆已创建');
            }
            saveData();
            renderMemoryCoreList();
            switchScreen('memory-core-screen');
        });
        
        const memoryListContainer = getEl('memory-core-list-container');
        memoryListContainer.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const item = e.target.closest('.list-item');
            if (!item) return;
            const memoryId = item.dataset.id;
            const memory = db.memoryEntries.find(m => m.id === memoryId);
            if (!memory) return;
            
            const menuItems = [{
                label: '删除',
                danger: true,
                action: () => {
                    let confirmMessage = memory.type === 'global' 
                        ? `确定要删除全局记忆“${memory.topic}”吗？`
                        : `确定要删除这条角色记忆吗？`;
                    if (confirm(confirmMessage)) {
                        db.memoryEntries = db.memoryEntries.filter(m => m.id !== memoryId);
                        saveData();
                        renderMemoryCoreList();
                        showToast('记忆已删除');
                    }
                }
            }];
            createContextMenu(menuItems, e.clientX, e.clientY);
        });

        memoryListContainer.addEventListener('touchstart', (e) => {
             const item = e.target.closest('.list-item');
             if (!item) return;
             longPressTimer = setTimeout(() => {
                 const touch = e.touches[0];
                 const memoryId = item.dataset.id;
                 const memory = db.memoryEntries.find(m => m.id === memoryId);
                 if (!memory) return;
                 const menuItems = [{
                     label: '删除',
                     danger: true,
                     action: () => {
                         let confirmMessage = memory.type === 'global' 
                             ? `确定要删除全局记忆“${memory.topic}”吗？`
                             : `确定要删除这条角色记忆吗？`;
                         if (confirm(confirmMessage)) {
                             db.memoryEntries = db.memoryEntries.filter(m => m.id !== memoryId);
                             saveData();
                             renderMemoryCoreList();
                             showToast('记忆已删除');
                         }
                     }
                 }];
                 createContextMenu(menuItems, touch.clientX, touch.clientY);
             }, 500);
        });
        memoryListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
        memoryListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
    }
    
    function setupMemoryCoreSettingsApp() {
        getEl('memory-core-settings-screen').addEventListener('submit', (e) => {
            if(e.target.id === 'memory-settings-form') {
                e.preventDefault();
                db.memorySettings.injectionPrompt = getEl('memory-injection-prompt').value;
                db.memorySettings.extractionPrompt = getEl('memory-extraction-prompt').value;
                saveData();
                showToast('记忆核心提示词已保存。');
                switchScreen('memory-core-screen');
            }
        });
    }

    function loadMemorySettings() {
        getEl('memory-injection-prompt').value = db.memorySettings.injectionPrompt;
        getEl('memory-extraction-prompt').value = db.memorySettings.extractionPrompt;
    }

    function renderMemoryCoreList() {
        const container = getEl('memory-core-list-container');
        container.innerHTML = '';
        getEl('no-memories-placeholder').style.display = db.memoryEntries.length === 0 ? 'block' : 'none';
        db.memoryEntries.sort((a, b) => b.timestamp - a.timestamp).forEach(mem => {
            const li = document.createElement('li');
            li.className = 'list-item memory-item';
            li.dataset.id = mem.id;
            let topicDisplay, iconHTML = '';

            if (mem.type === 'character') {
                const char = db.characters.find(c => c.id === mem.characterId);
                topicDisplay = char ? char.remarkName : '未知角色';
                iconHTML = `<img src="${char ? char.avatar : 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg'}" class="chat-avatar" style="width: 50px; height: 50px;">`;
            } else {
                topicDisplay = mem.topic;
                iconHTML = `<div class="chat-avatar" style="background-color: #eee; display: flex; align-items: center; justify-content: center; font-size: 24px;">🌐</div>`;
            }
            
            li.innerHTML = `
                ${iconHTML}
                <div class="item-details">
                    <div class="item-name">${topicDisplay}</div>
                    <div class="item-preview">${mem.content.replace(/\n/g, ' ')}</div>
                </div>`;
            container.appendChild(li);
        });
    }

    function showTopNotification(character, messageContent) {
        const banner = getEl('top-notification-banner');
        if (banner.classList.contains('show')) return; 

        const lastMessageText = messageContent.match(/\[.*?的消息：([\s\S]+?)\]/)?.[1] || messageContent;

        getEl('top-notification-avatar').src = character.avatar;
        getEl('top-notification-text').querySelector('.title').textContent = character.remarkName;
        getEl('top-notification-text').querySelector('.message').textContent = lastMessageText;

        banner.onclick = () => {
            clearTimeout(notificationTimeout);
            banner.classList.remove('show');
            openChatRoom(character.id, 'private');
        };

        banner.classList.add('show');
        notificationTimeout = setTimeout(() => {
            banner.classList.remove('show');
        }, 4000);
    }

    async function proactiveChatScheduler() {
        for (const character of db.characters) {
            if (!character.proactiveChat || !character.proactiveChat.enabled || isGenerating) {
                continue;
            }

            const lastMessage = character.history.length > 0 ? character.history[character.history.length - 1] : null;

            if (lastMessage && lastMessage.role !== 'user') {
                continue;
            }

            const now = Date.now();
            const timeSinceLastMessage = lastMessage ? (now - lastMessage.timestamp) : Infinity;

            const frequencyMap = {
                high: { min: 0.8, max: 4 },
                medium: { min: 4, max: 10 },
                low: { min: 10, max: 24 }
            };

            const setting = frequencyMap[character.proactiveChat.frequency] || frequencyMap.medium;
            const randomDelay = (Math.random() * (setting.max - setting.min) + setting.min) * 3600000;

            if (timeSinceLastMessage > randomDelay && Math.random() < 0.6) { 
                const prompt = generateProactiveChatPrompt(character);
                const reply = await getAiReply(prompt);
                
                if (reply) {
                    const messages = reply.match(/\[.*?\]/g) || [];
                    if (messages.length === 0) continue;

                    let firstMessageContent = messages[0];
                    messages.forEach(msgContent => {
                        const message = {
                            id: `msg_${Date.now()}_${Math.random()}`,
                            role: 'assistant',
                            content: msgContent.trim(),
                            timestamp: Date.now()
                        };
                        character.history.push(message);
                    });
                    character.unreadCount = (character.unreadCount || 0) + 1;
                    saveData();

                    if (character.id === currentChatId && getEl('chat-room-screen').classList.contains('active')) {
                       renderMessages(false, true);
                    }
                    renderChatList();
                    if (!getEl('chat-room-screen').classList.contains('active') || character.id !== currentChatId) {
                         showTopNotification(character, firstMessageContent);
                    }
                }
            }
        }
    }
    
    function generateProactiveChatPrompt(character) {
        const assignedChar = db.characters.find(c => c.id === character.assignedCharId) || character;
        const assignedMe = db.meProfiles.find(p => p.id === character.assignedMeId) || db.meProfiles[0];
        const lastMessage = character.history.length > 0 ? character.history.filter(m => !m.isHidden)[character.history.filter(m => !m.isHidden).length - 1] : null;
        const currentTime = new Date();
        const hour = currentTime.getHours();
        
        let timeContext;
        if (hour >= 5 && hour < 10) timeContext = "现在是清晨。";
        else if (hour >= 10 && hour < 14) timeContext = "现在是中午时分。";
        else if (hour >= 14 && hour < 18) timeContext = "现在是下午。";
        else if (hour >= 18 && hour < 22) timeContext = "现在是晚上。";
        else timeContext = "现在是深夜。";

        
        let historyContext = "你们还没有聊过天，这是你第一次主动和对方打招呼。";
        if (lastMessage) {
            const lastMessageTime = new Date(lastMessage.timestamp);
            const timeDiffHours = (currentTime - lastMessageTime) / 3600000;
            let timeDiffText;
            if (timeDiffHours < 1) timeDiffText = "就在刚才";
            else if (timeDiffHours < 24) timeDiffText = `${Math.round(timeDiffHours)}小时前`;
            else timeDiffText = `${Math.round(timeDiffHours / 24)}天前`;

            const lastMessages = character.history.filter(m => !m.isHidden).slice(-5).map(m => {
                const sender = m.role === 'user' ? assignedMe.myName : assignedChar.realName;
                const contentMatch = m.content.match(/\[.*?的消息：([\s\S]+?)\]/);
                const text = contentMatch ? contentMatch[1] : m.content;
                return `${sender}: ${text}`;
            }).join('\n');
            historyContext = `你们上次对话是在${timeDiffText}。\n\n---最近的聊天记录：\n${lastMessages}\n---`;
        }

        return `你正在扮演角色“${assignedChar.realName}”，人设是：${assignedChar.persona}。
${timeContext}
${historyContext}

你的任务是：根据当前时间和你们的聊天历史，非常自然地开启一个新的话题或继续之前的话题，主动发消息给“${assignedMe.myName}”。
【重要】请参考当前时间和上次对话的时间差来决定你的开场白。例如，如果是第二天早上，可以说“早上好”；如果只是过了几个小时，可以接着之前的话题说。
【禁止】绝对不许使用“在吗？”、“你好”这类干巴巴的开场白。你的开场白必须有内容，有意义。
【输出限制】你的回复必须且只能包含一条简短的消息。模仿真实的人类聊天习惯，不要长篇大论。
【要求】你的回复必须严格遵循格式：[${assignedChar.realName}的消息：{你的聊天内容}]`;
    }
    
    async function interAiReactionScheduler() {
        if (db.moments.length === 0 || db.characters.length < 2) return;

        // Pick a random moment that is not from the user
        const aiMoments = db.moments.filter(m => m.characterId !== 'user_me');
        if (aiMoments.length === 0) return;
        const moment = aiMoments[Math.floor(Math.random() * aiMoments.length)];

        // Decide whether to react to the post itself or a comment
        const shouldReactToComment = moment.comments.length > 0 && Math.random() < 0.5;

        if (shouldReactToComment) {
            const comment = moment.comments[Math.floor(Math.random() * moment.comments.length)];
            // Let's trigger a reply to this comment
            await triggerAiReactions(moment.id, comment.id);
        } else {
            // Let's trigger a new like/comment on the post
            await triggerAiReactions(moment.id);
        }
    }


    init();
});
</script>
</body>
</html>
